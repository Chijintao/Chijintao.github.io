<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="池劲涛的博客">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="池劲涛的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="池劲涛">
<meta property="article:tag" content="Python Linux Vue">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>池劲涛的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">池劲涛的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="池劲涛"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">池劲涛</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">68</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/22/Django-rest-framework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/22/Django-rest-framework/" class="post-title-link" itemprop="url">drf(详细)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-22 09:20:25" itemprop="dateCreated datePublished" datetime="2019-06-22T09:20:25+08:00">2019-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-07-01 12:22:34" itemprop="dateModified" datetime="2019-07-01T12:22:34+08:00">2019-07-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Django%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Django系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="DRF-APIView请求生命周期流程图"><a href="#DRF-APIView请求生命周期流程图" class="headerlink" title="DRF APIView请求生命周期流程图"></a>DRF APIView请求生命周期流程图</h2><p><img src="https://img2018.cnblogs.com/blog/1736414/202002/1736414-20200218223701411-338089898.png" alt="img"></p>
<p><img src="https://img2018.cnblogs.com/blog/1736414/202002/1736414-20200223221801476-717815335.png" alt="img"></p>
<h2 id="drf入门规范"><a href="#drf入门规范" class="headerlink" title="drf入门规范"></a>drf入门规范</h2><h3 id="Web应用模式"><a href="#Web应用模式" class="headerlink" title="Web应用模式"></a>Web应用模式</h3><p><strong>前后端不分离</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模板渲染在后端完成</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gggfnzeg2xj31k80smjv1.jpg" alt="前后端不分离"></p>
<p><strong>前后端分离(主流)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 后端就只负责写接口，前端来调用，通信使用json格式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多端(web、app...)都可以使用同一个接口</span></span><br></pre></td></tr></table></figure>





<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gggfo3sdg9j31aw0u0jxr.jpg" alt="前后端分离"></p>
<h3 id="API接口"><a href="#API接口" class="headerlink" title="API接口"></a>API接口</h3><p><strong>通过网络，规定了前后台信息交互规则的url链接，也就是前后台信息交互的媒介</strong></p>
<p><strong>四大特点</strong></p>
<p>==url==</p>
<ul>
<li>长得像返回数据的url链接</li>
</ul>
<p>==请求方式==</p>
<ul>
<li>get、post、put、patch、delete</li>
</ul>
<p>==请求参数==</p>
<ul>
<li>json或xml(老项目)格式的key-value类型数据</li>
</ul>
<p>==相应结果==</p>
<ul>
<li>json或xml格式的数据</li>
</ul>
<h3 id="接口测试工具：Postman"><a href="#接口测试工具：Postman" class="headerlink" title="接口测试工具：Postman"></a>接口测试工具：Postman</h3><p><strong>官网下载</strong>：<a target="_blank" rel="noopener" href="https://www.getpostman.com/downloads/">https://www.getpostman.com/downloads/</a></p>
<h3 id="RESTful-API规范-3星"><a href="#RESTful-API规范-3星" class="headerlink" title="RESTful API规范(3星)"></a>RESTful API规范(3星)</h3><p><strong>写接口的规范，大部分接口都会按照这个规范去写(Web API接口的设计风格)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 使用https协议进行传输数据(保证数据安全)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 url中带关键字api</span></span><br><span class="line">	https://api.baidu.com</span><br><span class="line">    https://www.baidu.com/api</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 3 url中带版本信息</span></span><br><span class="line">	https://api.baidu.com/v1</span><br><span class="line">	https://api.baidu.com/v2</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 4 数据即资源，均使用名词(重要)</span></span><br><span class="line">	https://api.baidu.com/users</span><br><span class="line">    https://api.baidu.com/books</span><br><span class="line">    https://api.baidu.com/book</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 5 资源操作由请求方式决定(重要)</span></span><br><span class="line">	<span class="string">&#x27;查询操作&#x27;</span> : get</span><br><span class="line">    <span class="string">&#x27;新增操作&#x27;</span> : post</span><br><span class="line">    <span class="string">&#x27;修改操作&#x27;</span> : put</span><br><span class="line">    <span class="string">&#x27;删除操作&#x27;</span> : delete</span><br><span class="line">    </span><br><span class="line">    https://api.baidu.com/books - get请求：获取所有书</span><br><span class="line">    https://api.baidu.com/books/<span class="number">1</span> - get请求：获取主键为<span class="number">1</span>的书</span><br><span class="line">    https://api.baidu.com/books - post请求：新增一本书书</span><br><span class="line">    https://api.baidu.com/books/<span class="number">1</span> - put请求：整体修改主键为<span class="number">1</span>的书</span><br><span class="line">    https://api.baidu.com/books/<span class="number">1</span> - patch请求：局部修改主键为<span class="number">1</span>的书</span><br><span class="line">    https://api.baidu.com/books/<span class="number">1</span> - delete请求：删除主键为<span class="number">1</span>的书</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 6 请求url中带搜索筛选条件(重要)</span></span><br><span class="line">	https://api.example.com/v1/zoos?limit=<span class="number">10</span>：指定返回记录的数量</span><br><span class="line">	https://api.example.com/v1/zoos?offset=<span class="number">10</span>：指定返回记录的开始位置、</span><br><span class="line">    https://api.example.com/v1/zoos?animal_type_id=<span class="number">1</span>：指定筛选条件</span><br><span class="line">     </span><br><span class="line"><span class="comment"># 7 响应中要带状态码(自己定义，http响应状态码)</span></span><br><span class="line">	&#123;</span><br><span class="line">    status:<span class="number">200</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 8 响应返回错误信息</span></span><br><span class="line">	&#123;</span><br><span class="line">        status:<span class="number">200</span></span><br><span class="line">        msg: <span class="string">&quot;无权限操作&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 9 返回结果，遵循如下规范(大概率都没有遵循)</span></span><br><span class="line">	GET /collection：返回资源对象的列表（数组）</span><br><span class="line">    GET /collection/resource：返回单个资源对象</span><br><span class="line">    POST /collection：返回新生成的资源对象</span><br><span class="line">    PUT /collection/resource：返回完整的资源对象</span><br><span class="line">    PATCH /collection/resource：返回完整的资源对象</span><br><span class="line">    DELETE /collection/resource：返回一个空文档</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 10 返回数据中带有链接地址</span></span><br><span class="line">	&#123;</span><br><span class="line">  	<span class="string">&quot;status&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  	<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">  	<span class="string">&quot;results&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>:<span class="string">&quot;肯德基(罗餐厅)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;img&quot;</span>: <span class="string">&quot;https://image.baidu.com/kfc/001.png&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">		]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="drf介绍与安装"><a href="#drf介绍与安装" class="headerlink" title="drf介绍与安装"></a>drf介绍与安装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Django-Rest-Framework: 是django的一个app，可以借助它快速在django框架开发出符合restful规范的接口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Django-Rest-Framework提供了: 认证、权限、限流、过滤、分页、接口文档等功能支持</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 官方文档: https://www.django-rest-framework.org/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># python Django版本的支持情况</span></span><br><span class="line">	Python(<span class="number">3.5</span>、<span class="number">3.6</span>、<span class="number">3.7</span>、<span class="number">3.8</span>、<span class="number">3.9</span>)</span><br><span class="line">    Django(<span class="number">2.2</span>、<span class="number">3.0</span>、<span class="number">3.1</span>)		<span class="number">2.</span>x用的多，<span class="number">1.</span>x(老项目)</span><br></pre></td></tr></table></figure>



<h3 id="CBV源码分析-2星"><a href="#CBV源码分析-2星" class="headerlink" title="CBV源码分析(2星)"></a>CBV源码分析(2星)</h3><p><strong>1 views.Book.as_view()执行完，一定是一个函数的内存地址</strong></p>
<p><strong>2 as_view是View类的类方法，类来调用</strong></p>
<p><img src="https://i.loli.net/2021/07/13/Ib7snRkHaWqUyXl.png" alt="image-20210712230515567.png"></p>
<p><strong>3 as_view中的view是一个闭包函数</strong></p>
<p><img src="https://i.loli.net/2021/07/13/o6SsLTcX4gyf3kZ.png" alt="t6yClDvJ1mSqBz7.png"></p>
<p><strong>4 执行了View类的dispatch</strong></p>
<p><img src="https://i.loli.net/2021/07/13/IY8ja5QpveFOcEg.png" alt="YnVcwmbhOkAz1NC.png"></p>
<p><img src="https://i.loli.net/2021/07/13/RjJSxWDNdgBmcp8.png" alt="X4UrdcEtFkosxhm.png"></p>
<p><strong>拓展</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果在当前视图类中重写dispatch方法，则可以实现：在get、post等方法执行之前或执行之后去执行重写的代码，完成类似装饰器的效果</span></span><br><span class="line"></span><br><span class="line">例如</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 代码(get、post等方法执行之前执行)</span></span><br><span class="line">        response = <span class="built_in">super</span>().dispatch(request, *args, **kwargs)</span><br><span class="line">        <span class="comment"># 代码(get、post等方法执行之后执行)</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>



<h3 id="drf基本使用及流程分析-3星"><a href="#drf基本使用及流程分析-3星" class="headerlink" title="drf基本使用及流程分析(3星)"></a>drf基本使用及流程分析(3星)</h3><p><strong>继承APIView使用</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Student</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> Student_serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student_serializers_APIView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 查询所有学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        student_list = Student.objects.<span class="built_in">all</span>()</span><br><span class="line">        ser = Student_serializers(instance=student_list, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新增学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        ser = Student_serializers(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            ser.save()</span><br><span class="line">            <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>



<p><strong>APIView的执行流程</strong></p>
<p>==1 APIView继承了django的View==</p>
<p><img src="https://i.loli.net/2021/07/13/SEe18PrpIxoBRqV.png" alt="EuNedGk5KbrJHwx.png"></p>
<p>==2 APIView中重写了as_view==</p>
<p><img src="https://i.loli.net/2021/07/13/ljb5H4esAzFyCGP.png" alt="rXMFCHUbcgnSOVh.png"></p>
<p>==3 执行self.dispatch() —&gt; APIView的dispatch==</p>
<p><img src="https://i.loli.net/2021/07/13/dNkwtysqrG3YMVK.png" alt="ti937vJdkYojVL1.png"></p>
<p><img src="https://i.loli.net/2021/07/13/dIJu91GOgZYymq4.png" alt="WwzN8m5tXhKVcID.png"></p>
<p>==4 在视图类中使用的request对象是新的request对象，而老的则是request._request==</p>
<p><img src="https://i.loli.net/2021/07/13/agAH9oRb3P2rOMu.png" alt="dhVZj9XbIBoweHx.png"></p>
<p><img src="https://i.loli.net/2021/07/13/QeqjWh3VfH9w2B5.png" alt="dMvBYCriDjX93z4.png"></p>
<p>==5 新的request对象中有一个属性：data==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">1 data是post请求携带的数据 ---&gt; 字典</span></span><br><span class="line"><span class="string">2 无论是什么编码格式，只要是post提交的数据，都在request.data中</span></span><br><span class="line"><span class="string">3 以后再取值，都从request.data中取</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>==6 结论：继承了APIView后，request对象变成新的request，其他大部分和原来一样使用==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 以后如果使用了drf，继承APIView(drf提供了很多view，他们都是继承自APIView)</span><br><span class="line">	注意：</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    包装出了一个新的request，在视图函数中使用时，跟原先没有区别</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    取post提交的数据，不要再从request.POST中取了，要从request.data中取</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    取get提交的参数，尽量不从request。GET中取了，要从request.query_params中取</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">   </span><br><span class="line"><span class="number">2</span> Request类(drf的)需要掌握</span><br><span class="line">	</span><br><span class="line">    <span class="number">2.1</span> request.data			<span class="comment"># 方法包装成了数据属性</span></span><br><span class="line">    <span class="number">2.2</span> request.query_params	<span class="comment"># 就是request._request.GET</span></span><br><span class="line">    <span class="number">2.3</span> request.FILES			<span class="comment"># 上传的文件</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 大部分用起来和原来一样</span></span><br><span class="line">    </span><br><span class="line"><span class="number">3</span> APIView类</span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	包装了新的request</span></span><br><span class="line"><span class="string">	执行了认证、权限、频率...</span></span><br><span class="line"><span class="string">	处理了全局异常</span></span><br><span class="line"><span class="string">	包装了response对象</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>





<h2 id="drf配置"><a href="#drf配置" class="headerlink" title="drf配置"></a>drf配置</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置</span></span><br><span class="line">    <span class="comment"># 1 后期，drf的所有配置，都写在这个字典中</span></span><br><span class="line">    <span class="comment"># 2 drf有个默认配置文件(drf源码的 ---&gt; setting.py),如果项目的配置文件配置了，优先使用项目的，如果没有配置，使用内置的</span></span><br><span class="line">    <span class="comment"># 3 返回样式的配置，一般不配置</span></span><br><span class="line">    REST_FRAMEWORK=&#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="序列化组件"><a href="#序列化组件" class="headerlink" title="序列化组件"></a>序列化组件</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><strong>作用</strong></p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 序列化，序列化器(类)会把模型对象(Book对象，Queryset对象)转换成字典，经过response以后变成json字符串</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 反序列化，把客户端发送过来的数据，经过request以后变成字典(request.data)，序列化器(类)可以把字典转成模型</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> 反序列化，完成数据校验功能</span><br></pre></td></tr></table></figure>



<p><strong>本质</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本质就是写一个类，继承一个基类，可以完成序列化、反序列化和数据校验</span></span><br></pre></td></tr></table></figure>



<h3 id="序列化器之Serializer类的使用-跟表模型没有必然联系-5星"><a href="#序列化器之Serializer类的使用-跟表模型没有必然联系-5星" class="headerlink" title="序列化器之Serializer类的使用(跟表模型没有必然联系)(5星)"></a>序列化器之Serializer类的使用(跟表模型没有必然联系)(5星)</h3><p><strong>视图类</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Student</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> Student_serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student_serializers_APIView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 查询所有学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        student_list = Student.objects.<span class="built_in">all</span>()</span><br><span class="line">        ser = Student_serializers(instance=student_list, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新增学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        ser = Student_serializers(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            ser.save()</span><br><span class="line">            <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student_Detial_serializers_APIView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 查询单个学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        student = Student.objects.<span class="built_in">filter</span>(pk=pk).first()</span><br><span class="line">        ser = Student_serializers(instance=student)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 修改单个学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        student = Student.objects.<span class="built_in">filter</span>(pk=pk).first()</span><br><span class="line">        ser = Student_serializers(instance=student, data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            ser.save()</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除单个学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        Student.objects.<span class="built_in">filter</span>(pk=pk).delete()</span><br><span class="line">        <span class="keyword">return</span> Response()</span><br></pre></td></tr></table></figure>



<p><strong>序列化类</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student_serializers</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    name = serializers.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    age = serializers.IntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        student = Student.objects.create(**validated_data)</span><br><span class="line">        <span class="keyword">return</span> student</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        instance.name = validated_data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        instance.age = validated_data.get(<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line">        instance.save()</span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>



<p><strong>路由</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;student/&#x27;</span>, views.Student_serializers_APIView.as_view()),</span><br><span class="line">    path(<span class="string">&#x27;student/&lt;int:pk&gt;&#x27;</span>, views.Student_Detial_serializers_APIView.as_view())</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p><strong>模型</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(<span class="string">&#x27;姓名&#x27;</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    age = models.IntegerField(<span class="string">&#x27;年龄&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Serializers高级使用-5星"><a href="#Serializers高级使用-5星" class="headerlink" title="Serializers高级使用(5星)"></a>Serializers高级使用(5星)</h3><p><strong>1 source字段的作用</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># source：可以对应表模型的字段和方法(返回结果是什么，字段就是什么)</span></span><br><span class="line">	<span class="comment"># 一般用来做一对多，多对多的字段返回</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    注:</span></span><br><span class="line"><span class="string">    	source如果是字段，会显示字段，如果是方法，会执行方法，不用加括号</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>2 SerializerMethodFidld使用方法</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一般用来添加需要查询该表以外的其他表(或关联表)的字段、方法</span></span><br><span class="line"></span><br><span class="line">course_detail = serializers.SerializerMethodField()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_course_detail</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">	<span class="keyword">return</span> &#123;<span class="string">&#x27;name&#x27;</span>:obj.course.name,<span class="string">&#x27;teacher&#x27;</span>:obj.course.course_teacher&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3 数据校验</strong></p>
<p>==反序列化时需要进行数据校验==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;使用序列化器进行反序列化时，需要对数据进行验证后，才能获取验证成功的数据或者保存成模型类对象&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在获取反序列化的数据前，必须调用is_valid()方法进行验证，验证成功返回True，否者返回False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 验证失败，可以通过序列化器对象的error属性获取错误信息，返回字典，包含了字段和字段的错误.如果是非字段错误，可以通过修改REST-framework配置中的NON_FIELD_ERRORS_KEY来控制错误字典中的key值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 验证成功，可以通过序列化器对象validdated_data属性获取数据</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 字段自己的校验规则</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;图书数据序列化器&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField(label=<span class="string">&#x27;ID&#x27;</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">    btitle = serializers.CharField(label=<span class="string">&#x27;名称&#x27;</span>, max_length=<span class="number">20</span>)</span><br><span class="line">    bpub_date = serializers.DateField(label=<span class="string">&#x27;发布日期&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    bread = serializers.IntegerField(label=<span class="string">&#x27;阅读量&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    bcomment = serializers.IntegerField(label=<span class="string">&#x27;评论量&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    image = serializers.ImageField(label=<span class="string">&#x27;图片&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 3.1 通过构造序列化器对象，并将要反序列化的数据传递给data构造参数，进行验证(views.py)</span></span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">    ser = Publish_modelserializers(request.data)</span><br><span class="line">    <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">        ser.save()</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;msg:ser.errors.get(<span class="string">&#x27;name&#x27;</span>)&#125;)</span><br><span class="line">    </span><br><span class="line">ps: is_valid()方法还会在验证失败时抛出异常serializers.ValidationError，可以通过传递raise_exception=<span class="literal">True</span>参数开启，REST-framework接收到此异常，会向前端返回HTTP <span class="number">400</span> Bad Request</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 3.2 补充定义验证行为</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;注意&#x27;</span></span><br><span class="line">	验证顺序是：字段自己的限制 ---&gt; 自己的局部钩子 ---&gt;(全部字段以及局部验证完毕以后再验证全局钩子)</span><br><span class="line"></span><br><span class="line">	<span class="number">3.2</span><span class="number">.1</span> validate_字段名(局部钩子)</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">validate_name</span>(<span class="params">self,name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">&#x27;sb&#x27;</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;不能以sb开头&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> name</span><br><span class="line">    </span><br><span class="line">    <span class="number">3.2</span><span class="number">.2</span> validate(全局钩子)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        bread = attrs[<span class="string">&#x27;bread&#x27;</span>]</span><br><span class="line">        bcomment = attrs[<span class="string">&#x27;bcomment&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> bread &lt; bcomment:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&#x27;阅读量小于评论量&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line">    </span><br><span class="line">    <span class="number">3.2</span><span class="number">.3</span> validators(在字段中添加validators参数，补充验证行为)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">about_django</span>(<span class="params">value</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;django&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> value.lower():</span><br><span class="line">        <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&quot;图书不是关于Django的&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">BookInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    	<span class="string">&quot;&quot;&quot;图书数据序列化器&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">id</span> = serializers.IntegerField(label=<span class="string">&#x27;ID&#x27;</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">        btitle = serializers.CharField(label=<span class="string">&#x27;名称&#x27;</span>, max_length=<span class="number">20</span>, validators=[about_django])</span><br><span class="line">        bpub_date = serializers.DateField(label=<span class="string">&#x27;发布日期&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">        bread = serializers.IntegerField(label=<span class="string">&#x27;阅读量&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">        bcomment = serializers.IntegerField(label=<span class="string">&#x27;评论量&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">        image = serializers.ImageField(label=<span class="string">&#x27;图片&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>



<h3 id="模型类序列化器ModelSerializer-跟表模型有关联-5星"><a href="#模型类序列化器ModelSerializer-跟表模型有关联-5星" class="headerlink" title="模型类序列化器ModelSerializer(跟表模型有关联)(5星)"></a>模型类序列化器ModelSerializer(跟表模型有关联)(5星)</h3><p><strong>1 介绍</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drf为我们提供了一个ModelSerializer模型序列化器来帮助我们快速创建一个Serializer类</span><br></pre></td></tr></table></figure>



<p><strong>2 ModelSerializer与Serializer的区别</strong></p>
<ul>
<li>基于模型类自动生成一系列字段</li>
<li>基于模型类自动为Serializer生成validators，比如unique_together</li>
<li>包含默认的create()和update()的实现</li>
</ul>
<p><strong>3 使用</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Publish_modelserializers</span>(<span class="params">serializers.ModelSerializer</span>):</span>	<span class="comment"># 继承ModelSerializer</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Publish			<span class="comment"># 表模型</span></span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span>		<span class="comment"># 1 序列化的字段</span></span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;name&#x27;</span>]	<span class="comment"># 2 用来手动指定字段</span></span><br><span class="line">        exclude = [<span class="string">&#x27;id&#x27;</span>]		<span class="comment"># 3 排除的字段(1、2、3只能同时使用一个)</span></span><br><span class="line">        depth					<span class="comment"># 深度，一般不用</span></span><br></pre></td></tr></table></figure>



<p><strong>4 重写字段</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name = serializers.SerializerMethodField()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_name</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;出版社 : &quot;</span> + obj.name</span><br></pre></td></tr></table></figure>



<p><strong>5 扩写字段(表模型中没有的字段)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">	嵌套反序列化时正常只能传pk值，需要两个字段(一个展示(read_only)，一个添加数据(write_only))</span></span><br><span class="line"><span class="string">	否则反序列化嵌套数据时报错</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">name2 = serializers.SerializerMethodField()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_name2</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot; 出版社2:东京出版社&quot;</span></span><br></pre></td></tr></table></figure>



<p><strong>6 反序列化时，字段自己的校验规则，是映射表模型的</strong></p>
<p><strong>7 局部钩子与全局钩子(与Serializer一样)</strong></p>
<p><strong>8 write_only与read_only</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name=serializers.CharField(write_only=<span class="literal">True</span>)		<span class="comment"># 反序列化的时候使用，序列化时不用(只读)</span></span><br><span class="line"></span><br><span class="line">name=serializers.CharField(read_only=<span class="literal">True</span>)		<span class="comment"># 序列化的时候使用，反序列化时不用(只写)</span></span><br></pre></td></tr></table></figure>



<p><strong>9 extra_kwargs(添加额外参数选项)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    model = Publish</span><br><span class="line">    fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">    extra_kwargs = &#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>:&#123;</span><br><span class="line">            <span class="string">&#x27;required&#x27;</span>:<span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;min_length&#x27;</span>:<span class="number">3</span>,</span><br><span class="line">            <span class="string">&#x27;write_only&#x27;</span>:<span class="literal">True</span></span><br><span class="line">            <span class="string">&#x27;error_messages&#x27;</span>:&#123;</span><br><span class="line">                <span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;min_length&#x27;</span>:<span class="string">&#x27;最少三位&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        <span class="string">&#x27;addr&#x27;</span>:&#123;</span><br><span class="line">            <span class="string">&#x27;read_only&#x27;</span>:<span class="literal">True</span></span><br><span class="line">            <span class="string">&#x27;required&#x27;</span>:<span class="literal">True</span></span><br><span class="line">        &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="序列化器字段和字段参数-2星"><a href="#序列化器字段和字段参数-2星" class="headerlink" title="序列化器字段和字段参数(2星)"></a>序列化器字段和字段参数(2星)</h3><p><strong>常用字段类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">字段构造方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>BooleanField</strong></td>
<td align="left">BooleanField()</td>
</tr>
<tr>
<td align="left"><strong>NullBooleanField</strong></td>
<td align="left">NullBooleanField()</td>
</tr>
<tr>
<td align="left"><strong>CharField</strong></td>
<td align="left">CharField(max_length=None, min_length=None, allow_blank=False, trim_whitespace=True)</td>
</tr>
<tr>
<td align="left"><strong>EmailField</strong></td>
<td align="left">EmailField(max_length=None, min_length=None, allow_blank=False)</td>
</tr>
<tr>
<td align="left"><strong>RegexField</strong></td>
<td align="left">RegexField(regex, max_length=None, min_length=None, allow_blank=False)</td>
</tr>
<tr>
<td align="left"><strong>SlugField</strong></td>
<td align="left">SlugField(max<em>length=50, min_length=None, allow_blank=False) 正则字段，验证正则模式 [a-zA-Z0-9</em>-]+</td>
</tr>
<tr>
<td align="left"><strong>URLField</strong></td>
<td align="left">URLField(max_length=200, min_length=None, allow_blank=False)</td>
</tr>
<tr>
<td align="left"><strong>UUIDField</strong></td>
<td align="left">UUIDField(format=’hex_verbose’) format: 1) <code>&#39;hex_verbose&#39;</code> 如<code>&quot;5ce0e9a5-5ffa-654b-cee0-1238041fb31a&quot;</code> 2） <code>&#39;hex&#39;</code> 如 <code>&quot;5ce0e9a55ffa654bcee01238041fb31a&quot;</code> 3）<code>&#39;int&#39;</code> - 如: <code>&quot;123456789012312313134124512351145145114&quot;</code> 4）<code>&#39;urn&#39;</code> 如: <code>&quot;urn:uuid:5ce0e9a5-5ffa-654b-cee0-1238041fb31a&quot;</code></td>
</tr>
<tr>
<td align="left"><strong>IPAddressField</strong></td>
<td align="left">IPAddressField(protocol=’both’, unpack_ipv4=False, **options)</td>
</tr>
<tr>
<td align="left"><strong>IntegerField</strong></td>
<td align="left">IntegerField(max_value=None, min_value=None)</td>
</tr>
<tr>
<td align="left"><strong>FloatField</strong></td>
<td align="left">FloatField(max_value=None, min_value=None)</td>
</tr>
<tr>
<td align="left"><strong>DecimalField</strong></td>
<td align="left">DecimalField(max_digits, decimal_places, coerce_to_string=None, max_value=None, min_value=None) max_digits: 最多位数 decimal_palces: 小数点位置</td>
</tr>
<tr>
<td align="left"><strong>DateTimeField</strong></td>
<td align="left">DateTimeField(format=api_settings.DATETIME_FORMAT, input_formats=None)</td>
</tr>
<tr>
<td align="left"><strong>DateField</strong></td>
<td align="left">DateField(format=api_settings.DATE_FORMAT, input_formats=None)</td>
</tr>
<tr>
<td align="left"><strong>TimeField</strong></td>
<td align="left">TimeField(format=api_settings.TIME_FORMAT, input_formats=None)</td>
</tr>
<tr>
<td align="left"><strong>DurationField</strong></td>
<td align="left">DurationField()</td>
</tr>
<tr>
<td align="left"><strong>ChoiceField</strong></td>
<td align="left">ChoiceField(choices) choices与Django的用法相同</td>
</tr>
<tr>
<td align="left"><strong>MultipleChoiceField</strong></td>
<td align="left">MultipleChoiceField(choices)</td>
</tr>
<tr>
<td align="left"><strong>FileField</strong></td>
<td align="left">FileField(max_length=None, allow_empty_file=False, use_url=UPLOADED_FILES_USE_URL)</td>
</tr>
<tr>
<td align="left"><strong>ImageField</strong></td>
<td align="left">ImageField(max_length=None, allow_empty_file=False, use_url=UPLOADED_FILES_USE_URL)</td>
</tr>
<tr>
<td align="left"><strong>ListField</strong></td>
<td align="left">ListField(child=, min_length=None, max_length=None)</td>
</tr>
<tr>
<td align="left"><strong>DictField</strong></td>
<td align="left">DictField(child=)</td>
</tr>
</tbody></table>
<p><strong>选项参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><strong>max_length</strong></td>
<td>最大长度</td>
</tr>
<tr>
<td><strong>min_lenght</strong></td>
<td>最小长度</td>
</tr>
<tr>
<td><strong>allow_blank</strong></td>
<td>是否允许为空</td>
</tr>
<tr>
<td><strong>trim_whitespace</strong></td>
<td>是否截断空白字符</td>
</tr>
<tr>
<td><strong>max_value</strong></td>
<td>最小值</td>
</tr>
<tr>
<td><strong>min_value</strong></td>
<td>最大值</td>
</tr>
</tbody></table>
<p><strong>通用参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>read_only</strong></td>
<td>表明该字段仅用于序列化输出，默认False</td>
</tr>
<tr>
<td><strong>write_only</strong></td>
<td>表明该字段仅用于反序列化输入，默认False</td>
</tr>
<tr>
<td><strong>required</strong></td>
<td>表明该字段在反序列化时必须输入，默认True</td>
</tr>
<tr>
<td><strong>default</strong></td>
<td>反序列化时使用的默认值</td>
</tr>
<tr>
<td><strong>allow_null</strong></td>
<td>表明该字段是否允许传入None，默认False</td>
</tr>
<tr>
<td><strong>validators</strong></td>
<td>该字段使用的验证器</td>
</tr>
<tr>
<td><strong>error_messages</strong></td>
<td>包含错误编号与错误信息的字典</td>
</tr>
<tr>
<td><strong>label</strong></td>
<td>用于HTML展示API页面时，显示的字段名称</td>
</tr>
<tr>
<td><strong>help_text</strong></td>
<td>用于HTML展示API页面时，显示的字段帮助提示信息</td>
</tr>
</tbody></table>
<h3 id="局部钩子和全局钩子源码分析-2星"><a href="#局部钩子和全局钩子源码分析-2星" class="headerlink" title="局部钩子和全局钩子源码分析(2星)"></a>局部钩子和全局钩子源码分析(2星)</h3><p><strong>1 入口是ser.is_valid()，是BaseSerializer的方法</strong></p>
<p><img src="https://i.loli.net/2021/07/13/6AsePhQvJu24LN8.png" alt="7dILKc5ksVWO4NR.png"></p>
<p><strong>2 找到全局钩子</strong></p>
<p><img src="https://i.loli.net/2021/07/13/woCEI1bMDNhiSLA.png" alt="OdbuBatSUYpG73C.png"></p>
<p><strong>3 找到局部钩子</strong></p>
<p><img src="https://i.loli.net/2021/07/13/EhTM4U1DFjuiPJl.png" alt="OHmK9NrponcjDXq.png"></p>
<p><img src="https://i.loli.net/2021/07/13/IYUbC436jgFuxtQ.png" alt="ImHyxpcjvD14gXC.png"></p>
<h3 id="序列化组件部分源码分析-2星"><a href="#序列化组件部分源码分析-2星" class="headerlink" title="序列化组件部分源码分析(2星)"></a>序列化组件部分源码分析(2星)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前戏：对象的实例化过程：__new__在__init__之前执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 序列化类在实例化的时候，先调用的是BaseSerializer中的__new__方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 ListSerializer与自己Serializer有什么联系？</span></span><br><span class="line">	[ser1,ser2,ser3]	ser</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/07/13/m7FdZEayzqhvXjC.png" alt="jgpMR7V3YW6BIdn.png"></p>
<p><img src="https://i.loli.net/2021/07/13/B4JjeihOfHAXU6z.png" alt="HxlAO1sVUpLuiq6.png"></p>
<h2 id="请求与响应-3星"><a href="#请求与响应-3星" class="headerlink" title="请求与响应(3星)"></a>请求与响应(3星)</h2><h3 id="drf请求全局和局部配置"><a href="#drf请求全局和局部配置" class="headerlink" title="drf请求全局和局部配置"></a>drf请求全局和局部配置</h3><p><strong>请求默认支持三种编码格式</strong></p>
<ul>
<li>urlencoded</li>
<li>json</li>
<li>formdata</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认支持三种</span></span><br><span class="line"></span><br><span class="line">   <span class="string">&#x27;DEFAULT_PARSER_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.JSONParser&#x27;</span>,  	 <span class="comment"># 解析application/json格式</span></span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.FormParser&#x27;</span>, 	 <span class="comment"># 解析application/x-www-form-urlencoded</span></span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.MultiPartParser&#x27;</span> <span class="comment"># multipart/form-data</span></span><br><span class="line">    ]</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ViewSetMixin,ListAPIView,CreateAPIView</span>):</span></span><br><span class="line">    parser_classes = [JSONParser,]</span><br></pre></td></tr></table></figure>





<h3 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rest-framework基于Django的request封装了一个新的Request类的request对象</span></span><br><span class="line">	rest-framework传入视图的request对象不再是Django默认的HttpRequest对象，而是rest-framework提供的扩展的HttpRequest类的Request类的对象</span><br><span class="line"></span><br><span class="line"><span class="comment"># Request对象的数据是根据前端发送数据的格式进行解析之后的结果(无论前端发送哪种格式的数据，都可以用统一的方式读取数据)</span></span><br><span class="line">	rest-framework提供了Parser解析器，在接收到请求后会自动根据Content-<span class="type">Type</span>指明的请求数据类型(如JSON、表单类型数据等)将请求数据进行parse解析，解析为类字典(QueryDict)对象保存在Request对象中</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 常用属性</span></span><br><span class="line">	<span class="number">1</span> request.data:</span><br><span class="line">        包含了对POST、PUT、PATCH请求方式解析后的数据</span><br><span class="line">        利用了rest-framework的parsers解析器，不仅支持表单类型数据，也支持JSON类型数据</span><br><span class="line">        </span><br><span class="line">    <span class="number">2</span> request.query_params</span><br><span class="line">    	request.query_params与Django的request.GET相同，只是更换了更正确的名字</span><br><span class="line">    </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">重点：</span></span><br><span class="line"><span class="string">	1 继承APIView后，视图类中的request对象是新的request对象</span></span><br><span class="line"><span class="string">	2 request.data、request.query_params的使用</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># drf中的Response对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 继承关系：Response---&gt; SimSimpleTemplateResponse ---&gt; django的HttpResponse</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 属性、参数</span></span><br><span class="line">	</span><br><span class="line">    data=<span class="literal">None</span>				<span class="comment"># ser.data，传字典或列表，序列化成json格式字符串给前端</span></span><br><span class="line">    status=<span class="literal">None</span>				<span class="comment"># 状态码，http响应的状态码</span></span><br><span class="line">    template_name=<span class="literal">None</span>		<span class="comment"># 模板名字，在浏览器访问，看到的好看的模板(自定制)(用得少)</span></span><br><span class="line">    headers=<span class="literal">None</span>			<span class="comment"># 响应头，字典</span></span><br><span class="line">    exception=<span class="literal">False</span>			<span class="comment"># 异常(不用管)</span></span><br><span class="line">    content_type=<span class="literal">None</span>		<span class="comment"># 响应编码类型</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    重点：</span></span><br><span class="line"><span class="string">    	data</span></span><br><span class="line"><span class="string">    	status</span></span><br><span class="line"><span class="string">    	headers</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">	response=&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;查询成功&#x27;</span>, <span class="string">&#x27;request&#x27;</span>:ser.data&#125;</span><br><span class="line">    <span class="keyword">return</span> Response(response,status=status.HTTP_201_CREATED,headers=&#123;<span class="string">&#x27;xxx&#x27;</span>:<span class="string">&quot;xxx&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">	<span class="number">1</span> 通过配置，设置响应格式(浏览器模板样子、纯json)</span><br><span class="line">    <span class="comment"># 1 后期，drf的所有配置，都写在这个字典中</span></span><br><span class="line">    <span class="comment"># 2 drf有个默认配置文件(drf源码的 ---&gt; setting.py),如果项目的配置文件配置了，优先使用项目的，如果没有配置，使用内置的</span></span><br><span class="line">    <span class="comment"># 3 返回样式的配置，一般不配置</span></span><br><span class="line">    REST_FRAMEWORK=&#123;</span><br><span class="line">        <span class="comment">#配置响应格式，默认有俩（json，浏览器的）</span></span><br><span class="line">         <span class="string">&#x27;DEFAULT_RENDERER_CLASSES&#x27;</span>: [</span><br><span class="line">            <span class="string">&#x27;rest_framework.renderers.JSONRenderer&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;rest_framework.renderers.BrowsableAPIRenderer&#x27;</span>,</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="number">2</span> 局部配置(只针对某一个视图函数)</span><br><span class="line">    	在视图类上写</span><br><span class="line">        	renderer_classes = [JSONRenderer]</span><br><span class="line">    <span class="number">3</span> 配置的三个层次(优先级)</span><br><span class="line">    	局部 ---&gt; 项目 ---&gt; drf默认</span><br></pre></td></tr></table></figure>



<h2 id="视图组件-5星"><a href="#视图组件-5星" class="headerlink" title="视图组件(5星)"></a>视图组件(5星)</h2><p><img src="https://i.loli.net/2021/07/13/QeyDj2BmxElJbg8.png" alt="Uc5s1hblaJnoNqA.png"></p>
<h3 id="两个视图基类"><a href="#两个视图基类" class="headerlink" title="两个视图基类"></a>两个视图基类</h3><h4 id="APIView"><a href="#APIView" class="headerlink" title="APIView"></a><strong>APIView</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># APIView 是rest-framework提供的所有视图的基类，继承自Django的View父类</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在APIView中仍以常规的类视图定义方法来实现get()、post()...请求方式的方法</span></span><br></pre></td></tr></table></figure>



<p><strong>APIView与View的区别</strong></p>
<ul>
<li>传入到视图方法中的是rest-framework的Request类的request对象，而不是Django的HttpResponse对象</li>
<li>视图方法返回的是rest-framework的Response类的response对象，视图会因为响应数据设置(rander)符合前端要求的格式</li>
<li>任何APIException异常都会被捕获到，并处理成合适的响应信息</li>
<li>在进行dispatch()分发前，会对请求进行身份认证、权限检查、流量控制</li>
</ul>
<p><strong>支持定义的类属性</strong></p>
<ul>
<li>authentication_classes列表或元组（身份认证类）</li>
<li>permissoin_classes列表或元组（权限检查类）</li>
<li>throttle_classes列表或元组（流量/频率控制类）</li>
</ul>
<h4 id="GenericAPIView-通用视图类"><a href="#GenericAPIView-通用视图类" class="headerlink" title="GenericAPIView(通用视图类)"></a>GenericAPIView(通用视图类)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 继承自APIView，主要增加了操作序列化器和数据库查询的方法，作用是为Mixin扩展类的执行提供方法支持，通常在使用时，可搭配一个或多个Mixin扩展类</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">涉及到数据库操作，尽量选择GenericAPIView，减少代码量</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<p><strong>提供的关于序列化器使用的属性与方法</strong></p>
<ul>
<li>属性<ul>
<li>==serializer_class==                                            : 指明视图使用的序列化器</li>
</ul>
</li>
<li>方法<ul>
<li>==get_serializer_class(self)==                            : 当出现一个视图类中调用多个序列化器时，可以通过条件判断get_serializer_class方法中通过返回不同的序列器类名，就可以让视图方法执行不同的序列化器对象了</li>
<li>==get_serializer(self, *args, **kwargs)==        : 返回序列化器对象，主要用来提供给Mixin扩展类使用（该方法在提供序列化器对象的时候，会向序列化器对象的context属性补充三个数据：request、format、view，这三个数据对象可以在定义序列化器时使用）(可以传instance、data、many)<ul>
<li>request    ：当前视图的请求对象</li>
<li>view          ：当前请求的类视图对象</li>
<li>format      ：当前请求期望返回的数据格式</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>提供的关于数据库查询的属性与方法</strong></p>
<ul>
<li>属性<ul>
<li>==queryset==                        ：查询的表名.objects.all()    (这里不写all会自动添加上all，但推荐都写上)</li>
</ul>
</li>
<li>方法<ul>
<li>==get_queryset(self)==         ：获取查询需要用到的所有数据</li>
<li>==get_object(self)==              ：获取查询需要用到的单条数据    （若详情访问的模型类对象不存在，会返回404）</li>
</ul>
</li>
</ul>
<h3 id="五个视图扩展类"><a href="#五个视图扩展类" class="headerlink" title="五个视图扩展类"></a>五个视图扩展类</h3><p><strong>这五个扩展类需要搭配GenericAPIView父类，因为五个扩展类的实现需要调用GenericAPIView提供的序列化器与数据库查询的方法</strong></p>
<p><strong>CreateModelMixin</strong></p>
<ul>
<li>内部有create方法     ：新增</li>
</ul>
<p><strong>ListModelMixin</strong></p>
<ul>
<li>内部有list方法            ：查询所有</li>
</ul>
<p><strong>DestroyModelMixin</strong></p>
<ul>
<li>内部有destroy方法    ：删除单条</li>
</ul>
<p><strong>UpdateModelMixin</strong></p>
<ul>
<li>内部有update方法    ：修改一条</li>
</ul>
<p><strong>RetrieveModelMixin</strong></p>
<ul>
<li>内部有retrieve方法    ：查询单条</li>
</ul>
<h3 id="九个视图子类"><a href="#九个视图子类" class="headerlink" title="九个视图子类"></a>九个视图子类</h3><p><strong>ListAPIView</strong>            </p>
<ul>
<li>list</li>
</ul>
<p><strong>CreateAPIView</strong></p>
<ul>
<li>create</li>
</ul>
<p><strong>UpdateAPIView</strong></p>
<ul>
<li>update</li>
</ul>
<p><strong>DestroyAPIView</strong></p>
<ul>
<li>destroy</li>
</ul>
<p><strong>RetrieveAPIView</strong></p>
<ul>
<li>retrieve</li>
</ul>
<p><strong>ListCreateAPIView</strong></p>
<ul>
<li>list+create</li>
</ul>
<p><strong>RetrieveUpdateDestroyAPIView</strong></p>
<ul>
<li>retrieve+update+destroy</li>
</ul>
<p><strong>RetrieveDestroyAPIView</strong></p>
<ul>
<li>retrieve+destroy</li>
</ul>
<p><strong>RetrieveUpdateAPIView</strong></p>
<ul>
<li>retrieve+update</li>
</ul>
<h3 id="视图集"><a href="#视图集" class="headerlink" title="视图集"></a>视图集</h3><p><strong>ViewSetMixin</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 核心：重写了as_view方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 能够实现：请求方式和视图类中方法的映射</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结论：只要继承ViewSetMixin的视图类，路由中as_view()里就要传action参数(字典)</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">	path(<span class="string">&#x27;books/&#x27;</span>, views.BookView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;))</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/07/13/b4dw7anUz5fkYvg.png" alt="Pt2UsRL61ycJu8W.png"></p>
<p><strong>ViewSet</strong></p>
<ul>
<li>继承自APIView与ViewSetMixin，作用与APIView类似，提供了身份认证、权限校验、流量管理…</li>
<li>主要通过继承ViewSetMixin来实现在调用as_view()时传入字典的映射处理</li>
<li>没有提供任何动作action方法，需要我们自己实现action方法</li>
<li>需要自己编写list、retrieve、create、update、destroy等方法</li>
</ul>
<p><strong>GeneriViewSet</strong></p>
<ul>
<li>继承自GenericAPIView与ViewSetMixin</li>
<li>实现了调用as_view()时传入字典的映射处理</li>
<li>提供了GenericAPIView提供的基础方法，可以直接搭配Mixin扩展类使用</li>
</ul>
<p><strong>ModelViewSet</strong></p>
<ul>
<li>继承自GenericViewSet，包括了五个视图扩展类</li>
</ul>
<p><strong>ReadOnlyModelViewSet</strong></p>
<ul>
<li>继承自GenericViewSet，包括了ListModelMixin、RetrieveModelMixin</li>
</ul>
<h2 id="路由组件-5星"><a href="#路由组件-5星" class="headerlink" title="路由组件(5星)"></a>路由组件(5星)</h2><h3 id="Routers"><a href="#Routers" class="headerlink" title="Routers"></a>Routers</h3><p><strong>对于视图集ViewSet，我们除了可以自己手动指明请求方式与动作action之间的对应关系外，还可以使用Routers来快速实现路由创建</strong></p>
<ul>
<li><p>SimpleRouter(常用)</p>
</li>
<li><p>DefaultRouter(多了一些花里胡哨的路由，用得少)</p>
</li>
</ul>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> SimpleRouter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = SimpleRouter()</span><br><span class="line">router.register(<span class="string">&#x27;book&#x27;</span>, views.Book_modelviewset)</span><br><span class="line">router.register(<span class="string">&#x27;publish&#x27;</span>, views.Publish_modelviewset)</span><br><span class="line">router.register(<span class="string">&#x27;&#x27;</span>, views.Login, basename=<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls))		<span class="comment"># 方式一</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns += router.urls				<span class="comment"># 方式二(选一种使用)</span></span><br></pre></td></tr></table></figure>



<h3 id="试图类中派生的方法，自动生成路由-action"><a href="#试图类中派生的方法，自动生成路由-action" class="headerlink" title="试图类中派生的方法，自动生成路由(action)"></a>试图类中派生的方法，自动生成路由(action)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span>(<span class="params">ViewSetMixin, APIView</span>):</span></span><br><span class="line">    authentication_classes = []</span><br><span class="line">    permission_classes = []</span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>], detail=<span class="literal">False</span></span>)		</span><span class="comment"># 自己扩展的方法(派生)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self, request, *args, **kwargs</span>):</span>	</span><br><span class="line">        username = request.data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        user_alive = models.User.objects.<span class="built_in">filter</span>(username=username, password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user_alive:</span><br><span class="line">            token = uuid.uuid4()</span><br><span class="line">            models.User_token.objects.update_or_create(defaults=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;, user=user_alive)</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>, <span class="string">&#x27;token&#x27;</span>:token&#125;, headers=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">101</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录失败&#x27;</span>&#125;)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 这样自动生成的路由是(books/login/) (如果prefix参数传空字符串，则是/login/)</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">参数解释：</span></span><br><span class="line"><span class="string">	method：		用来指定请求方式，默认GET</span></span><br><span class="line"><span class="string">	detail：		用来指定是否传入pk值(如：查所有或查单条)，False：不传pk，True：传pk</span></span><br><span class="line"><span class="string">	url_path：	用来指定url的路径，默认方法名</span></span><br><span class="line"><span class="string">	url_name：	用来指定url的别名</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">	1 如果继承了APIView，那么想要自动创建路由，则必须写action动作并在urls.py中传basename参数来指定视图</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	2 必须继承ViewSetMixin</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="认证组件-5星"><a href="#认证组件-5星" class="headerlink" title="认证组件(5星)"></a>认证组件(5星)</h2><p><strong>判断用户是否登录</strong></p>
<h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># auth.py(自己建的任意名称的py文件)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> AuthenticationFailed</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login_authentication</span>(<span class="params">BaseAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        token = request.META.get(<span class="string">&#x27;HTTP_TOKEN&#x27;</span>)</span><br><span class="line">        user_token = models.User_token.objects.<span class="built_in">filter</span>(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> user_token:</span><br><span class="line">            <span class="keyword">return</span> user_token.user, token</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;请先登录&#x27;</span>)</span><br><span class="line">            </span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span>(<span class="params">ViewSetMixin, APIView</span>):</span></span><br><span class="line">    authentication_classes = [Login_authentication]		<span class="comment"># 局部使用</span></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>], detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        username = request.data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        user_alive = models.User.objects.<span class="built_in">filter</span>(username=username, password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user_alive:</span><br><span class="line">            token = uuid.uuid4()</span><br><span class="line">            models.User_token.objects.update_or_create(defaults=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;, user=user_alive)</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>, <span class="string">&#x27;token&#x27;</span>:token&#125;, headers=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">101</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录失败&#x27;</span>&#125;)</span><br><span class="line">        </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">全局配置：</span></span><br><span class="line"><span class="string">	REST_FRAMEWORK = &#123;</span></span><br><span class="line"><span class="string">    &#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;:[</span></span><br><span class="line"><span class="string">        &#x27;app01.auth.Login_authentication&#x27;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">局部禁用：</span></span><br><span class="line"><span class="string">	authentication_classes = []</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p><img src="https://i.loli.net/2021/07/13/gqlwv4FA9zBQGXT.png" alt="YcjEfW3CunFB9K4.png"></p>
<p><img src="https://i.loli.net/2021/07/13/vweS9dPYl3K2xjG.png" alt="image-20210705201337157.png"></p>
<p><img src="https://i.loli.net/2021/07/13/eJ4IxpXt9kKEDBl.png" alt="image-20210705201527608.png"></p>
<p><img src="https://i.loli.net/2021/07/13/HcPUrQDSewfILgj.png" alt="image-20210705201731741.png"></p>
<p><img src="https://i.loli.net/2021/07/13/CUnOqhfimyIgFba.png" alt="image-20210705205949346.png"></p>
<p><img src="https://i.loli.net/2021/07/13/OhcDHgkxtCB9Nna.png" alt="image-20210705210247174.png"></p>
<p><img src="https://i.loli.net/2021/07/13/w6uOeFcSjZGRCVk.png" alt="image-20210705210417976.png"></p>
<p><img src="https://i.loli.net/2021/07/13/17opTiSPhMu8Vsg.png" alt="image-20210705210543266.png"></p>
<p><img src="https://i.loli.net/2021/07/13/NAPy8owlSkOWgUJ.png" alt="image-20210705210958562.png"></p>
<h2 id="权限组件-4星"><a href="#权限组件-4星" class="headerlink" title="权限组件(4星)"></a>权限组件(4星)</h2><h3 id="简单使用-1"><a href="#简单使用-1" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自己建的任意名字的py文件(auth.py)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> PermissionDenied</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User_permission</span>(<span class="params">BasePermission</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">if</span> models.User.user_type == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> PermissionDenied(request.user.get_user_type_display()+<span class="string">&#x27;权限不够&#x27;</span>)</span><br><span class="line">            </span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span>(<span class="params">ViewSetMixin, APIView</span>):</span></span><br><span class="line">    permission_classes = [User_permission]		<span class="comment"># 局部使用</span></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>], detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        username = request.data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        user_alive = models.User.objects.<span class="built_in">filter</span>(username=username, password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user_alive:</span><br><span class="line">            token = uuid.uuid4()</span><br><span class="line">            models.User_token.objects.update_or_create(defaults=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;, user=user_alive)</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>, <span class="string">&#x27;token&#x27;</span>:token&#125;, headers=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">101</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录失败&#x27;</span>&#125;)</span><br><span class="line">        </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">全局配置：</span></span><br><span class="line"><span class="string">	REST_FRAMEWORK = &#123;</span></span><br><span class="line"><span class="string">    &#x27;DEFAULT_PERMISSION_CLASSES&#x27;:[</span></span><br><span class="line"><span class="string">        &#x27;app01.auth.User_permission&#x27;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">局部禁用：</span></span><br><span class="line"><span class="string">	permission_classes = []	</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h3><p><img src="https://i.loli.net/2021/07/13/5meHTn9RJ74dFvA.png" alt="image-20210706172319765.png"></p>
<p><img src="https://i.loli.net/2021/07/13/oVFkBWeUsM1Qj5G.png" alt="image-20210706173120291.png"></p>
<h2 id="频率组件-5星"><a href="#频率组件-5星" class="headerlink" title="频率组件(5星)"></a>频率组件(5星)</h2><h3 id="自定义频率类"><a href="#自定义频率类" class="headerlink" title="自定义频率类"></a>自定义频率类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义的逻辑</span></span><br><span class="line"><span class="comment">#（1）取出访问者ip</span></span><br><span class="line"><span class="comment">#（2）判断当前ip不在访问字典里，添加进去，并且直接返回True,表示第一次访问，在字典里，继续往下走</span></span><br><span class="line"><span class="comment">#（3）循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据pop掉，这样列表中只有60s以内的访问时间，</span></span><br><span class="line"><span class="comment">#（4）判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返回True，顺利通过</span></span><br><span class="line"><span class="comment">#（5）当大于等于3，说明一分钟内访问超过三次，返回False验证失败</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThrottles</span>():</span></span><br><span class="line">    VISIT_RECORD = &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.history=<span class="literal">None</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self,request, view</span>):</span></span><br><span class="line">        <span class="comment">#（1）取出访问者ip</span></span><br><span class="line">        <span class="comment"># print(request.META)</span></span><br><span class="line">        ip=request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        ctime=time.time()</span><br><span class="line">        <span class="comment"># （2）判断当前ip不在访问字典里，添加进去，并且直接返回True,表示第一次访问</span></span><br><span class="line">        <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> self.VISIT_RECORD:</span><br><span class="line">            self.VISIT_RECORD[ip]=[ctime,]</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        self.history=self.VISIT_RECORD.get(ip)</span><br><span class="line">        <span class="comment"># （3）循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据pop掉，这样列表中只有60s以内的访问时间，</span></span><br><span class="line">        <span class="keyword">while</span> self.history <span class="keyword">and</span> ctime-self.history[-<span class="number">1</span>]&gt;<span class="number">60</span>:</span><br><span class="line">            self.history.pop()</span><br><span class="line">        <span class="comment"># （4）判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返回True，顺利通过</span></span><br><span class="line">        <span class="comment"># （5）当大于等于3，说明一分钟内访问超过三次，返回False验证失败</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.history)&lt;<span class="number">3</span>:</span><br><span class="line">            self.history.insert(<span class="number">0</span>,ctime)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        ctime=time.time()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">60</span>-(ctime-self.history[-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>





<h3 id="简单使用-2"><a href="#简单使用-2" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># until.py(任意名称py文件)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User_throttle</span>(<span class="params">SimpleRateThrottle</span>):</span></span><br><span class="line">    scope = <span class="string">&#x27;user&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">return</span> request.user.username		<span class="comment"># 返回谁，就以谁做限制</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line">throttle_classes = [User_base_throttle,]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>:<span class="string">&#x27;5/m&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 局部禁用</span></span><br><span class="line">throttle_classes = []</span><br></pre></td></tr></table></figure>



<h3 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h3><p><img src="https://i.loli.net/2021/07/13/5meHTn9RJ74dFvA.png" alt="image-20210706172319765.png"></p>
<p><img src="https://i.loli.net/2021/07/13/Kidfat1knMlF9cm.png" alt="image-20210706185151028.png"></p>
<p><img src="https://i.loli.net/2021/07/13/RJe7km51WZrF3DT.png" alt="image-20210706185449845.png"></p>
<p><img src="https://i.loli.net/2021/07/13/kBc9h3lorAyULSe.png" alt="image-20210706185753175.png"></p>
<p><img src="https://i.loli.net/2021/07/13/IiENjoSODkslCHL.png" alt="image-20210706190151150.png"></p>
<p><img src="https://i.loli.net/2021/07/13/WL9pSrasuU7iOJF.png" alt="image-20210706190316846.png"></p>
<h2 id="过滤与排序-4星"><a href="#过滤与排序-4星" class="headerlink" title="过滤与排序(4星)"></a>过滤与排序(4星)</h2><h3 id="简单使用-3"><a href="#简单使用-3" class="headerlink" title="简单使用"></a>简单使用</h3><p><strong>==查询所有==才需要过滤（根据条件过滤），排序（按某个规则排序）</strong></p>
<p><strong>内置类使用</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 内置过滤类(在视图类中配置)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.filters <span class="keyword">import</span> SearchFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ViewSetMixin,ListAPIView</span>):</span></span><br><span class="line">    <span class="comment"># 在视图类中配置，最顶层的类至少是GenericAPIView</span></span><br><span class="line">    filter_backends = [SearchFilter,]</span><br><span class="line">    <span class="comment"># 过滤条件，按名字过滤</span></span><br><span class="line">    search_fields=[<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;publish&#x27;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 查询使用</span></span><br><span class="line">	http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/books/?search=达   <span class="comment"># 出版社中或名字中有 达 就能查询出来</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 内置排序类(既有排序，又有过滤)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.filters <span class="keyword">import</span> OrderingFilter,SearchFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ViewSetMixin,ListAPIView</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在视图类中配置，最顶层的类至少是GenericAPIView</span></span><br><span class="line">    filter_backends = [SearchFilter,OrderingFilter,]</span><br><span class="line">    <span class="comment"># 过滤条件，按名字过滤</span></span><br><span class="line">    search_fields=[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    <span class="comment"># 按哪个字段排序</span></span><br><span class="line">    ordering_fields=[<span class="string">&#x27;price&#x27;</span>,<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询使用</span></span><br><span class="line">	http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/books/?ordering=price,-<span class="built_in">id</span></span><br></pre></td></tr></table></figure>



<p><strong>第三方插件使用（django-filter）</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 视图类中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ViewSetMixin,ListAPIView</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在视图类中配置，最顶层的类至少是GenericAPIView</span></span><br><span class="line">    filter_backends = [DjangoFilterBackend,]</span><br><span class="line">    <span class="comment"># 按名字、价格过滤</span></span><br><span class="line">    filter_fields=[<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;price&#x27;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 查询时</span></span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/books/?name=红楼梦</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/books/?name=四方达&amp;price=<span class="number">15</span></span><br></pre></td></tr></table></figure>



<h2 id="异常处理-4星"><a href="#异常处理-4星" class="headerlink" title="异常处理(4星)"></a>异常处理(4星)</h2><h3 id="简单使用-4"><a href="#简单使用-4" class="headerlink" title="简单使用"></a>简单使用</h3><p><strong>全局统一捕获异常，返回固定的格式</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用步骤</span></span><br><span class="line">	<span class="number">1</span> 写一个函数</span><br><span class="line">    <span class="number">2</span> 在配置文件中配置</span><br><span class="line">    </span><br><span class="line"><span class="number">1</span> 写函数：</span><br><span class="line"></span><br><span class="line">	<span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> exception_handler</span><br><span class="line">	<span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">comment_exception_handler</span>(<span class="params">exc, context</span>):</span></span><br><span class="line">    response = exception_handler(exc, context)</span><br><span class="line">    <span class="keyword">if</span> response:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>:<span class="number">1001</span>,</span><br><span class="line">            <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;错误&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;detail&#x27;</span>:response.data</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Response(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>:<span class="number">1002</span>,</span><br><span class="line">            <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;未知错误&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Response(data)</span><br><span class="line">    </span><br><span class="line"><span class="number">2</span> 在配置文件中配置</span><br><span class="line"></span><br><span class="line">    REST_FRAMEWORK = &#123;</span><br><span class="line">        <span class="string">&#x27;EXCEPTION_HANDLER&#x27;</span>:<span class="string">&#x27;utils.comment_exception_handler&#x27;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="分页功能-5星"><a href="#分页功能-5星" class="headerlink" title="分页功能(5星)"></a>分页功能(5星)</h2><p><strong>查询所有，才有分页功能（例如网站的下一页功能，app的下滑加载更多）</strong></p>
<h3 id="PageNumberPagination基本分页"><a href="#PageNumberPagination基本分页" class="headerlink" title="PageNumberPagination基本分页"></a>PageNumberPagination基本分页</h3><ul>
<li>重要类属性<ul>
<li>page_size = api_settings.PAGE_SIZE        （每页显示条数）</li>
<li>page_query_param = ‘page’                      （查询时用的参数）</li>
<li>page_size_query_param  = None             （更改返回条数）</li>
<li>max_page_size = None                               （每页最大显示条数）</li>
</ul>
</li>
<li>使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 写一个类，继承PageNumberPagination，重写4个类属性</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonPageNumberPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">    page_size = <span class="number">2</span></span><br><span class="line">    page_query_param = <span class="string">&#x27;page&#x27;</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;search&#x27;</span></span><br><span class="line">    max_page_size = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 2 在视图类中配置写好的分页类</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAPIView</span>(<span class="params">ViewSetMixin, ListAPIView</span>):</span></span><br><span class="line">    queryset = models.Books.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookModelSerializer</span><br><span class="line">    pagination_class = CommonPageNumberPagination</span><br></pre></td></tr></table></figure>



<h3 id="LimitOffsetPagination偏移分页"><a href="#LimitOffsetPagination偏移分页" class="headerlink" title="LimitOffsetPagination偏移分页"></a>LimitOffsetPagination偏移分页</h3><ul>
<li>重要的类属性<ul>
<li>default_limit = api_settings.PAGE_SIZE                （每页显示条数）</li>
<li>limit_query_param = ‘limit’                                    （查询时用的参数）</li>
<li>offset_query_param = ‘offset’                               （offset偏移的查询参数）</li>
<li>max_limit = None                                                    （每页最大显示条数）</li>
</ul>
</li>
<li>使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 写一个类，继承LimitOffsetPagination，重写4个类属性</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonLimitOffsetPagination</span>(<span class="params">LimitOffsetPagination</span>):</span></span><br><span class="line">    default_limit = <span class="number">3</span></span><br><span class="line">    limit_query_param = <span class="string">&#x27;limit&#x27;</span></span><br><span class="line">    offset_query_param = <span class="string">&#x27;offset&#x27;</span></span><br><span class="line">    max_limit = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 2 在视图类中配置写好的分页类</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAPIView</span>(<span class="params">ViewSetMixin, ListAPIView</span>):</span></span><br><span class="line">    queryset = models.Books.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookModelSerializer</span><br><span class="line">    pagination_class = CommonLimitOffsetPagination</span><br></pre></td></tr></table></figure>



<h3 id="CursorPagination游标分页"><a href="#CursorPagination游标分页" class="headerlink" title="CursorPagination游标分页"></a>CursorPagination游标分页</h3><ul>
<li>重要的类属性<ul>
<li>cursor_query_param = ‘cursor’                          （查询条件）</li>
<li>page_size = api_settings.PAGE_SIZE                  （每页显示条数）</li>
<li>ordering = ‘-created’                                             （排序）</li>
<li>page_size_query_param = None                         （更改每页显示条数）</li>
<li>max_page_size = None                                         （每页最大显示条数）</li>
</ul>
</li>
<li>使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 写一个类，继承LimitOffsetPagination，重写4个类属性</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonCursorPagination</span>(<span class="params">CursorPagination</span>):</span></span><br><span class="line">    cursor_query_param = <span class="string">&#x27;cursor&#x27;</span></span><br><span class="line">    page_size = <span class="number">2</span></span><br><span class="line">    ordering = <span class="string">&#x27;-id&#x27;</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;offset&#x27;</span></span><br><span class="line">    max_page_size = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 2 在视图类中配置写好的分页类</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAPIView</span>(<span class="params">ViewSetMixin, ListAPIView</span>):</span></span><br><span class="line">    queryset = models.Books.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookModelSerializer</span><br><span class="line">    pagination_class = CommonCursorPagination</span><br></pre></td></tr></table></figure>



<ul>
<li>优缺点</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优点：速度最快，数据量越大，越有优势(没有那么大的数据量，用的不多)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 缺点：只能前一页和后一页，不能直接跳到某一页</span></span><br></pre></td></tr></table></figure>



<h3 id="继承APIView实现三种分页方式"><a href="#继承APIView实现三种分页方式" class="headerlink" title="继承APIView实现三种分页方式"></a>继承APIView实现三种分页方式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAPIView2</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        book_list = models.Books.objects.<span class="built_in">all</span>()</span><br><span class="line">        pagination = CommonPageNumberPagination()</span><br><span class="line">        book_list2 = pagination.paginate_queryset(book_list, request, self)</span><br><span class="line">        ser = BookModelSerializer(instance=book_list2, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> pagination.get_paginated_response(ser.data)</span><br></pre></td></tr></table></figure>



<h2 id="自动生成接口文档-3星"><a href="#自动生成接口文档-3星" class="headerlink" title="自动生成接口文档(3星)"></a>自动生成接口文档(3星)</h2><ul>
<li>coreapi</li>
<li>swagger</li>
</ul>
<h3 id="使用coreapi自动生成"><a href="#使用coreapi自动生成" class="headerlink" title="使用coreapi自动生成"></a>使用coreapi自动生成</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一步：安装coreapi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二步：路由中配置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.documentation <span class="keyword">import</span> include_docs_urls</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;docs/&#x27;</span>, include_docs_urls(title=<span class="string">&#x27;查询所有&#x27;</span>)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三步：配置文件中配置</span></span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment">## 接口文档配置</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_SCHEMA_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.schemas.coreapi.AutoSchema&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ps：<span class="string">&#x27;DEFAULT_SCHEMA_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.schemas.openapi.AutoSchema&#x27;</span>,</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 第四步：写接口，加注释</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第五步：访问</span></span><br><span class="line"></span><br><span class="line">ps：extra_kwargs = &#123;</span><br><span class="line">    <span class="string">&#x27;字段&#x27;</span>:&#123;<span class="string">&#x27;help_text&#x27;</span>:<span class="string">&#x27;xxxx&#x27;</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="RBAC-4星"><a href="#RBAC-4星" class="headerlink" title="RBAC(4星)"></a>RBAC(4星)</h2><p><img src="https://i.loli.net/2021/07/13/T3UGjvpaOLZyswX.png" alt="image-20210708172129848.png"></p>
<p><img src="https://img2018.cnblogs.com/blog/1736414/202002/1736414-20200223222136020-817505790.png" alt="img"></p>
<p><strong>RBAC：Role-Based Access Control    (基于角色的访问控制)</strong></p>
<p><strong>原理</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 权限与角色(组)相关联，用户通过称为适当角色(组)的成员而得到这些角色(组)的权限</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 极大的简化了权限的管理(相互依赖)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Django的Auth组件(app)采用的认证规则就是RBAC</span></span><br><span class="line"></span><br><span class="line">	<span class="number">1</span> User表		    		 :存用户信息</span><br><span class="line">    <span class="number">2</span> Permission表			 :存权限</span><br><span class="line">    <span class="number">3</span> Role表					 :存角色(组)</span><br><span class="line"></span><br><span class="line">    <span class="number">4</span> Group_Role中间表			:权限赋予角色(多对多)</span><br><span class="line">	<span class="number">5</span> User_Group中间表			:角色赋予用户(多对多)</span><br><span class="line">    <span class="number">6</span> User_Permission中间表	:权限临时赋予角色(多对多)</span><br><span class="line">        </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ps:</span></span><br><span class="line"><span class="string">	1 Django后台管理admin自带RBAC</span></span><br><span class="line"><span class="string">	2 基于admin做二次开发(simple-ui)</span></span><br><span class="line"><span class="string">	3 基于前后端分离实现RBAC(https://github.com/liqianglog/django-vue-admin)</span></span><br><span class="line"><span class="string">	4 前后端混合的后台前端模板(X-admin---&gt;快速开发后台管理系统)</span></span><br><span class="line"><span class="string">	5 智慧大屏(https://gitee.com/kevin_chou/dataVIS.git)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h2 id="JWT-5星"><a href="#JWT-5星" class="headerlink" title="JWT(5星)"></a>JWT(5星)</h2><h3 id="介绍-5星"><a href="#介绍-5星" class="headerlink" title="介绍(5星)"></a>介绍(5星)</h3><p><strong>Json Web Token（JWT）：一种前后端的认证方式</strong></p>
<p><strong>构成和工作原理</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 三段式：header，payload，signature</span></span><br><span class="line"></span><br><span class="line">header(头)：认证方式，加密方式，公司名字...</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="string">&#x27;typ&#x27;</span>:<span class="string">&#x27;JWT&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;alg&#x27;</span>:<span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">payload(荷载)：用户信息，过期时间，签发时间...</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="string">&quot;userid&quot;</span>:<span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>:<span class="string">&quot;Jerry&quot;</span>,</span><br><span class="line">        <span class="string">&quot;exp&quot;</span>:<span class="number">121456</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">signature(签名)：把前面的头和荷载通过设置好的加密方式得到的串</span><br><span class="line"></span><br><span class="line"><span class="comment"># 签发和校验</span></span><br><span class="line">	</span><br><span class="line">    <span class="number">1</span> 用户登录成功：</span><br><span class="line">    	<span class="number">1.1</span> 构造token的头(固定)</span><br><span class="line">        <span class="number">1.2</span> 构造荷载</span><br><span class="line">        <span class="number">1.3</span> 使用设置好的加密方式对头和荷载加密，得到签名，三者用.拼接起来，生成一个token串(使用base64编码)</span><br><span class="line">        例如：	  eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><br><span class="line">    </span><br><span class="line">    <span class="number">2</span> 用户携带token，来到后端，把头和荷载再使用相同的加密方式加密，得到签名，比较新签名和旧签名是否一致，如果一致，说明该token可以信任，解析出当前用户(荷载)，继续往后走</span><br></pre></td></tr></table></figure>



<h3 id="base64编码"><a href="#base64编码" class="headerlink" title="base64编码"></a>base64编码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">dic=&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;lqz&#x27;</span>,<span class="string">&#x27;id&#x27;</span>:<span class="number">1</span>&#125;</span><br><span class="line">user_info_str=json.dumps(dic)</span><br><span class="line"><span class="comment"># res=base64.b64encode(bytes(user_info_str,encoding=&#x27;utf-8&#x27;))</span></span><br><span class="line">res=base64.b64encode(user_info_str.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(res) <span class="comment"># eyJuYW1lIjogImxxeiIsICJpZCI6IDF9</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解码</span></span><br><span class="line"></span><br><span class="line">res=base64.b64decode(<span class="string">&#x27;TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ=&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ps：</span></span><br><span class="line"><span class="string">	base64长度是4的倍数，如果不足，需要用=号补齐</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="JWT快速使用-2星"><a href="#JWT快速使用-2星" class="headerlink" title="JWT快速使用(2星)"></a>JWT快速使用(2星)</h3><p><strong>使用第三方：</strong></p>
<ul>
<li>djangorestframework-jwt：好久不维护，还能用</li>
<li>djangorestframework-simplejwt：最新的（<a target="_blank" rel="noopener" href="https://django-rest-framework-simplejwt.readthedocs.io/en/latest/getting_started.html%EF%BC%89">https://django-rest-framework-simplejwt.readthedocs.io/en/latest/getting_started.html）</a></li>
</ul>
<p><strong>签发</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只需要在路由中加入，向这个地址发送post请求，携带用户名密码，就可以签发token</span></span><br><span class="line"></span><br><span class="line">	path(<span class="string">&#x27;login/&#x27;</span>, obtain_jwt_token)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内部使用的是Django自带的auth组件(app)的user表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只需要在前端向配置的地址，发送post请求，携带用户名密码，就可以签发token</span></span><br></pre></td></tr></table></figure>



<p><strong>认证</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在视图类中配置，认证类和权限类(simplejwt只需要认证类)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.authentication <span class="keyword">import</span> JSONWebTokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ViewSetMixin,ListAPIView</span>):</span></span><br><span class="line">    authentication_classes = [JSONWebTokenAuthentication,]</span><br><span class="line">    permission_classes = [IsAuthenticated,]</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 前端访问，需要在请求头中加入，如果不携带，或者篡改了，认证就无法通过</span></span><br><span class="line">	key：Authorization</span><br><span class="line">    value：jwt xxx(以空格切割取token)</span><br></pre></td></tr></table></figure>



<h3 id="JWT使用auth表签发token，自定制格式-3星"><a href="#JWT使用auth表签发token，自定制格式-3星" class="headerlink" title="JWT使用auth表签发token，自定制格式(3星)"></a>JWT使用auth表签发token，自定制格式(3星)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只需要写一个函数，在配置文件中配置</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 函数</span></span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">jwt_response_payload_handler</span>(<span class="params">token, user=<span class="literal">None</span>, request=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>,</span><br><span class="line">        <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>:user.username,</span><br><span class="line">        <span class="string">&#x27;token&#x27;</span>: token,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 配置文件</span></span><br><span class="line">    </span><br><span class="line">    JWT_AUTH =&#123;</span><br><span class="line">            <span class="comment"># token的过期时间</span></span><br><span class="line">            <span class="string">&#x27;JWT_EXPIRATION_DELTA&#x27;</span>: datetime.timedelta(days=<span class="number">7</span>),</span><br><span class="line">            <span class="comment"># 自定义认证结果：见下方序列化user和自定义response</span></span><br><span class="line">            <span class="comment"># 如果不自定义，返回的格式是固定的，只有token字段</span></span><br><span class="line">            <span class="string">&#x27;JWT_RESPONSE_PAYLOAD_HANDLER&#x27;</span>: <span class="string">&#x27;app01.utils.jwt_response_payload_handler&#x27;</span>,</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h3 id="obtain-jwt-token源码分析-2星"><a href="#obtain-jwt-token源码分析-2星" class="headerlink" title="obtain_jwt_token源码分析(2星)"></a>obtain_jwt_token源码分析(2星)</h3><p><img src="https://i.loli.net/2021/07/13/9rumdEt6PK1I7yA.png" alt="image-20210708200119777.png"></p>
<p><img src="https://i.loli.net/2021/07/13/LPtXQu3bgdAin1B.png" alt="image-20210708201115115.png"></p>
<p><img src="https://i.loli.net/2021/07/13/MzK2IUvlPBpLriO.png" alt="image-20210708202015404.png"></p>
<p><img src="https://i.loli.net/2021/07/13/PiKmHtro35d2WeL.png" alt="image-20210708202554768.png"></p>
<p><img src="https://i.loli.net/2021/07/13/UxjrVGat59z2MXl.png" alt="image-20210708202924385.png"></p>
<p><img src="https://i.loli.net/2021/07/13/4OnkJZKvwDhXGTi.png" alt="image-20210708203058131.png"></p>
<p><img src="https://i.loli.net/2021/07/13/qILVJNO9QZK8n6k.png" alt="image-20210708203535421.png"></p>
<p><img src="https://i.loli.net/2021/07/13/8mqvgdzAQW5a1hK.png" alt="image-20210708204823746.png"></p>
<h3 id="基于jwt的认证类-5星"><a href="#基于jwt的认证类-5星" class="headerlink" title="基于jwt的认证类(5星)"></a>基于jwt的认证类(5星)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">重点逻辑在authenticate方法中：</span></span><br><span class="line"><span class="string">	1 取出客户端传入的token(后端自己规定是从头/路径中拿)</span></span><br><span class="line"><span class="string">	2 验证jwt的签名(使用模块提供的)</span></span><br><span class="line"><span class="string">	3 通过payload得到当前登录用户对象(使用模块提供的)</span></span><br><span class="line"><span class="string">	4 返回user，token</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JWTAuthentication</span>(<span class="params">BaseJSONWebTokenAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(request.META)</span><br><span class="line">        <span class="comment"># token=request.query_params.get(&#x27;HTTP_AUTHORIZATION&#x27;,None)</span></span><br><span class="line">        token=request.META.get(<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>,<span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> token:</span><br><span class="line">            <span class="comment"># 校验token是不是过期了，是不是合法，</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                payload = jwt_decode_handler(token)</span><br><span class="line">            <span class="keyword">except</span> jwt.ExpiredSignature:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token过期&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.DecodeError:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token认证失败&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token不合法&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">           <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token没有携带&#x27;</span>)</span><br><span class="line">        user = self.authenticate_credentials(payload)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (user, token)</span><br><span class="line">        </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">三种方式得到user：</span></span><br><span class="line"><span class="string">	1 继承，直接使用该类的方法</span></span><br><span class="line"><span class="string">	2 把方法copy出来，导入一箩筐</span></span><br><span class="line"><span class="string">	3 完全自己写(copy出来改吧改吧)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="基于自定义User表，签发token-5星"><a href="#基于自定义User表，签发token-5星" class="headerlink" title="基于自定义User表，签发token(5星)"></a>基于自定义User表，签发token(5星)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"></span><br><span class="line">router=SimpleRouter()</span><br><span class="line">router.register(<span class="string">&#x27;books&#x27;</span>,views.BookView)</span><br><span class="line">router.register(<span class="string">&#x27;user&#x27;</span>,views.UserInfoView,basename=<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoView</span>(<span class="params">ViewSet</span>):</span></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>],detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        username=request.data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password=request.data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        res=&#123;<span class="string">&#x27;code&#x27;</span>:<span class="string">&#x27;100&#x27;</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>&#125;</span><br><span class="line">        user=User.objects.<span class="built_in">filter</span>(username=username,password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="comment"># 登录成功,生成token，提供了（去找）</span></span><br><span class="line">            payload = jwt_payload_handler(user)</span><br><span class="line">            token=jwt_encode_handler(payload)</span><br><span class="line">            res[<span class="string">&#x27;token&#x27;</span>]=token</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res[<span class="string">&#x27;code&#x27;</span>]=<span class="number">101</span></span><br><span class="line">            res[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名或密码错误&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> Response(res)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># until.py(名字随意)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JWTMyUserAuthentication</span>(<span class="params">BaseAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        token=request.META.get(<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>,<span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> token:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                payload = jwt_decode_handler(token)</span><br><span class="line">                <span class="built_in">print</span>(payload)</span><br><span class="line">            <span class="keyword">except</span> jwt.ExpiredSignature:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token过期&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.DecodeError:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token认证失败&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token不合法&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">           <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token没有携带&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        user=User.objects.get(pk=payload.get(<span class="string">&#x27;user_id&#x27;</span>))</span><br><span class="line">        <span class="comment"># user=User(id=payload.get(&#x27;user_id&#x27;),username=payload.get(&#x27;username&#x27;))</span></span><br><span class="line">        <span class="comment"># 优化，减少数据库压力（）</span></span><br><span class="line">        <span class="comment"># user=&#123;&#x27;id&#x27;:payload.get(&#x27;user_id&#x27;),&#x27;username&#x27;:payload.get(&#x27;username&#x27;)&#125;</span></span><br><span class="line">        <span class="keyword">return</span> (user, token)</span><br></pre></td></tr></table></figure>



<h3 id="多方式登录-5星"><a href="#多方式登录-5星" class="headerlink" title="多方式登录(5星)"></a>多方式登录(5星)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 使用用户名、邮箱、手机号 + 密码都能登录成功</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 可以使用auth的User表，也可以自定义用户表</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> 扩写auth的User表(没有迁移之前使用---&gt;继承AbstractUser)</span><br><span class="line">	硬写：</span><br><span class="line">    	<span class="number">3.1</span> 删库(要有备份)</span><br><span class="line">        <span class="number">3.2</span> 删除迁移记录(app的迁移记录，auth、admin的迁移记录(源码中))</span><br><span class="line">        </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Userinfo</span>(<span class="params">ViewSet</span>):</span></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>], detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        response = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>, <span class="string">&#x27;token&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        ser = UserModelSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            response[<span class="string">&#x27;token&#x27;</span>] = ser.context.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            response[<span class="string">&#x27;code&#x27;</span>] = <span class="number">1001</span></span><br><span class="line">            response[<span class="string">&#x27;msg&#x27;</span>] = ser.errors</span><br><span class="line">        <span class="keyword">return</span> Response(response)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># serializer.py(名字随意)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModelSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    username = serializers.CharField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Userinfo</span><br><span class="line">        fields = [<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        user = self._get_user(attrs)</span><br><span class="line">        token = self._get_token(user)</span><br><span class="line">        self.context[<span class="string">&#x27;token&#x27;</span>] = token</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_user</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        username = attrs.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = attrs.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> re.match(<span class="string">&#x27;^1(3[0-9]|4[01456879]|5[0-35-9]|6[2567]|7[0-8]|8[0-9]|9[0-35-9])\d&#123;8&#125;$&#x27;</span>, username):</span><br><span class="line">            user = Userinfo.objects.<span class="built_in">filter</span>(phone=username).first()</span><br><span class="line">        <span class="keyword">elif</span> re.match(<span class="string">&#x27;^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$&#x27;</span>, username):</span><br><span class="line">            user = Userinfo.objects.<span class="built_in">filter</span>(email=username).first()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user = Userinfo.objects.<span class="built_in">filter</span>(username=username).first()</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">            <span class="keyword">else</span>:<span class="keyword">raise</span> ValidationError(<span class="string">&#x27;用户名或密码错误&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;用户名或密码错误&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_token</span>(<span class="params">self, user</span>):</span></span><br><span class="line">        payload = jwt_payload_handler(user)</span><br><span class="line">        token = jwt_encode_handler(payload)</span><br><span class="line">        <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># until.py(名字随意)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User_jwt_authentication</span>(<span class="params">BaseJSONWebTokenAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="comment"># print(request.META)</span></span><br><span class="line">        token = request.META.get(<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>)</span><br><span class="line">        <span class="comment"># return None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = jwt_decode_handler(token)</span><br><span class="line">        <span class="keyword">except</span> jwt.ExpiredSignature:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;签名过期，请重新登录&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> jwt.DecodeError:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;认证错误&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;认证不合法&#x27;</span>)</span><br><span class="line">        user = self.authenticate_credentials(payload)</span><br><span class="line">        <span class="keyword">return</span> (user, token)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate_credentials</span>(<span class="params">self, payload</span>):</span></span><br><span class="line">        username = payload.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;用户名不存在&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = Userinfo.objects.<span class="built_in">filter</span>(username=username).first()</span><br><span class="line">        <span class="keyword">except</span> Userinfo.DoesNotExist:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;无效的签名&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user.is_active:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;用户已注销&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line"></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/12/Center%20OS%207%20%E9%80%9A%E8%BF%87Docker%E9%83%A8%E7%BD%B2yapi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/06/12/Center%20OS%207%20%E9%80%9A%E8%BF%87Docker%E9%83%A8%E7%BD%B2yapi/" class="post-title-link" itemprop="url">Center OS 7通过Docker部署yapi</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-12 07:20:25" itemprop="dateCreated datePublished" datetime="2019-06-12T07:20:25+08:00">2019-06-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-07-01 12:22:34" itemprop="dateModified" datetime="2019-07-01T12:22:34+08:00">2019-07-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">杂七杂八系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="版本要求"><a href="#版本要求" class="headerlink" title="版本要求"></a>版本要求</h2><ul>
<li>Linux Center OS 7</li>
</ul>
<h2 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Docker 要求 CentOS 系统的内核版本高于 3.10 ，查看本页面的前提条件来验证你的CentOS 版本是否支持 Docker 。通过 uname -r 命令查看你当前的内核版本</span></span><br><span class="line">uname -r</span><br><span class="line"></span><br><span class="line"><span class="comment">#确保 yum 包更新到最新</span></span><br><span class="line">yum update</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果安装过旧版本的话，卸载旧版本</span></span><br><span class="line">yum remove docker  docker-common docker-selinux docker-engine</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装需要的软件包， yum-util 提供yum-config-manager功能，另外两个是devicemapper驱动依赖的</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置yum源</span></span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看所有仓库中所有docker版本，并选择特定版本安装</span></span><br><span class="line">yum <span class="built_in">list</span> docker-ce --showduplicates | sort -r</span><br><span class="line"></span><br><span class="line"><span class="comment">#安装Docker</span></span><br><span class="line">yum install docker-ce</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果你想安装自定义版本可以输入以下命令：</span></span><br><span class="line">yum install docker-ce-<span class="number">17.12</span><span class="number">.0</span>.ce</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动并加入开机启动</span></span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl enable docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#验证安装是否成功(有client和service两部分表示docker安装启动都成功了)</span></span><br><span class="line">docker version</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://get.daocloud.io/docker/compose/releases/download/<span class="number">1.26</span><span class="number">.2</span>/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/<span class="built_in">bin</span>/docker-compose</span><br><span class="line">chmod +x /usr/local/<span class="built_in">bin</span>/docker-compose</span><br><span class="line"><span class="comment">#查看docker-compose版本</span></span><br><span class="line">docker-compose --version</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="创建自动化容器部署"><a href="#创建自动化容器部署" class="headerlink" title="创建自动化容器部署"></a>创建自动化容器部署</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cd ~</span><br><span class="line">mkdir docker</span><br><span class="line">cd docker </span><br><span class="line">vi docker-compose.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#docker-compose.yml文件内容如下</span></span><br><span class="line">version: <span class="string">&#x27;3&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  yapi-web:</span><br><span class="line">    image: jayfong/yapi:latest</span><br><span class="line">    container_name: yapi-web</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">3000</span>:<span class="number">3000</span></span><br><span class="line">    environment:</span><br><span class="line">      - YAPI_ADMIN_ACCOUNT=<span class="number">123123123</span>@qq.com  <span class="comment">#用户名邮箱</span></span><br><span class="line">      - YAPI_ADMIN_PASSWORD=admin123  <span class="comment">#密码</span></span><br><span class="line">      - YAPI_CLOSE_REGISTER=true</span><br><span class="line">      - YAPI_DB_SERVERNAME=yapi-mongo</span><br><span class="line">      - YAPI_DB_PORT=<span class="number">27017</span></span><br><span class="line">      - YAPI_DB_DATABASE=yapi</span><br><span class="line">      - YAPI_MAIL_ENABLE=false</span><br><span class="line">      - YAPI_LDAP_LOGIN_ENABLE=false</span><br><span class="line">      - YAPI_PLUGINS=[]</span><br><span class="line">    depends_on:</span><br><span class="line">      - yapi-mongo</span><br><span class="line">    links:</span><br><span class="line">      - yapi-mongo</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">  yapi-mongo:</span><br><span class="line">    image: mongo:latest</span><br><span class="line">    container_name: yapi-mongo</span><br><span class="line">    volumes:</span><br><span class="line">      - ./data/db:/data/db</span><br><span class="line">    expose:</span><br><span class="line">      - <span class="number">27017</span></span><br><span class="line">    restart: unless-stopped</span><br></pre></td></tr></table></figure>



<h2 id="开始部署容器"><a href="#开始部署容器" class="headerlink" title="开始部署容器"></a>开始部署容器</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d	<span class="comment"># 启动</span></span><br><span class="line">docker-compose stop		<span class="comment"># 停止</span></span><br><span class="line">docker-compose rm		<span class="comment"># 删除</span></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/11/Django%E5%88%9D%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/11/Django%E5%88%9D%E8%AF%86/" class="post-title-link" itemprop="url">Django初识</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-11 07:20:25" itemprop="dateCreated datePublished" datetime="2019-05-11T07:20:25+08:00">2019-05-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-06-01 12:22:34" itemprop="dateModified" datetime="2019-06-01T12:22:34+08:00">2019-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Django%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Django系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="内容概要"><a href="#内容概要" class="headerlink" title="内容概要"></a>内容概要</h1><ul>
<li>我们自己写一个简易版本的web框架(代码无需掌握，重点在于理解思路)</li>
<li>django框架</li>
</ul>
<h1 id="内容详细"><a href="#内容详细" class="headerlink" title="内容详细"></a>内容详细</h1><h3 id="Django生命周期流程图"><a href="#Django生命周期流程图" class="headerlink" title="Django生命周期流程图"></a>Django生命周期流程图</h3><p> <img src="https://img2020.cnblogs.com/blog/2342210/202106/2342210-20210622080437779-1091380189.png" alt="img"></p>
<h3 id="软件开发架构"><a href="#软件开发架构" class="headerlink" title="软件开发架构"></a>软件开发架构</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cs架构</span><br><span class="line">bs架构</span><br><span class="line"><span class="comment"># 本质bs也是cs</span></span><br></pre></td></tr></table></figure>

<h3 id="纯手撸web框架"><a href="#纯手撸web框架" class="headerlink" title="纯手撸web框架"></a>纯手撸web框架</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HTTP协议</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">网络协议</span></span><br><span class="line"><span class="string">HTTP协议                数据传输是明文</span></span><br><span class="line"><span class="string">HTTPS协议                数据传输是密文</span></span><br><span class="line"><span class="string">websocket协议            数据传输是密文</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">四大特性</span></span><br><span class="line"><span class="string">    1.基于请求响应</span></span><br><span class="line"><span class="string">    2.基于TCP、IP作用于应用层之上的协议</span></span><br><span class="line"><span class="string">    3.无状态</span></span><br><span class="line"><span class="string">    4.短/无链接</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">数据格式</span></span><br><span class="line"><span class="string">    请求首行</span></span><br><span class="line"><span class="string">    请求头</span></span><br><span class="line"><span class="string">    \r\n</span></span><br><span class="line"><span class="string">    请求体</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">响应状态码</span></span><br><span class="line"><span class="string">    1XX</span></span><br><span class="line"><span class="string">    2XX            200</span></span><br><span class="line"><span class="string">    3XX            </span></span><br><span class="line"><span class="string">    4XX            403 404</span></span><br><span class="line"><span class="string">    5XX            500</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 如何做到后缀的不同返回不同的内容</span></span><br><span class="line">    <span class="comment"># 拿到用户输入的后缀 做判断 </span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 不足之处</span></span><br><span class="line">    <span class="number">1.</span>代码重复(服务端代码所有人都要重复写)</span><br><span class="line">      <span class="number">2.</span>手动处理http格式的数据 并且只能拿到url后缀 其他数据获取繁琐(数据格式一样处理的代码其实也大致一样 重复写)</span><br><span class="line">      <span class="number">3.</span>并发的问题</span><br></pre></td></tr></table></figure>

<h3 id="借助于wsgiref模块"><a href="#借助于wsgiref模块" class="headerlink" title="借助于wsgiref模块"></a>借助于wsgiref模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">urls.py                            路由与视图函数对应关系</span></span><br><span class="line"><span class="string">views.py                　　　　 视图函数(后端业务逻辑)</span></span><br><span class="line"><span class="string">templates文件夹　　　　　　　　　　　　　　　　　　　　专门用来存储html文件</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 按照功能的不同拆分之后 后续添加功能只需要在urls.py书写对应关系然后取views.py书写业务逻辑即可</span></span><br></pre></td></tr></table></figure>

<h3 id="动静态网页"><a href="#动静态网页" class="headerlink" title="动静态网页"></a>动静态网页</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">静态网页</span></span><br><span class="line"><span class="string">    页面上的数据是直接写死的 万年不变</span></span><br><span class="line"><span class="string">动态网页</span></span><br><span class="line"><span class="string">    数据是实时获取的</span></span><br><span class="line"><span class="string">    eg:</span></span><br><span class="line"><span class="string">        1.后端获取当前时间展示到html页面上</span></span><br><span class="line"><span class="string">        2.数据是从数据库中获取的展示到html页面上</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 动态网页制作</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_time</span>(<span class="params">env</span>):</span></span><br><span class="line">    current_time = datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d %X&#x27;</span>)</span><br><span class="line">    <span class="comment"># 如何将后端获取到的数据&quot;传递&quot;给html文件？</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&#x27;templates/03 mytime.html&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">        <span class="comment"># data就是一堆字符串</span></span><br><span class="line">    data = data.replace(<span class="string">&#x27;dwadasdsadsadasdas&#x27;</span>,current_time)   <span class="comment"># 在后端将html页面处理好之后再返回给前端</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将一个字典传递给html文件 并且可以在文件上方便快捷的操作字典数据</span></span><br><span class="line"><span class="keyword">from</span> jinja2 <span class="keyword">import</span> Template</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_dict</span>(<span class="params">env</span>):</span></span><br><span class="line">    user_dic = &#123;<span class="string">&#x27;username&#x27;</span>:<span class="string">&#x27;jason&#x27;</span>,<span class="string">&#x27;age&#x27;</span>:<span class="number">18</span>,<span class="string">&#x27;hobby&#x27;</span>:<span class="string">&#x27;read&#x27;</span>&#125;</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">r&#x27;templates/04 get_dict.html&#x27;</span>,<span class="string">&#x27;r&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    tmp = Template(data)</span><br><span class="line">    res = tmp.render(user=user_dic)</span><br><span class="line">    <span class="comment"># 给get_dict.html传递了一个值 页面上通过变量名user就能够拿到user_dict</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后端获取数据库中数据展示到前端页面</span></span><br></pre></td></tr></table></figure>

<h3 id="模版语法之Jinja2模块"><a href="#模版语法之Jinja2模块" class="headerlink" title="模版语法之Jinja2模块"></a>模版语法之Jinja2模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pip3 install jinja2</span><br><span class="line"><span class="string">&quot;&quot;&quot;模版语法是在后端起作用的&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模版语法(非常贴近python语法)</span></span><br><span class="line">&#123;&#123; user &#125;&#125;</span><br><span class="line">&#123;&#123; user.get(<span class="string">&#x27;username&#x27;</span>)&#125;&#125;</span><br><span class="line">&#123;&#123; user.age &#125;&#125;</span><br><span class="line">&#123;&#123; user[<span class="string">&#x27;hobby&#x27;</span>] &#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% <span class="keyword">for</span> user_dict <span class="keyword">in</span> user_list %&#125;</span><br><span class="line">                        &lt;tr&gt;</span><br><span class="line">                            &lt;td&gt;&#123;&#123; user_dict.<span class="built_in">id</span>&#125;&#125;&lt;/td&gt;</span><br><span class="line">                            &lt;td&gt;&#123;&#123; user_dict.username&#125;&#125;&lt;/td&gt;</span><br><span class="line">                            &lt;td&gt;&#123;&#123; user_dict.password&#125;&#125;&lt;/td&gt;</span><br><span class="line">                            &lt;td&gt;&#123;&#123; user_dict.hobby&#125;&#125;&lt;/td&gt;</span><br><span class="line">                        &lt;/tr&gt;</span><br><span class="line">&#123;% endfor%&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义简易版本web框架请求流程图"><a href="#自定义简易版本web框架请求流程图" class="headerlink" title="自定义简易版本web框架请求流程图"></a>自定义简易版本web框架请求流程图</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">wsgiref模块</span></span><br><span class="line"><span class="string">    1.请求来的时候解析http格式的数据 封装成大字典</span></span><br><span class="line"><span class="string">    2.响应走的时候给数据打包成符合http格式 再返回给浏览器</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="python三大主流web框架"><a href="#python三大主流web框架" class="headerlink" title="python三大主流web框架"></a>python三大主流web框架</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">django</span></span><br><span class="line"><span class="string">    特点:大而全 自带的功能特别特别特别的多 类似于航空母舰</span></span><br><span class="line"><span class="string">    不足之处:</span></span><br><span class="line"><span class="string">        有时候过于笨重</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">flask</span></span><br><span class="line"><span class="string">    特点:小而精  自带的功能特别特别特别的少 类似于游骑兵</span></span><br><span class="line"><span class="string">    第三方的模块特别特别特别的多，如果将flask第三方的模块加起来完全可以盖过django</span></span><br><span class="line"><span class="string">    并且也越来越像django</span></span><br><span class="line"><span class="string">    不足之处:</span></span><br><span class="line"><span class="string">        比较依赖于第三方的开发者</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">tornado</span></span><br><span class="line"><span class="string">    特点:异步非阻塞 支持高并发</span></span><br><span class="line"><span class="string">        牛逼到甚至可以开发游戏服务器</span></span><br><span class="line"><span class="string">    不足之处:</span></span><br><span class="line"><span class="string">        你不会~</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如何让你的计算机能够正常的启动django项目</span></span><br><span class="line">    <span class="number">1.</span>计算机的名称不能有中文</span><br><span class="line">      <span class="number">2.</span>一个pycharm窗口只开一个项目 <span class="comment"># 不要文件夹套文件夹</span></span><br><span class="line">      <span class="number">3.</span>项目里面所有的文件也尽量不要出现中文</span><br><span class="line">      <span class="number">4.</span>python解释器尽量使用<span class="number">3.4</span>~<span class="number">3.6</span>之间的版本</span><br><span class="line">      (如果你的项目报错 你点击最后一个报错信息</span><br><span class="line">    去源码中把逗号删掉)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># django版本问题</span></span><br><span class="line">    <span class="number">1.</span>X <span class="number">2.</span>X <span class="number">3.</span>X(最新版本)</span><br><span class="line">    </span><br><span class="line">      <span class="number">1.</span>X和<span class="number">2.</span>X本身差距也不大 </span><br><span class="line">      公司之前用的<span class="number">1.8</span>  有一些项目用的<span class="number">2.0</span></span><br><span class="line">  </span><br><span class="line">     django版本图</span><br><span class="line">  </span><br><span class="line"><span class="comment"># django安装</span></span><br><span class="line">    pip3 install django==<span class="number">1.11</span><span class="number">.11</span></span><br><span class="line">      如果已经安装了其他版本 无需自己卸载</span><br><span class="line">      直接重新装 会自动卸载安装新的</span><br><span class="line">  </span><br><span class="line">      如果报错 看看是不是timeout 如果是 那么只是网速波动</span><br><span class="line">      重新安装即可</span><br><span class="line"></span><br><span class="line">      验证是否安装成功的方式<span class="number">1</span></span><br><span class="line">        终端输入django-admin看看有没有反应</span><br></pre></td></tr></table></figure>

<h3 id="django基本操作"><a href="#django基本操作" class="headerlink" title="django基本操作"></a>django基本操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 命令行操作</span></span><br><span class="line">    <span class="comment"># 1.创建django项目</span></span><br><span class="line">      <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">      你可以先切换到对应的D盘 然后再创建</span></span><br><span class="line"><span class="string">      &quot;&quot;&quot;</span></span><br><span class="line">      django-admin startproject mysite</span><br><span class="line">    </span><br><span class="line">        mysite文件夹</span><br><span class="line">          manage.py</span><br><span class="line">          mysite文件夹</span><br><span class="line">            __init__.py</span><br><span class="line">            settings.py</span><br><span class="line">          urls.py</span><br><span class="line">          wsgi.py</span><br><span class="line"> <span class="comment"># 2.启动django项目</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        一定要先切换到项目目录下    </span></span><br><span class="line"><span class="string">        cd /mysite</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">  python3 manage.py runserver</span><br><span class="line">  <span class="comment"># http://127.0.0.1:8000/</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 3.创建应用</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Next, start your first app by running python manage.py startapp [app_label].</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">    python manage.py startapp app01</span><br><span class="line">    应用名应该做到见名知意</span><br><span class="line">      user</span><br><span class="line">      order</span><br><span class="line">      web</span><br><span class="line">      ...</span><br><span class="line">      但是我们教学统一就用app01/02/03/04</span><br><span class="line">      </span><br><span class="line">    有很多文件</span><br><span class="line">  </span><br><span class="line"><span class="comment"># pycharm操作</span></span><br><span class="line">    <span class="comment"># 1 new project 选择左侧第二个django即可</span></span><br><span class="line">  </span><br><span class="line">      <span class="comment"># 2 启动</span></span><br><span class="line">          <span class="number">1.</span>还是用命令行启动</span><br><span class="line">        <span class="number">2.</span>点击绿色小箭头即可</span><br><span class="line"></span><br><span class="line">      <span class="comment"># 3 创建应用</span></span><br><span class="line">          <span class="number">1.</span>pycharm提供的终端直接输入完整命令</span><br><span class="line">        <span class="number">2.</span>pycharm </span><br><span class="line">              tools </span><br><span class="line">                run manage.py task提示(前期不要用 给我背完整命令)</span><br><span class="line">     <span class="comment"># 4 修改端口号以及创建server    </span></span><br><span class="line">        edit confi....</span><br></pre></td></tr></table></figure>

<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">django是一款专门用来开发app的web框架</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">django框架就类似于是一所大学(空壳子)</span></span><br><span class="line"><span class="string">app就类似于大学里面各个学院(具体功能的app)</span></span><br><span class="line"><span class="string">    比如开发淘宝</span></span><br><span class="line"><span class="string">        订单相关</span></span><br><span class="line"><span class="string">        用户相关</span></span><br><span class="line"><span class="string">        投诉相关</span></span><br><span class="line"><span class="string">        创建不同的app对应不同的功能</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    选课系统</span></span><br><span class="line"><span class="string">        学生功能</span></span><br><span class="line"><span class="string">        老师功能</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">一个app就是一个独立的功能模块</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">***********************创建的应用一定要去配置文件中注册**********************</span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;app01.apps.App01Config&#x27;</span>,  <span class="comment"># 全写</span></span><br><span class="line">      <span class="string">&#x27;app01&#x27;</span>,             <span class="comment"># 简写</span></span><br><span class="line">]</span><br><span class="line"><span class="comment"># 创建出来的的应用第一步先去配置文件中注册 其他的先不要给我干</span></span><br><span class="line">ps:你在用pycharm创建项目的时候 pycharm可以帮你创建一个app并且自动注册</span><br><span class="line">***********************************************************************</span><br></pre></td></tr></table></figure>

<h3 id="主要文件介绍"><a href="#主要文件介绍" class="headerlink" title="主要文件介绍"></a>主要文件介绍</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">-mysite项目文件夹</span><br><span class="line">    --mysite文件夹</span><br><span class="line">      ---settings.py           配置文件</span><br><span class="line">    ---urls.py              路由与视图函数对应关系(路由层)</span><br><span class="line">    ---wsgi.py              wsgiref模块(不考虑)</span><br><span class="line">  --manage.py              django的入口文件</span><br><span class="line">  --db.sqlite3              django自带的sqlite3数据库(小型数据库 功能不是很多还有bug)</span><br><span class="line">  --app01文件夹</span><br><span class="line">      ---admin.py              django后台管理</span><br><span class="line">    ---apps.py              注册使用</span><br><span class="line">    ---migrations文件夹    数据库迁移记录</span><br><span class="line">    ---models.py          数据库相关的 模型类(orm)</span><br><span class="line">      ---tests.py              测试文件</span><br><span class="line">    ---views.py              视图函数(视图层)</span><br></pre></td></tr></table></figure>

<h3 id="命令行与pycharm创建的区别"><a href="#命令行与pycharm创建的区别" class="headerlink" title="命令行与pycharm创建的区别"></a>命令行与pycharm创建的区别</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 命令行创建不会自动有templatew文件夹 需要你自己手动创建而pycharm会自动帮你创建并且还会自动在配置文件中配置对应的路径</span></span><br><span class="line"><span class="comment"># pycharm创建</span></span><br><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR, <span class="string">&#x27;templates&#x27;</span>)]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment"># 命令行创建</span></span><br><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [],</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">也就意味着你在用命令创建django项目的时候不单单需要创建templates文件夹还需要去配置文件中配置路径</span></span><br><span class="line"><span class="string">&#x27;DIRS&#x27;: [os.path.join(BASE_DIR, &#x27;templates&#x27;)]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="django小白必会三板斧"><a href="#django小白必会三板斧" class="headerlink" title="django小白必会三板斧"></a>django小白必会三板斧</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">HttpResponse</span></span><br><span class="line"><span class="string">    返回字符串类型的数据</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">render</span></span><br><span class="line"><span class="string">    返回html文件的</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">redirect</span></span><br><span class="line"><span class="string">    重定向</span></span><br><span class="line"><span class="string">      return redirect(&#x27;https://www.mzitu.com/&#x27;)</span></span><br><span class="line"><span class="string">    return redirect(&#x27;/home/&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8Bauth%E6%A8%A1%E5%9D%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8Bauth%E6%A8%A1%E5%9D%97/" class="post-title-link" itemprop="url">Django基础之auth模块</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-11 07:20:25" itemprop="dateCreated datePublished" datetime="2019-05-11T07:20:25+08:00">2019-05-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-06-01 12:22:34" itemprop="dateModified" datetime="2019-06-01T12:22:34+08:00">2019-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Django%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Django系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="内容概要"><a href="#内容概要" class="headerlink" title="内容概要"></a>内容概要</h1><ul>
<li>用户认证模块auth</li>
<li>auth模块补充</li>
<li>auth_user表扩展字段</li>
</ul>
<h1 id="内容详细"><a href="#内容详细" class="headerlink" title="内容详细"></a>内容详细</h1><h3 id="auth模块"><a href="#auth模块" class="headerlink" title="auth模块"></a>auth模块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">主要是用来做用户相关的功能</span><br><span class="line">    注册 登录 验证 修改密码 注销</span><br><span class="line"></span><br><span class="line">访问admin需要管理员账号</span><br><span class="line">    该账号数据均来源于数据库迁移之后生成的auth_user表</span><br><span class="line">    </span><br><span class="line">如何创建admin管理员账号</span><br><span class="line">    createsuperuser</span><br></pre></td></tr></table></figure>

<h3 id="具体操作"><a href="#具体操作" class="headerlink" title="具体操作"></a>具体操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> auth</span><br><span class="line"></span><br><span class="line"><span class="comment"># 校验用户名密码是否正确</span></span><br><span class="line">auth.authenticate(request,username=username,password=password)</span><br><span class="line"><span class="comment"># 保存用户状态</span></span><br><span class="line">auth.login(request,user_obj)</span><br><span class="line"><span class="comment"># 查看用户是否登录</span></span><br><span class="line">request.user.is_authenticated()</span><br><span class="line"><span class="comment"># 获取用户对象</span></span><br><span class="line">request.user</span><br><span class="line"><span class="comment"># 校验原密码是否正确</span></span><br><span class="line">request.user.check_password()</span><br><span class="line"><span class="comment"># 修改密码</span></span><br><span class="line">request.user.set_password()</span><br><span class="line">request.user.save()</span><br><span class="line"><span class="comment"># 校验是否登录装饰器</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">跳转全局配置</span></span><br><span class="line"><span class="string">    LOGIN_URL = &#x27;/lg/&#x27;</span></span><br><span class="line"><span class="string">跳转局部配置</span></span><br><span class="line"><span class="string">    @login_required(login_url=&#x27;/lg/&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="auth模块补充"><a href="#auth模块补充" class="headerlink" title="auth模块补充"></a>auth模块补充</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.用户注册</span><br><span class="line">from django.contrib.auth.models import AbstractUser,User</span><br><span class="line">    # 操作auth_user写入数据不能使用create方法 密码不会自动加密</span><br><span class="line">        # User.objects.create(username=username,password=password,email=email)</span><br><span class="line">        # 创建普通用户</span><br><span class="line">        User.objects.create_user(username=username,password=password,email=email)</span><br><span class="line">        # 创建超级用户</span><br><span class="line">        User.objects.create_superuser(username=username, password=password, email=email)</span><br><span class="line">2.用户注销</span><br><span class="line">    auth.logout(request)</span><br></pre></td></tr></table></figure>

<h3 id="auth模块用户表扩展字段"><a href="#auth模块用户表扩展字段" class="headerlink" title="auth模块用户表扩展字段"></a>auth模块用户表扩展字段</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在auth_user表的基础之上还想增加额外的字段 并且还可以使用auth模块所有的功能</span><br><span class="line"><span class="comment"># 配合文件配置</span></span><br><span class="line"><span class="comment"># 告诉django使用我们自己定义的表来取代auth_user表</span></span><br><span class="line">AUTH_USER_MODEL = <span class="string">&#x27;app01.Userinfo&#x27;</span>  <span class="comment"># 应用名.表名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一对一表关联(了解)</span></span><br><span class="line"><span class="comment"># 面向对象继承(掌握)</span></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractUser</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Userinfo</span>(<span class="params">AbstractUser</span>):</span></span><br><span class="line">    <span class="comment"># 扩展AbstractUser表中没有的字段</span></span><br><span class="line">    phone = models.BigIntegerField()</span><br><span class="line">    info = models.CharField(max_length=<span class="number">255</span>)</span><br></pre></td></tr></table></figure>

<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>：校验用户名与密码</span><br><span class="line"></span><br><span class="line">      auth.authenticate(username=username, ...)</span><br><span class="line"> </span><br><span class="line"><span class="number">2</span>：保存用户信息</span><br><span class="line">      auth.login(request, user_obj)</span><br><span class="line"> </span><br><span class="line"><span class="number">3</span>：判断用户是否登录</span><br><span class="line">      request.user.is_authenticated()</span><br><span class="line"> </span><br><span class="line"><span class="number">4</span>：装饰器</span><br><span class="line">      form django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line">      局部：@login_required(login_url=<span class="string">&#x27;/login/&#x27;</span>) (灵活)</span><br><span class="line">      全局：配置---&gt;LOGIN_URL = <span class="string">&#x27;/login/&#x27;</span> （省事）</span><br><span class="line"> </span><br><span class="line"><span class="number">5</span>：验证原密码(修改密码)</span><br><span class="line">      request.user.check_password(原密码)</span><br><span class="line"> </span><br><span class="line"><span class="number">6</span>：修改密码（两步）</span><br><span class="line">      request.user.set_password(新密码)</span><br><span class="line">      request.user.save()</span><br><span class="line"> </span><br><span class="line"><span class="number">7</span>：创建用户</span><br><span class="line">　　命令行创建：createsupperuser（超级用户）（管理一般不会使用逻辑代码创建）</span><br><span class="line">       <span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line">　　User.objexts.create()（创建的用户密码是明文）（不推荐）</span><br><span class="line">       User.objexts.create_user()（普通用户）</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8BAjax/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8BAjax/" class="post-title-link" itemprop="url">Django基础之Ajax</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-11 07:20:25" itemprop="dateCreated datePublished" datetime="2019-05-11T07:20:25+08:00">2019-05-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-06-01 12:22:34" itemprop="dateModified" datetime="2019-06-01T12:22:34+08:00">2019-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Django%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Django系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="内容概要"><a href="#内容概要" class="headerlink" title="内容概要"></a>内容概要</h1><ul>
<li><p>Ajax异步提交</p>
</li>
<li><p>前后端传输数据的编码格式</p>
</li>
<li><p>Ajax发送json格式数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># python</span></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">json.dumps</span><br><span class="line">json.loads</span><br><span class="line"><span class="comment"># js</span></span><br><span class="line">JSON.stringfy</span><br><span class="line">JSON.parse</span><br></pre></td></tr></table></figure></li>
<li><p>Ajax发送文件数据</p>
</li>
<li><p>Ajax结合sweetalert插件实现删除的二次确认</p>
</li>
</ul>
<h1 id="内容详细"><a href="#内容详细" class="headerlink" title="内容详细"></a>内容详细</h1><h3 id="Ajax"><a href="#Ajax" class="headerlink" title="Ajax"></a>Ajax</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">异步提交 局部刷新</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">同步:提交任务之后原地等待任务结果期间不做任何事</span></span><br><span class="line"><span class="string">异步:提交任务之后不原地等待任务结果 等任务产生结果通过异步回调机制</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">前戏页面</span><br><span class="line">    博客园注册页面</span><br><span class="line">    github注册页面</span><br><span class="line"> </span><br><span class="line">能够发送网络请求的方法</span><br><span class="line">    a               get请求</span><br><span class="line">    form表单         get请求、post请求</span><br><span class="line">    ajax              get请求、post请求</span><br><span class="line"> </span><br><span class="line">ajax不是一门独立的语言 而是一个功能</span><br><span class="line">    能够实现ajax功能的书写方式有很多 </span><br><span class="line">        eg:原生js代码 jQuery封装代码 组件框架代码...</span><br><span class="line">    我们这里学习jQuery版本</span><br><span class="line"> </span><br><span class="line">ajax前戏</span><br><span class="line">    需求:保证页面不刷新的情况下完成数字的和</span><br></pre></td></tr></table></figure>

<h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// ajax发送给后端</span><br><span class="line">$.ajax(&#123;</span><br><span class="line">            url:<span class="string">&#x27;&#x27;</span>,  // 控制提交地址    规律与form标签的action参数一致</span><br><span class="line">            <span class="built_in">type</span>:<span class="string">&#x27;post&#x27;</span>,  // 控制请求方式</span><br><span class="line">            data:&#123;<span class="string">&#x27;i1&#x27;</span>:i1Val,<span class="string">&#x27;i2&#x27;</span>:i2Val&#125;,  // 发送的数据</span><br><span class="line">            success:function (args) &#123;</span><br><span class="line">                    // 异步回调函数</span><br><span class="line">                    &#123;<span class="comment">#alert(args)#&#125;</span></span><br><span class="line">                    // 查看<span class="built_in">input</span>框并且写入数据</span><br><span class="line">                    $(<span class="string">&#x27;#i3&#x27;</span>).val(args)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="参数补充"><a href="#参数补充" class="headerlink" title="参数补充"></a>参数补充</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">contentType</span><br><span class="line">    前后端数据传输格式主要有三种</span><br><span class="line">        application/x-www-form-urlencoded</span><br><span class="line">        multipart/form-data</span><br><span class="line">        application/json</span><br><span class="line">    朝后端发送数据的时候针对不同的方式后端有不同的处理措施</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># form表单默认是urlencoded编码格式</span></span><br><span class="line">    数据格式username=jason&amp;password=<span class="number">234</span></span><br><span class="line">    django后端针对符合urlencoded格式的数据会自动解析并封装到request.POST中</span><br><span class="line">    django后端针对form-data格式的数据文件自动封装到request.FILES中 普通的符合urlencoded还是封装到request.POST中</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># ajax默认是urlencoded编码格式</span></span><br><span class="line">        <span class="number">1.</span>ajax发送json格式数据</span><br><span class="line">            django后端不做任何处理 直接以二进制形式存放在request.body中</span><br><span class="line">            data</span><br><span class="line">            contentType</span><br><span class="line">        <span class="number">2.</span>ajax发送文件数据</span><br><span class="line">            $(<span class="string">&#x27;#d1&#x27;</span>).on(<span class="string">&#x27;click&#x27;</span>,function () &#123;</span><br><span class="line">                // <span class="number">1.</span>先生成一个内置对象</span><br><span class="line">                let formDataObj = new FormData();</span><br><span class="line">                // <span class="number">2.</span>添加符合urlencoded格式的普通键值对数据</span><br><span class="line">                formDataObj.append(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;jason&#x27;</span>);</span><br><span class="line">                formDataObj.append(<span class="string">&#x27;password&#x27;</span>,<span class="number">123</span>);</span><br><span class="line">                // <span class="number">3.</span>添加文件数据</span><br><span class="line">                formDataObj.append(<span class="string">&#x27;myfile&#x27;</span>,$(<span class="string">&#x27;#myfile&#x27;</span>)[<span class="number">0</span>].files[<span class="number">0</span>]);</span><br><span class="line">                // ajax发送给后端</span><br><span class="line">                $.ajax(&#123;</span><br><span class="line">                    url:<span class="string">&#x27;&#x27;</span>,  // 控制提交地址    规律与form标签的action参数一致</span><br><span class="line">                    <span class="built_in">type</span>:<span class="string">&#x27;post&#x27;</span>,  // 控制请求方式</span><br><span class="line">                    data:formDataObj,  // 发送的数据</span><br><span class="line"></span><br><span class="line">                    // 额外指定两个参数</span><br><span class="line">                    contentType:false,  // 不采用任何编码 后端能够直接识别formdata对象</span><br><span class="line">                    processData:false,  // 不处理formdata对象 直接发送即可</span><br><span class="line"></span><br><span class="line">                    success:function (args) &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">dataType</span><br><span class="line">    django后端如果使用JsonResponse给回调函数返回json格式字符串</span><br><span class="line">    回调函数会自动反序列成js中的自定义对象</span><br><span class="line">    django后端不使用JsonResponse而是自己通过json模块序列化的数据 回调函数接收到之后不会自动反序列</span><br></pre></td></tr></table></figure>

<h3 id="基于ajax实现二次确认"><a href="#基于ajax实现二次确认" class="headerlink" title="基于ajax实现二次确认"></a>基于ajax实现二次确认</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">        $(<span class="string">&#x27;.del_link&#x27;</span>).on(<span class="string">&#x27;click&#x27;</span>,function (a) &#123;</span><br><span class="line">            var $aEle = $(this);</span><br><span class="line">            var deleteId = $(this).attr(<span class="string">&#x27;delete_id&#x27;</span>);</span><br><span class="line">            // 提示二次确认</span><br><span class="line">            res = confirm(<span class="string">&#x27;你确定真的要删吗?&#x27;</span>);</span><br><span class="line">            // 判断是否删除</span><br><span class="line">            <span class="keyword">if</span> (res)&#123;</span><br><span class="line">                // 发送ajax请求</span><br><span class="line">                $.ajax(&#123;</span><br><span class="line">                    url:<span class="string">&quot;/book_delete/&quot;</span> + deleteId,</span><br><span class="line">                    <span class="built_in">type</span>:<span class="string">&#x27;get&#x27;</span>,</span><br><span class="line">                    data:&#123;&#125;,</span><br><span class="line">                    success:function (args) &#123;</span><br><span class="line">                        // <span class="number">1.</span>页面刷新  不推荐使用</span><br><span class="line">                        window.location.reload();</span><br><span class="line">                        // <span class="number">2.</span>DOM操作   正规 用户体验好</span><br><span class="line">                        $aEle.parent().parent().remove()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                alert(<span class="string">&#x27;怂逼不敢删啦&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8Bcookie%E4%B8%8Esession/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8Bcookie%E4%B8%8Esession/" class="post-title-link" itemprop="url">Django基础之cookie与session</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-11 07:20:25" itemprop="dateCreated datePublished" datetime="2019-05-11T07:20:25+08:00">2019-05-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-06-01 12:22:34" itemprop="dateModified" datetime="2019-06-01T12:22:34+08:00">2019-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Django%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Django系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="cookie与session"><a href="#cookie与session" class="headerlink" title="cookie与session"></a>cookie与session</h1><h3 id="由来及简介"><a href="#由来及简介" class="headerlink" title="由来及简介"></a>由来及简介</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">HTTP协议四大特性</span><br><span class="line">    <span class="number">1.</span>基于请求响应</span><br><span class="line">    <span class="number">2.</span>基于TCP、IP作用于应用层之上</span><br><span class="line">    <span class="number">3.</span>无连接</span><br><span class="line">    <span class="number">4.</span>无状态</span><br><span class="line">        </span><br><span class="line">基于HTTP协议的通信无法记录客户端状态</span><br><span class="line">但是现在很多软件都需要记录用户的状态 为了解决这个问题</span><br><span class="line">发明了cookie session等一系列的技术</span><br><span class="line"></span><br><span class="line">cookie</span><br><span class="line">    保存在客户端浏览器上面的键值对数据</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    eg:当用户登录成功之后 浏览器保存用户的关键信息</span></span><br><span class="line"><span class="string">    以后访问的时候浏览器自动发送关键信息从而实现身份识别</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    关键型数据直接保存在浏览器上不安全</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span> </span><br><span class="line">session</span><br><span class="line">    保存在服务器上面的键值对数据(数据类型不固定)</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    eg:当用户登录成功之后 服务端返回给浏览器一个随机字符串</span></span><br><span class="line"><span class="string">    之后访问都将随机字符串发送给服务端</span></span><br><span class="line"><span class="string">    服务端内部做比对</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># session需要依赖于cookie才可以工作</span></span><br><span class="line">客户端浏览器可以保存服务端发送过来的cookie数据也可以选择拒绝</span><br></pre></td></tr></table></figure>

<h3 id="cookie操作"><a href="#cookie操作" class="headerlink" title="cookie操作"></a>cookie操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">视图函数返回的HttpResponse对象</span><br><span class="line"><span class="keyword">return</span> HttpResponse()</span><br><span class="line"><span class="keyword">return</span> render()</span><br><span class="line"><span class="keyword">return</span> redirect()</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">obj = HttpResponse()</span><br><span class="line"><span class="keyword">return</span> obj</span><br><span class="line">obj = render()</span><br><span class="line"><span class="keyword">return</span> obj</span><br><span class="line">obj = redirect()</span><br><span class="line"><span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用户登录</span></span><br><span class="line">    设置cookie</span><br><span class="line">        obj = HttpResponse(<span class="string">&quot;登录成功&quot;</span>)</span><br><span class="line">        obj.set_cookie(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;jason&#x27;</span>)</span><br><span class="line">    获取cookie</span><br><span class="line">        request.COOKIES.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    删除cookie</span><br><span class="line">        obj.delete_cookie(<span class="string">&quot;name&quot;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="session操作"><a href="#session操作" class="headerlink" title="session操作"></a>session操作</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">session设置</span><br><span class="line">    request.session[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&#x27;jason&#x27;</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    1.自动产生一个随机字符串</span></span><br><span class="line"><span class="string">    2.将随机字符串和数据存入django_session表中</span></span><br><span class="line"><span class="string">    3.将随机字符串返回给客户端浏览器保存</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">session读取</span><br><span class="line">    request.session.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    1.客户端请求中获取随机字符串</span></span><br><span class="line"><span class="string">    2.拿着随机字符串去django_session表中比对</span></span><br><span class="line"><span class="string">    3.如果比对成功获取对应的数据并且解析放到request.session中</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># django session默认的过期时间14d 可以人为修改</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除当前会话的所有Session数据</span></span><br><span class="line">    request.session.delete()  <span class="comment"># 只删客户端浏览器</span></span><br><span class="line">　　</span><br><span class="line"><span class="comment"># 删除当前的会话数据并删除会话的Cookie。</span></span><br><span class="line">    request.session.flush()  <span class="comment"># 客户端浏览器和服务端都删</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 设置会话Session和Cookie的超时时间</span></span><br><span class="line">    request.session.set_expiry(value)</span><br><span class="line">        * 如果value是个整数，session会在些秒数后失效。</span><br><span class="line">        * 如果value是个datatime或timedelta，session就会在这个时间后失效</span><br><span class="line">        * 如果value是<span class="number">0</span>,用户关闭浏览器session就会失效。</span><br><span class="line">        * 如果value是<span class="literal">None</span>,session会依赖全局session失效策略。</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8B%E4%B8%AD%E9%97%B4%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8B%E4%B8%AD%E9%97%B4%E4%BB%B6/" class="post-title-link" itemprop="url">Django基础之中间件</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-11 07:20:25" itemprop="dateCreated datePublished" datetime="2019-05-11T07:20:25+08:00">2019-05-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-06-01 12:22:34" itemprop="dateModified" datetime="2019-06-01T12:22:34+08:00">2019-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Django%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Django系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="内容概要"><a href="#内容概要" class="headerlink" title="内容概要"></a>内容概要</h1><ul>
<li>django中间件</li>
<li>csrf跨站请求伪造</li>
</ul>
<h1 id="内容详细"><a href="#内容详细" class="headerlink" title="内容详细"></a>内容详细</h1><h3 id="django中间件"><a href="#django中间件" class="headerlink" title="django中间件"></a>django中间件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">类似于是django的门户 请求来的时候和响应走的时候都必须经过它</span><br><span class="line"></span><br><span class="line">配置文件中</span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    ...</span><br><span class="line">]</span><br><span class="line"><span class="comment"># django默认有七个中间件</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;每个中间件你可以简单的理解为具有不同的功能&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># django中间件有五个我们需要知道的方法</span></span><br><span class="line">    需要掌握</span><br><span class="line">        process_request</span><br><span class="line">        process_response</span><br><span class="line">    需要了解</span><br><span class="line">        process_view</span><br><span class="line">        process_exception</span><br><span class="line">        process_template_response</span><br><span class="line"><span class="comment"># django支持用户自定义中间件</span></span><br><span class="line">    django中间件可以用于编写全局相关的功能</span><br><span class="line">        eg:全局身份校验  全局防爬校验 </span><br></pre></td></tr></table></figure>

<h3 id="中间件使用"><a href="#中间件使用" class="headerlink" title="中间件使用"></a>中间件使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMiddleware1</span>(<span class="params">MiddlewareMixin</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;from 自定义MyMiddleware1 process_request方法&#x27;</span>)</span><br><span class="line"><span class="comment"># 1.请求来的时候会依次(从上往下)执行配置文件中注册了的中间件里面的process_request方法 如果没有直接跳过</span></span><br><span class="line"><span class="comment"># 2.该方法如果直接返回了HttpResponse对象那么请求不再继续往下而是直接原路返回</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span>(<span class="params">self,request,response</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;from 自定义MyMiddleware1 process_response方法&#x27;</span>)</span><br><span class="line"><span class="comment"># 1.响应走的时候从下往上依次执行注册了的中间件里面的process_response方法如果没有则直接跳过</span></span><br><span class="line"><span class="comment"># 2.该方法需要将形参response返回 该response其实就是视图函数返回给浏览器的数据</span></span><br><span class="line"><span class="comment"># 3.该方法还可以拦截返回给浏览器的数据 并且还支持自定义返回内容</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">当process_request自己返回HttpResponse对象之后</span></span><br><span class="line"><span class="string">响应是从同级别的process_response依次返回</span></span><br><span class="line"><span class="string">而不是所有的process_response</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="了解方法"><a href="#了解方法" class="headerlink" title="了解方法"></a>了解方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">process_view</span><br><span class="line">    路由匹配成功之后执行视图函数之前自动触发</span><br><span class="line">    self,request,view_name,*args,**kwargs</span><br><span class="line"></span><br><span class="line">process_exception</span><br><span class="line">    当视图函数报错之后自动执行</span><br><span class="line">    self,request,exception</span><br><span class="line">   </span><br><span class="line">process_template_response</span><br><span class="line">    self,request,response</span><br><span class="line">    图函数返回的对象有一个response()方法（或者表明该对象是一个TemplateResponse对象或等价方法）</span><br></pre></td></tr></table></figure>

<h3 id="csrf跨站请求伪造"><a href="#csrf跨站请求伪造" class="headerlink" title="csrf跨站请求伪造"></a>csrf跨站请求伪造</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">钓鱼网站</span><br><span class="line"></span><br><span class="line">理论:</span><br><span class="line">    做一个与正规网站一模一样的界面 用户在上面操作</span><br><span class="line">    比如转账</span><br><span class="line">    转账请求确实是发送给了正规的网站后台只不过收款人变成了</span><br><span class="line">    钓鱼网站指定的账户</span><br><span class="line">原理:</span><br><span class="line">    获取用户输入的表单内</span><br><span class="line">    给用户展示了一个没有name属性的框</span><br><span class="line">    自己偷偷的写了一个既有name又有value的隐藏框</span><br></pre></td></tr></table></figure>

<h3 id="csrf使用"><a href="#csrf使用" class="headerlink" title="csrf使用"></a>csrf使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>form表单</span><br><span class="line">    表单中直接书写下列的语句即可</span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line"> </span><br><span class="line"><span class="number">2.</span>ajax</span><br><span class="line">    方式<span class="number">1</span>:借助于&#123;% csrf_token %&#125;生成的标签(不推荐)</span><br><span class="line">    $(<span class="string">&quot;[name = &#x27;csrfmiddlewaretoken&#x27;]&quot;</span>).val()</span><br><span class="line">    </span><br><span class="line">    方式<span class="number">2</span>:借助于模板语法直接获取</span><br><span class="line">    <span class="string">&#x27;&#123;&#123; csrf_token &#125;&#125;&#x27;</span></span><br><span class="line">    </span><br><span class="line">    方式<span class="number">3</span>:借助于官方提供的js文件自动获取</span><br><span class="line">    js文件导入即可</span><br></pre></td></tr></table></figure>

<h3 id="csrf相关装饰器"><a href="#csrf相关装饰器" class="headerlink" title="csrf相关装饰器"></a>csrf相关装饰器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.csrf <span class="keyword">import</span> csrf_exempt, csrf_protect</span><br><span class="line"><span class="comment"># csrf_exempt   局部不校验csrf</span></span><br><span class="line"><span class="comment"># csrf_protect  局部校验csrf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># @csrf_protect</span></span><br><span class="line"><span class="comment"># @csrf_exempt</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        username = request.POST.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        money = request.POST.get(<span class="string">&#x27;money&#x27;</span>)</span><br><span class="line">        target_user = request.POST.get(<span class="string">&#x27;target_user&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;%s 给 %s 转了 %s 元钱&#x27;</span>%(username,target_user,money))</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> views</span><br><span class="line"><span class="comment"># @method_decorator(csrf_protect,name=&#x27;post&#x27;)  # 第二种  行</span></span><br><span class="line"><span class="comment"># @method_decorator(csrf_exempt,name=&#x27;post&#x27;)  # 第二种  不行</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyLogin</span>(<span class="params">views.View</span>):</span></span><br><span class="line">    <span class="comment"># @method_decorator(csrf_protect)  # 第三种 所有的方法都会加上该功能</span></span><br><span class="line"><span class="meta">    @method_decorator(<span class="params">csrf_exempt</span>)  </span><span class="comment"># 第三种 所有的方法都会加上该功能</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().dispatch(request,*args,**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;from get&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># @method_decorator(csrf_protect)  # 第一种  行</span></span><br><span class="line">    <span class="comment"># @method_decorator(csrf_exempt)  # 第一种  不行</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&#x27;from post&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">csrf_exempt该装饰器在CBV中只能给dispatch装才能生效</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%A8%A1%E5%9E%8B%E5%B1%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%A8%A1%E5%9E%8B%E5%B1%82/" class="post-title-link" itemprop="url">Django基础之模型层</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-11 07:20:25" itemprop="dateCreated datePublished" datetime="2019-05-11T07:20:25+08:00">2019-05-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-06-01 12:22:34" itemprop="dateModified" datetime="2019-06-01T12:22:34+08:00">2019-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Django%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Django系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="内容概要"><a href="#内容概要" class="headerlink" title="内容概要"></a>内容概要</h1><ul>
<li><p>查询关键字</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">MySQL</span><br><span class="line">    select</span><br><span class="line">    <span class="keyword">from</span> </span><br><span class="line">    where</span><br><span class="line">    group by</span><br><span class="line">    having</span><br><span class="line">    order by</span><br><span class="line">    distinct</span><br><span class="line">    limit</span><br><span class="line">    regexp</span><br><span class="line">    <span class="comment"># SQL语句内也支持写流程控制</span></span><br><span class="line">Django ORM</span><br></pre></td></tr></table></figure></li>
<li><p>神奇的双下线查询</p>
</li>
<li><p>多表查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">子查询</span><br><span class="line">    基于对象的跨表查询</span><br><span class="line">连表操作</span><br><span class="line">    基于双下划线的跨表查询</span><br><span class="line">ps:ORM远比SQL语句简单</span><br></pre></td></tr></table></figure></li>
<li><p>分组与聚合</p>
</li>
<li><p>F与Q查询</p>
</li>
<li><p>ORM查询优化(only与defer…)</p>
</li>
<li><p>ORM字段补充</p>
</li>
</ul>
<h1 id="内容详细"><a href="#内容详细" class="headerlink" title="内容详细"></a>内容详细</h1><h3 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a>关键字</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"> 　　<span class="comment"># 增     1.create()</span></span><br><span class="line"><span class="comment"># models.Books.objects.create(title=&#x27;三国演义&#x27;,price=456.23)</span></span><br><span class="line"><span class="comment"># models.Books.objects.create(title=&#x27;水浒传&#x27;,price=876.45)</span></span><br><span class="line"><span class="comment"># models.Books.objects.create(title=&#x27;聊斋志异&#x27;,price=123.69)</span></span><br><span class="line"><span class="comment"># models.Books.objects.create(title=&#x27;草堂笔记&#x27;,price=456.96)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查     2.all()</span></span><br><span class="line"><span class="comment"># res = models.Books.objects.all()</span></span><br><span class="line"><span class="comment"># print(res)  # QuerySet对象</span></span><br><span class="line"><span class="comment"># print(res.query)  # 只要是QuerySet对象就可以点query查看内部SQL语句</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查     3.filter()</span></span><br><span class="line"><span class="comment"># res1 = models.Books.objects.filter()  # pk特指当前表的主键字段</span></span><br><span class="line"><span class="comment"># print(res1)  # QuerySet对象</span></span><br><span class="line"><span class="comment"># print(res1.query)</span></span><br><span class="line"><span class="comment"># print(res1.first())  # 获取列表中第一个数据对象</span></span><br><span class="line"><span class="comment"># print(res1.last())  # 获取列表中最后一个数据对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.values与5.values_list</span></span><br><span class="line"><span class="comment"># res2 = models.Books.objects.values(&#x27;title&#x27;,&#x27;price&#x27;)</span></span><br><span class="line"><span class="comment"># print(res2)  # QuerySet对象   可以看成列表套字典</span></span><br><span class="line"><span class="comment"># print(res2.query)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># res3 = models.Books.objects.values_list(&#x27;title&#x27;,&#x27;price&#x27;)</span></span><br><span class="line"><span class="comment"># print(res3)  # QuerySet对象     可以看成列表套元祖</span></span><br><span class="line"><span class="comment"># print(res3.query)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.查 get()     不推荐使用</span></span><br><span class="line"><span class="comment"># res4 = models.Books.objects.get(pk=1)</span></span><br><span class="line"><span class="comment"># print(res4)  # 数据对象</span></span><br><span class="line"><span class="comment"># res5 = models.Books.objects.get(pk=100)</span></span><br><span class="line"><span class="comment"># print(res5)  # 数据对象</span></span><br><span class="line"><span class="comment"># res6 = models.Books.objects.filter(pk=100)</span></span><br><span class="line"><span class="comment"># print(res6)  # 数据对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.取反  exclude()</span></span><br><span class="line"><span class="comment"># res7 = models.Books.objects.exclude(pk=1)</span></span><br><span class="line"><span class="comment"># print(res7)  # QuerySet</span></span><br><span class="line"><span class="comment"># print(res7.query)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8.排序   order_by()      默认是升序(asc)    字段前面加负号降序(desc)</span></span><br><span class="line"><span class="comment"># res8 = models.Books.objects.order_by(&#x27;price&#x27;)</span></span><br><span class="line"><span class="comment"># res8 = models.Books.objects.order_by(&#x27;-price&#x27;)</span></span><br><span class="line"><span class="comment"># select * from books order by price desc,price asc;</span></span><br><span class="line"><span class="comment"># res8 = models.Books.objects.order_by(&#x27;-price&#x27;,&#x27;price&#x27;)</span></span><br><span class="line"><span class="comment"># print(res8)  # QuerySet对象</span></span><br><span class="line"><span class="comment"># print(res8.query)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 9.反转  reverse()       必须先有顺序才可以反转</span></span><br><span class="line"><span class="comment"># res9 = models.Books.objects.all()</span></span><br><span class="line"><span class="comment"># res9 = models.Books.objects.order_by(&#x27;price&#x27;).reverse()</span></span><br><span class="line"><span class="comment"># print(res9)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 10.去重 distinct()</span></span><br><span class="line"><span class="comment"># res10 = models.Books.objects.all().distinct()</span></span><br><span class="line"><span class="comment"># res10 = models.Books.objects.values(&#x27;title&#x27;,&#x27;price&#x27;).distinct()</span></span><br><span class="line"><span class="comment"># print(res10)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 11.计数 count()</span></span><br><span class="line"><span class="comment"># res11 = models.Books.objects.count()</span></span><br><span class="line"><span class="comment"># print(res11)  # 6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 12.判断是否有数据   exists()</span></span><br><span class="line"><span class="comment"># res12 = models.Books.objects.filter(pk=999).exists()</span></span><br><span class="line"><span class="comment"># print(res12)  # False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 13.update()</span></span><br><span class="line"><span class="comment"># 14.delete()</span></span><br></pre></td></tr></table></figure>

<h3 id="神奇的双下划线"><a href="#神奇的双下划线" class="headerlink" title="神奇的双下划线"></a>神奇的双下划线</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">　　</span><br><span class="line"><span class="comment"># 查询价格大于200的书籍</span></span><br><span class="line">    <span class="comment"># res = models.Books.objects.filter(price__gt=200)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    <span class="comment"># res1 = models.Books.objects.filter(price__lt=200)</span></span><br><span class="line">    <span class="comment"># print(res1)</span></span><br><span class="line">    <span class="comment"># res2 = models.Books.objects.filter(price__gte=456.23)</span></span><br><span class="line">    <span class="comment"># print(res2)</span></span><br><span class="line">    <span class="comment"># res3 = models.Books.objects.filter(price__lte=456.23)</span></span><br><span class="line">    <span class="comment"># print(res3)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 成员运算</span></span><br><span class="line">    <span class="comment"># res4 = models.Books.objects.filter(price__in=(456.23,111))</span></span><br><span class="line">    <span class="comment"># print(res4)</span></span><br><span class="line">    <span class="comment"># 范围查询</span></span><br><span class="line">    <span class="comment"># res5 = models.Books.objects.filter(price__range=(100,456.23))</span></span><br><span class="line">    <span class="comment"># print(res5)</span></span><br><span class="line">    <span class="comment"># 模糊查询</span></span><br><span class="line">    <span class="comment"># 查询书籍名称中含有字母a的书</span></span><br><span class="line">    <span class="comment"># res6 = models.Books.objects.filter(title__contains=&#x27;a&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res6)  # 区分</span></span><br><span class="line">    <span class="comment"># res7 = models.Books.objects.filter(title__icontains=&#x27;a&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res7)  # 忽略</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 日期相关</span></span><br><span class="line">    <span class="comment"># 查看出版月份是五月的书</span></span><br><span class="line">    <span class="comment"># res8 = models.Books.objects.filter(publish_time__month=5)</span></span><br><span class="line">    <span class="comment"># print(res8)</span></span><br><span class="line">    <span class="comment"># print(res8.query)</span></span><br><span class="line">    <span class="comment"># res9 = models.Books.objects.filter(publish_time__year=2021)</span></span><br><span class="line">    <span class="comment"># print(res9)</span></span><br></pre></td></tr></table></figure>

<h3 id="外键字段增删改查"><a href="#外键字段增删改查" class="headerlink" title="外键字段增删改查"></a>外键字段增删改查</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 增</span></span><br><span class="line"><span class="comment"># models.Book.objects.create(title=&#x27;三国演义&#x27;,price=345.43,publish_id=1)</span></span><br><span class="line"><span class="comment"># models.Book.objects.create(title=&#x27;红楼梦&#x27;,price=678.31,publish_id=2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># publish_obj = models.Publish.objects.filter(pk=2).first()</span></span><br><span class="line"><span class="comment"># models.Book.objects.create(title=&#x27;三国演义&#x27;,price=345.43,publish=publish_obj)</span></span><br><span class="line"><span class="comment"># models.Book.objects.create(title=&#x27;七龙珠&#x27;,price=908.43,publish=publish_obj)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 改</span></span><br><span class="line"><span class="comment"># models.Book.objects.filter(pk=2).update(publish_id=1)</span></span><br><span class="line"><span class="comment"># models.Book.objects.filter(pk=2).update(publish=publish_obj)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删 级联更新级联删除</span></span><br><span class="line"><span class="comment"># models.Publish.objects.filter(pk=1).delete()</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多对多</span></span><br><span class="line"><span class="comment"># book_obj = models.Book.objects.filter(pk=3).first()</span></span><br><span class="line"><span class="comment"># 绑定关系</span></span><br><span class="line"><span class="comment"># book_obj.authors.add(1)  # 去书与作者的关系表中绑定关系</span></span><br><span class="line"><span class="comment"># book_obj.authors.add(1,2)  # 去书与作者的关系表中绑定关系</span></span><br><span class="line"><span class="comment"># book_obj.authors.add(author_obj1)</span></span><br><span class="line"><span class="comment"># book_obj.authors.add(author_obj1,author_obj2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改关系</span></span><br><span class="line"><span class="comment"># book_obj.authors.set([1,])</span></span><br><span class="line"><span class="comment"># book_obj.authors.set([1,2])</span></span><br><span class="line"><span class="comment"># book_obj.authors.set([author_obj,])</span></span><br><span class="line"><span class="comment"># book_obj.authors.set([author_obj1,author_obj2])</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 移除关系</span></span><br><span class="line"><span class="comment"># book_obj.authors.remove(1)</span></span><br><span class="line"><span class="comment"># book_obj.authors.remove(1,2)</span></span><br><span class="line"><span class="comment"># book_obj.authors.remove(author_obj,)</span></span><br><span class="line"><span class="comment"># book_obj.authors.remove(author_obj1,author_obj2)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清空关系</span></span><br><span class="line"><span class="comment"># book_obj.authors.clear()</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="重要概念"><a href="#重要概念" class="headerlink" title="重要概念"></a>重要概念</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 多表查询</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    正向查询</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    反向查询</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    当前查询对象是否含有外键字段</span></span><br><span class="line"><span class="string">        如果有就是正向</span></span><br><span class="line"><span class="string">        没有无则是反向</span></span><br><span class="line"><span class="string">    口诀:</span></span><br><span class="line"><span class="string">        正向查询按外键字段</span></span><br><span class="line"><span class="string">            多对多需要额外再加一个.all()</span></span><br><span class="line"><span class="string">            一对多和一对一不需要加</span></span><br><span class="line"><span class="string">        反向查询按表名小写</span></span><br><span class="line"><span class="string">            一对多与多对多</span></span><br><span class="line"><span class="string">                _set.all()</span></span><br><span class="line"><span class="string">            一对一</span></span><br><span class="line"><span class="string">                不需要加</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#####################基于对象的跨表查询#####################</span></span><br><span class="line">    <span class="comment"># 子查询:将一张表的查询结果当做另外一条SQL语句的条件(括号括起来)</span></span><br><span class="line">    <span class="comment"># 1.查询书籍主键为4的出版社名称</span></span><br><span class="line">    <span class="comment"># 先查询书籍对象</span></span><br><span class="line">    <span class="comment"># book_obj = models.Book.objects.filter(pk=4).first()</span></span><br><span class="line">    <span class="comment"># 外键字段在书这里 所以是正向查询</span></span><br><span class="line">    <span class="comment"># res = book_obj.publish</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    <span class="comment"># print(res.title)</span></span><br><span class="line">    <span class="comment"># print(res.addr)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.查询书籍主键为3的作者姓名</span></span><br><span class="line">    <span class="comment"># 先查询书籍对象</span></span><br><span class="line">    <span class="comment"># book_obj = models.Book.objects.filter(pk=3).first()</span></span><br><span class="line">    <span class="comment"># 外键字段在书这里 所以是正向查询</span></span><br><span class="line">    <span class="comment"># res = book_obj.authors</span></span><br><span class="line">    <span class="comment"># print(res)  # app01.Author.None</span></span><br><span class="line">    <span class="comment"># res = book_obj.authors.all()</span></span><br><span class="line">    <span class="comment"># print(res)  # &lt;QuerySet [&lt;Author: 作者对象:oscar&gt;, &lt;Author: 作者对象:egon&gt;]&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3.查询作者jason的地址</span></span><br><span class="line">    <span class="comment"># 先查询jason数据对象</span></span><br><span class="line">    <span class="comment"># author_obj = models.Author.objects.filter(name=&#x27;jason&#x27;).first()</span></span><br><span class="line">    <span class="comment"># 外键字段在作者这里 所以是正向查询</span></span><br><span class="line">    <span class="comment"># res = author_obj.author_detail</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    <span class="comment"># print(res.addr)</span></span><br><span class="line">    <span class="comment"># print(res.phone)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4.查询东方出版社出版的书籍</span></span><br><span class="line">    <span class="comment"># 先查询出版社对象</span></span><br><span class="line">    <span class="comment"># publish_obj = models.Publish.objects.filter(title=&#x27;东方出版社&#x27;).first()</span></span><br><span class="line">    <span class="comment"># 外键字段在书那里自己没有 所以是反向</span></span><br><span class="line">    <span class="comment"># res = publish_obj.book_set</span></span><br><span class="line">    <span class="comment"># print(res)  # app01.Book.None</span></span><br><span class="line">    <span class="comment"># res = publish_obj.book_set.all()</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5.查询jason写过的书籍</span></span><br><span class="line">    <span class="comment"># 先查询jason数据对象</span></span><br><span class="line">    <span class="comment"># author_obj = models.Author.objects.filter(name=&#x27;jason&#x27;).first()</span></span><br><span class="line">    <span class="comment"># 外键字段在书那里自己没有 所以是反向</span></span><br><span class="line">    <span class="comment"># res = author_obj.book_set</span></span><br><span class="line">    <span class="comment"># print(res)  # app01.Book.None</span></span><br><span class="line">    <span class="comment"># res = author_obj.book_set</span></span><br><span class="line">    <span class="comment"># print(res)  # app01.Book.None</span></span><br><span class="line">    <span class="comment"># res = author_obj.book_set.all()</span></span><br><span class="line">    <span class="comment"># print(res)  # app01.Book.None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6.查询电话是120的作者</span></span><br><span class="line">    <span class="comment"># 先查询120数据对象</span></span><br><span class="line">    <span class="comment"># author_detail_obj = models.AuthorDetail.objects.filter(phone=120).first()</span></span><br><span class="line">    <span class="comment"># 外键字段在作者那里本身没有 所以是反向</span></span><br><span class="line">    <span class="comment"># res = author_detail_obj.author</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    <span class="comment"># print(res.name)</span></span><br><span class="line">    <span class="comment"># print(res.age)</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">########################基于双下滑线的跨表查询</span></span><br><span class="line">    <span class="comment"># 1.查询书籍主键为4的出版社名称</span></span><br><span class="line">    <span class="comment"># res = models.Book.objects.filter(pk=4).values(&#x27;publish__title&#x27;,&#x27;publish__addr&#x27;,&#x27;title&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.查询书籍主键为3的作者姓名</span></span><br><span class="line">    <span class="comment"># res = models.Book.objects.filter(pk=3).values(&#x27;authors__name&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3.查询作者jason的地址</span></span><br><span class="line">    <span class="comment"># res = models.Author.objects.filter(name=&#x27;jason&#x27;).values(&#x27;author_detail__addr&#x27;,&#x27;name&#x27;,&#x27;age&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4.查询北方出版社出版的书籍名称</span></span><br><span class="line">    <span class="comment"># res = models.Publish.objects.filter(title=&#x27;北方出版社&#x27;).values(&#x27;book__title&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5.查询jason写过的书籍</span></span><br><span class="line">    <span class="comment"># res = models.Author.objects.filter(name=&#x27;jason&#x27;).values(&#x27;book__title&#x27;,&#x27;name&#x27;,&#x27;age&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6.查询电话是120的作者</span></span><br><span class="line">    <span class="comment"># res = models.AuthorDetail.objects.filter(phone=120).values(&#x27;author__name&#x27;,&#x27;author__age&#x27;,&#x27;addr&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">############进阶操作#############</span></span><br><span class="line">    <span class="comment"># 1.查询书籍主键为4的出版社名称</span></span><br><span class="line">    <span class="comment"># res = models.Book.objects.filter(pk=4).values(&#x27;publish__title&#x27;,&#x27;publish__addr&#x27;,&#x27;title&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    <span class="comment"># 反向查询高阶部分</span></span><br><span class="line">    <span class="comment"># res = models.Publish.objects.filter(book__pk=4)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2.查询书籍主键为3的作者姓名</span></span><br><span class="line">    <span class="comment"># res = models.Book.objects.filter(pk=3).values(&#x27;authors__name&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    <span class="comment"># 反向查询高阶部分</span></span><br><span class="line">    <span class="comment"># res = models.Author.objects.filter(book__pk=3)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3.查询作者jason的地址</span></span><br><span class="line">    <span class="comment"># res = models.Author.objects.filter(name=&#x27;jason&#x27;).values(&#x27;author_detail__addr&#x27;,&#x27;name&#x27;,&#x27;age&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line">    <span class="comment"># 反向查询高阶部分</span></span><br><span class="line">    <span class="comment"># res = models.AuthorDetail.objects.filter(author__name=&#x27;jason&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询书籍主键为3的作者的电话号码</span></span><br><span class="line">    <span class="comment"># res = models.Book.objects.filter(pk=3).values(&#x27;authors__author_detail__phone&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># res = models.AuthorDetail.objects.filter(author__book__pk=3).values(&#x27;phone&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># res = models.Author.objects.filter(book__pk=3).values(&#x27;author_detail__phone&#x27;)</span></span><br><span class="line">    <span class="comment"># print(res)</span></span><br></pre></td></tr></table></figure>

<h3 id="F查询"><a href="#F查询" class="headerlink" title="F查询"></a>F查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">　　 <span class="comment"># F查询</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line"><span class="comment"># 1.查询库存数大于卖出数的书籍</span></span><br><span class="line"><span class="comment"># res = models.Book.objects.filter(kucun__gt=F(&#x27;maichu&#x27;))</span></span><br><span class="line"><span class="comment"># print(res)</span></span><br><span class="line"><span class="comment"># 2.将所有的书籍价格上涨100块</span></span><br><span class="line"><span class="comment"># res = models.Book.objects.update(price=F(&#x27;price&#x27;) + 100)</span></span><br><span class="line"><span class="comment"># print(res)</span></span><br><span class="line"><span class="comment"># 3.将所有的书籍名称加上&quot;爆款&quot;后缀</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;针对字符串不能直接拼接 需要额外导入模块操作&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># models.Book.objects.update(title=F(&#x27;title&#x27;) + &#x27;爆款&#x27;)</span></span><br><span class="line"><span class="comment"># from django.db.models.functions import Concat</span></span><br><span class="line"><span class="comment"># from django.db.models import Value</span></span><br><span class="line"><span class="comment"># ret3 = models.Book.objects.update(title=Concat(F(&#x27;title&#x27;), Value(&#x27;爆款&#x27;)))</span></span><br></pre></td></tr></table></figure>

<h3 id="Q查询"><a href="#Q查询" class="headerlink" title="Q查询"></a>Q查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">　　 <span class="comment"># 1.查询书名是三国演义爆款或者库存是100的书籍</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;filter()括号内可以写多个参数 逗号隔开  默认只支持and连接&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"><span class="comment"># res = models.Book.objects.filter(title=&#x27;三国演义爆款&#x27;,kucun=100)</span></span><br><span class="line"><span class="comment"># print(res)</span></span><br><span class="line"><span class="comment"># res1 = models.Book.objects.filter(Q(title=&#x27;三国演义爆款&#x27;),Q(kucun=100))  # and</span></span><br><span class="line"><span class="comment"># res1 = models.Book.objects.filter(Q(title=&#x27;三国演义爆款&#x27;)|Q(kucun=100))  # or</span></span><br><span class="line"><span class="comment"># res1 = models.Book.objects.filter(~Q(title=&#x27;三国演义爆款&#x27;)|Q(kucun=100))  # not</span></span><br><span class="line"><span class="comment"># print(res1.query)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;Q进阶用法&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># condition = input(&#x27;请输入你需要按照什么字段查询数据&gt;&gt;&gt;:&#x27;)</span></span><br><span class="line"><span class="comment"># data = input(&#x27;请输入你需要查询的数据名称&gt;&gt;&gt;:&#x27;)</span></span><br><span class="line"><span class="comment"># q = Q()  # 生成一个Q对象</span></span><br><span class="line"><span class="comment"># q.children.append((condition,data))</span></span><br><span class="line"><span class="comment"># res = models.Book.objects.filter(q)</span></span><br><span class="line"><span class="comment"># print(res)</span></span><br><span class="line">q = Q()</span><br><span class="line">q.connector = <span class="string">&#x27;or&#x27;</span>  <span class="comment"># 可以修改连接条件</span></span><br><span class="line">q.children.append((<span class="string">&#x27;title__contains&#x27;</span>,<span class="string">&#x27;三&#x27;</span>))</span><br><span class="line">q.children.append((<span class="string">&#x27;price__gt&#x27;</span>,<span class="number">200</span>))  <span class="comment"># 可以添加多个条件 并且也是and关系</span></span><br><span class="line">res = models.Book.objects.<span class="built_in">filter</span>(q)</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"><span class="built_in">print</span>(res.query)</span><br></pre></td></tr></table></figure>

<h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1.事务四大特性    ACID</span></span><br><span class="line"><span class="string">    原子性</span></span><br><span class="line"><span class="string">    一致性</span></span><br><span class="line"><span class="string">    独立性</span></span><br><span class="line"><span class="string">    持久性</span></span><br><span class="line"><span class="string">2.数据库设计三大范式</span></span><br><span class="line"><span class="string">    课下百度搜索自己概括</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL</span></span><br><span class="line"><span class="string">    start transcation</span></span><br><span class="line"><span class="string">    commit</span></span><br><span class="line"><span class="string">    rollback</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> transaction.atomic():</span><br><span class="line">            <span class="comment"># 创建一条订单数据</span></span><br><span class="line">            models.Order.objects.create(num=<span class="string">&quot;110110111&quot;</span>, product_id=<span class="number">1</span>, count=<span class="number">1</span>)</span><br><span class="line">            <span class="comment"># 能执行成功</span></span><br><span class="line">            models.Product.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=<span class="number">1</span>).update(kucun=F(<span class="string">&quot;kucun&quot;</span>) - <span class="number">1</span>, maichu=F(<span class="string">&quot;maichu&quot;</span>) + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(e)</span><br></pre></td></tr></table></figure>

<h3 id="执行原生SQL语句"><a href="#执行原生SQL语句" class="headerlink" title="执行原生SQL语句"></a>执行原生SQL语句</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">res = models.Book.objects.raw(<span class="string">&#x27;select * from app01_book&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<h3 id="模型层字段及参数"><a href="#模型层字段及参数" class="headerlink" title="模型层字段及参数"></a>模型层字段及参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">models.CharField(max_length=<span class="number">32</span>)         <span class="comment"># varchar(32)</span></span><br><span class="line">models.IntergeField()                   <span class="comment"># int()</span></span><br><span class="line">models.DateField()                      <span class="comment"># date</span></span><br><span class="line">models.DateTimeField()                  <span class="comment"># datetime</span></span><br><span class="line">    auto_now</span><br><span class="line">    auto_now_add</span><br><span class="line">models.DecimalField()                   <span class="comment"># float()</span></span><br><span class="line">models.BooleanField()</span><br><span class="line">    给这个字段传布尔值会自动转换成数字<span class="number">0</span>或<span class="number">1</span></span><br><span class="line">    一般用在状态二选一</span><br><span class="line">TextField()</span><br><span class="line">     存储大段文本(bbs项目会使用)</span><br><span class="line">EmailField()</span><br><span class="line">    存储邮箱格式数据</span><br><span class="line">FileField()</span><br><span class="line">    存储数据路径(bbs项目会使用)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;自定义字段&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Field</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCharField</span>(<span class="params">Field</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self,max_length,*args,**kwargs</span>):</span></span><br><span class="line">        self.max_length = max_length</span><br><span class="line">        <span class="built_in">super</span>().__init__(max_length=max_length,*args,**kwargs)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">db_type</span>(<span class="params">self, connection</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;char(%s)&#x27;</span>%self.max_length </span><br></pre></td></tr></table></figure>

<h3 id="常见参数"><a href="#常见参数" class="headerlink" title="常见参数"></a>常见参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">max_length</span><br><span class="line">varbose_name</span><br><span class="line">default</span><br><span class="line">null</span><br><span class="line">auto_now</span><br><span class="line">auto_now_add</span><br><span class="line">to</span><br><span class="line">unique</span><br><span class="line">db_index</span><br><span class="line">choices</span><br><span class="line"></span><br><span class="line"><span class="comment"># choices参数</span></span><br><span class="line">创建用户表</span><br><span class="line">    性别</span><br><span class="line">        两到三种状态</span><br><span class="line">    学历</span><br><span class="line">        也是有限个</span><br><span class="line">    在职状态</span><br><span class="line">        也是有限个</span><br><span class="line">    婚姻</span><br><span class="line">        也是有限个</span><br><span class="line">    ...</span><br><span class="line"><span class="string">&quot;&quot;&quot;针对某个字段可以列举完全的情况 一般都是使用choices参数&quot;&quot;&quot;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    host = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    status_choices = (</span><br><span class="line">        (<span class="number">1</span>,<span class="string">&#x27;在线&#x27;</span>),</span><br><span class="line">        (<span class="number">2</span>,<span class="string">&#x27;待上线&#x27;</span>),</span><br><span class="line">        (<span class="number">3</span>,<span class="string">&#x27;宕机&#x27;</span>),</span><br><span class="line">        (<span class="number">4</span>,<span class="string">&#x27;待上架&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line">    status = models.IntegerField(choices=status_choices)</span><br><span class="line"></span><br><span class="line">    desc_choices = (</span><br><span class="line">        (<span class="string">&#x27;哈哈&#x27;</span>,<span class="string">&#x27;哈哈哈哈哈哈&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;呵呵&#x27;</span>,<span class="string">&#x27;呵呵呵呵呵呵&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;嘿嘿&#x27;</span>,<span class="string">&#x27;嘿嘿嘿嘿嘿嘿&#x27;</span>),</span><br><span class="line">        (<span class="string">&#x27;嘻嘻&#x27;</span>,<span class="string">&#x27;嘻嘻嘻嘻嘻嘻&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line">    desc = models.CharField(max_length=<span class="number">32</span>,choices=desc_choices)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取对应关系</span></span><br><span class="line">.get_字段名_display()</span><br></pre></td></tr></table></figure>



<h3 id="ORM查询优化"><a href="#ORM查询优化" class="headerlink" title="ORM查询优化"></a>ORM查询优化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 惰性查询</span></span><br><span class="line">    用不到的数据即使写了orm语句也不会执行</span><br><span class="line"><span class="number">1.</span>only与defer</span><br><span class="line"><span class="number">2.</span>select_related与prefech_related</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.only与defer</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># res = models.Book.objects.values(&#x27;title&#x27;)  # 列表套字典</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># res1 = models.Book.objects.only(&#x27;title&#x27;)  # 列表套对象</span></span><br><span class="line">    <span class="comment"># print(res1)</span></span><br><span class="line">    <span class="comment"># for i in res1:</span></span><br><span class="line">    <span class="comment">#     # print(i.title)</span></span><br><span class="line">    <span class="comment">#     print(i.price)</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    only括号内写什么字段</span></span><br><span class="line"><span class="string">        生成的对象就含有对应的属性 在查找该属性的时候不再走数据库查询</span></span><br><span class="line"><span class="string">        但是一旦查找括号内没有的字段属性 则每次都会走数据库查询</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># res1 = models.Book.objects.defer(&#x27;title&#x27;)</span></span><br><span class="line">    <span class="comment"># # print(res1)  # 列表套对象</span></span><br><span class="line">    <span class="comment"># for i in res1:</span></span><br><span class="line">    <span class="comment">#     # print(i.title)</span></span><br><span class="line">    <span class="comment">#     print(i.title)</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    defer与only刚好相反</span></span><br><span class="line"><span class="string">        生成的对象就不含有对应的属性 在查找该属性的时候需要每次走数据库查询</span></span><br><span class="line"><span class="string">        但是一旦查找括号内没有的字段属性 则不需要走数据库查询</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># res = models.Book.objects.filter(pk=3).first()</span></span><br><span class="line">    <span class="comment"># print(res.publish.title)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># res = models.Book.objects.select_related(&#x27;publish&#x27;)</span></span><br><span class="line">    <span class="comment"># for i in res:</span></span><br><span class="line">    <span class="comment">#     print(i.publish.title)</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    select_related相当于连表操作</span></span><br><span class="line"><span class="string">        先将models后面的表和括号内外键字段关联的表连接起来</span></span><br><span class="line"><span class="string">        之后一次性把所有的数据封装到数据对象中</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    res = models.Book.objects.prefetch_related(<span class="string">&#x27;publish&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">        <span class="built_in">print</span>(i.publish.title)</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    prefetch_related相当于子查询</span></span><br><span class="line"><span class="string">        先查询models后面的表的所有的数据</span></span><br><span class="line"><span class="string">        然后将括号内关联的表的数据全部查询出来</span></span><br><span class="line"><span class="string">        之后整合到一起</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>



<h3 id="常用及非常用字段"><a href="#常用及非常用字段" class="headerlink" title="常用及非常用字段"></a>常用及非常用字段</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">AutoField(Field)</span><br><span class="line">- <span class="built_in">int</span>自增列，必须填入参数 primary_key=<span class="literal">True</span></span><br><span class="line"></span><br><span class="line">BigAutoField(AutoField)</span><br><span class="line">- bigint自增列，必须填入参数 primary_key=<span class="literal">True</span></span><br><span class="line"></span><br><span class="line">注：当model中如果没有自增列，则自动会创建一个列名为<span class="built_in">id</span>的列</span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span>(<span class="params">models.Model</span>):</span></span><br><span class="line"><span class="comment"># 自动创建一个列名为id的且为自增的整数列</span></span><br><span class="line">username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Group</span>(<span class="params">models.Model</span>):</span></span><br><span class="line"><span class="comment"># 自定义自增列</span></span><br><span class="line">nid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">SmallIntegerField(IntegerField):</span><br><span class="line">- 小整数 -<span class="number">32768</span> ～ <span class="number">32767</span></span><br><span class="line"></span><br><span class="line">PositiveSmallIntegerField(PositiveIntegerRelDbTypeMixin, IntegerField)</span><br><span class="line">- 正小整数 <span class="number">0</span> ～ <span class="number">32767</span></span><br><span class="line">IntegerField(Field)</span><br><span class="line">- 整数列(有符号的) -<span class="number">2147483648</span> ～ <span class="number">2147483647</span></span><br><span class="line"></span><br><span class="line">PositiveIntegerField(PositiveIntegerRelDbTypeMixin, IntegerField)</span><br><span class="line">- 正整数 <span class="number">0</span> ～ <span class="number">2147483647</span></span><br><span class="line"></span><br><span class="line">BigIntegerField(IntegerField):</span><br><span class="line">- 长整型(有符号的) -<span class="number">9223372036854775808</span> ～ <span class="number">9223372036854775807</span></span><br><span class="line"></span><br><span class="line">BooleanField(Field)</span><br><span class="line">- 布尔值类型</span><br><span class="line"></span><br><span class="line">NullBooleanField(Field):</span><br><span class="line">- 可以为空的布尔值</span><br><span class="line"></span><br><span class="line">CharField(Field)</span><br><span class="line">- 字符类型</span><br><span class="line">- 必须提供max_length参数， max_length表示字符长度</span><br><span class="line"></span><br><span class="line">TextField(Field)</span><br><span class="line">- 文本类型</span><br><span class="line"></span><br><span class="line">EmailField(CharField)：</span><br><span class="line">- 字符串类型，Django Admin以及ModelForm中提供验证机制</span><br><span class="line"></span><br><span class="line">IPAddressField(Field)</span><br><span class="line">- 字符串类型，Django Admin以及ModelForm中提供验证 IPV4 机制</span><br><span class="line"></span><br><span class="line">GenericIPAddressField(Field)</span><br><span class="line">- 字符串类型，Django Admin以及ModelForm中提供验证 Ipv4和Ipv6</span><br><span class="line">- 参数：</span><br><span class="line">protocol，用于指定Ipv4或Ipv6， <span class="string">&#x27;both&#x27;</span>,<span class="string">&quot;ipv4&quot;</span>,<span class="string">&quot;ipv6&quot;</span></span><br><span class="line">unpack_ipv4， 如果指定为<span class="literal">True</span>，则输入::ffff:<span class="number">192.0</span><span class="number">.2</span><span class="number">.1</span>时候，可解析为<span class="number">192.0</span><span class="number">.2</span><span class="number">.1</span>，开启此功能，需要protocol=<span class="string">&quot;both&quot;</span></span><br><span class="line"></span><br><span class="line">URLField(CharField)</span><br><span class="line">- 字符串类型，Django Admin以及ModelForm中提供验证 URL</span><br><span class="line"></span><br><span class="line">SlugField(CharField)</span><br><span class="line">- 字符串类型，Django Admin以及ModelForm中提供验证支持 字母、数字、下划线、连接符（减号）</span><br><span class="line"></span><br><span class="line">CommaSeparatedIntegerField(CharField)</span><br><span class="line">- 字符串类型，格式必须为逗号分割的数字</span><br><span class="line"></span><br><span class="line">UUIDField(Field)</span><br><span class="line">- 字符串类型，Django Admin以及ModelForm中提供对UUID格式的验证</span><br><span class="line"></span><br><span class="line">FilePathField(Field)</span><br><span class="line">- 字符串，Django Admin以及ModelForm中提供读取文件夹下文件的功能</span><br><span class="line">- 参数：</span><br><span class="line">path,                      文件夹路径</span><br><span class="line">match=<span class="literal">None</span>,                正则匹配</span><br><span class="line">recursive=<span class="literal">False</span>,           递归下面的文件夹</span><br><span class="line">allow_files=<span class="literal">True</span>,          允许文件</span><br><span class="line">allow_folders=<span class="literal">False</span>,       允许文件夹</span><br><span class="line"></span><br><span class="line">FileField(Field)</span><br><span class="line">- 字符串，路径保存在数据库，文件上传到指定目录</span><br><span class="line">- 参数：</span><br><span class="line">upload_to = <span class="string">&quot;&quot;</span>      上传文件的保存路径</span><br><span class="line">storage = <span class="literal">None</span>      存储组件，默认django.core.files.storage.FileSystemStorage</span><br><span class="line"></span><br><span class="line">ImageField(FileField)</span><br><span class="line">- 字符串，路径保存在数据库，文件上传到指定目录</span><br><span class="line">- 参数：</span><br><span class="line">upload_to = <span class="string">&quot;&quot;</span>      上传文件的保存路径</span><br><span class="line">storage = <span class="literal">None</span>      存储组件，默认django.core.files.storage.FileSystemStorage</span><br><span class="line">width_field=<span class="literal">None</span>,   上传图片的高度保存的数据库字段名（字符串）</span><br><span class="line">height_field=<span class="literal">None</span>   上传图片的宽度保存的数据库字段名（字符串）</span><br><span class="line"></span><br><span class="line">DateTimeField(DateField)</span><br><span class="line">- 日期+时间格式 YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ]</span><br><span class="line"></span><br><span class="line">DateField(DateTimeCheckMixin, Field)</span><br><span class="line">- 日期格式      YYYY-MM-DD</span><br><span class="line"></span><br><span class="line">TimeField(DateTimeCheckMixin, Field)</span><br><span class="line">- 时间格式      HH:MM[:ss[.uuuuuu]]</span><br><span class="line"></span><br><span class="line">DurationField(Field)</span><br><span class="line">- 长整数，时间间隔，数据库中按照bigint存储，ORM中获取的值为datetime.timedelta类型</span><br><span class="line"></span><br><span class="line">FloatField(Field)</span><br><span class="line">- 浮点型</span><br><span class="line"></span><br><span class="line">DecimalField(Field)</span><br><span class="line">- <span class="number">10</span>进制小数</span><br><span class="line">- 参数：</span><br><span class="line">max_digits，小数总长度</span><br><span class="line">decimal_places，小数位长度</span><br><span class="line"></span><br><span class="line">BinaryField(Field)</span><br><span class="line">- 二进制类型</span><br></pre></td></tr></table></figure>



<h4 id="对应关系"><a href="#对应关系" class="headerlink" title="对应关系"></a>对应关系</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">对应关系：</span><br><span class="line">    <span class="string">&#x27;AutoField&#x27;</span>: <span class="string">&#x27;integer AUTO_INCREMENT&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BigAutoField&#x27;</span>: <span class="string">&#x27;bigint AUTO_INCREMENT&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BinaryField&#x27;</span>: <span class="string">&#x27;longblob&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BooleanField&#x27;</span>: <span class="string">&#x27;bool&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;CharField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;CommaSeparatedIntegerField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DateField&#x27;</span>: <span class="string">&#x27;date&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DateTimeField&#x27;</span>: <span class="string">&#x27;datetime&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DecimalField&#x27;</span>: <span class="string">&#x27;numeric(%(max_digits)s, %(decimal_places)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;DurationField&#x27;</span>: <span class="string">&#x27;bigint&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;FileField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;FilePathField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;FloatField&#x27;</span>: <span class="string">&#x27;double precision&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;IntegerField&#x27;</span>: <span class="string">&#x27;integer&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;BigIntegerField&#x27;</span>: <span class="string">&#x27;bigint&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;IPAddressField&#x27;</span>: <span class="string">&#x27;char(15)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;GenericIPAddressField&#x27;</span>: <span class="string">&#x27;char(39)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;NullBooleanField&#x27;</span>: <span class="string">&#x27;bool&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;OneToOneField&#x27;</span>: <span class="string">&#x27;integer&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PositiveIntegerField&#x27;</span>: <span class="string">&#x27;integer UNSIGNED&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;PositiveSmallIntegerField&#x27;</span>: <span class="string">&#x27;smallint UNSIGNED&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SlugField&#x27;</span>: <span class="string">&#x27;varchar(%(max_length)s)&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;SmallIntegerField&#x27;</span>: <span class="string">&#x27;smallint&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;TextField&#x27;</span>: <span class="string">&#x27;longtext&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;TimeField&#x27;</span>: <span class="string">&#x27;time&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;UUIDField&#x27;</span>: <span class="string">&#x27;char(32)&#x27;</span>,</span><br></pre></td></tr></table></figure>



<h3 id="ORM字段参数"><a href="#ORM字段参数" class="headerlink" title="ORM字段参数"></a>ORM字段参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### null</span></span><br><span class="line"></span><br><span class="line">用于表示某个字段可以为空。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### **unique**</span></span><br><span class="line"></span><br><span class="line">如果设置为unique=<span class="literal">True</span> 则该字段在此表中必须是唯一的 。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### **db_index**</span></span><br><span class="line"></span><br><span class="line">如果db_index=<span class="literal">True</span> 则代表着为此字段设置索引。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### **default**</span></span><br><span class="line"></span><br><span class="line">为该字段设置默认值。</span><br><span class="line"></span><br><span class="line"><span class="comment">###  DateField和DateTimeField</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### auto_now_add</span></span><br><span class="line"></span><br><span class="line">配置auto_now_add=<span class="literal">True</span>，创建数据记录的时候会把当前时间添加到数据库。</span><br><span class="line"></span><br><span class="line"><span class="comment">#### auto_now</span></span><br><span class="line"></span><br><span class="line">配置上auto_now=<span class="literal">True</span>，每次更新数据记录的时候会更新该字段。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">null                数据库中字段是否可以为空</span><br><span class="line">db_column           数据库中字段的列名</span><br><span class="line">db_tablespace</span><br><span class="line">default             数据库中字段的默认值</span><br><span class="line">primary_key         数据库中字段是否为主键</span><br><span class="line">db_index            数据库中字段是否可以建立索引</span><br><span class="line">unique              数据库中字段是否可以建立唯一索引</span><br><span class="line">unique_for_date     数据库中字段【日期】部分是否可以建立唯一索引</span><br><span class="line">unique_for_month    数据库中字段【月】部分是否可以建立唯一索引</span><br><span class="line">unique_for_year     数据库中字段【年】部分是否可以建立唯一索引</span><br><span class="line"></span><br><span class="line">verbose_name        Admin中显示的字段名称</span><br><span class="line">blank               Admin中是否允许用户输入为空</span><br><span class="line">editable            Admin中是否可以编辑</span><br><span class="line">help_text           Admin中该字段的提示信息</span><br><span class="line">choices             Admin中显示选择框的内容，用不变动的数据放在内存中从而避免跨表操作</span><br><span class="line">如：gf = models.IntegerField(choices=[(<span class="number">0</span>, <span class="string">&#x27;何穗&#x27;</span>),(<span class="number">1</span>, <span class="string">&#x27;大表姐&#x27;</span>),],default=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">error_messages      自定义错误信息（字典类型），从而定制想要显示的错误信息；</span><br><span class="line">字典健：null, blank, invalid, invalid_choice, unique, <span class="keyword">and</span> unique_for_date</span><br><span class="line">如：&#123;<span class="string">&#x27;null&#x27;</span>: <span class="string">&quot;不能为空.&quot;</span>, <span class="string">&#x27;invalid&#x27;</span>: <span class="string">&#x27;格式错误&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">validators          自定义错误验证（列表类型），从而定制想要的验证规则</span><br><span class="line"><span class="keyword">from</span> django.core.validators <span class="keyword">import</span> RegexValidator</span><br><span class="line"><span class="keyword">from</span> django.core.validators <span class="keyword">import</span> EmailValidator,URLValidator,DecimalValidator,\</span><br><span class="line">MaxLengthValidator,MinLengthValidator,MaxValueValidator,MinValueValidator</span><br><span class="line">如：</span><br><span class="line">test = models.CharField(</span><br><span class="line">max_length=<span class="number">32</span>,</span><br><span class="line">error_messages=&#123;</span><br><span class="line"><span class="string">&#x27;c1&#x27;</span>: <span class="string">&#x27;优先错信息1&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;c2&#x27;</span>: <span class="string">&#x27;优先错信息2&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;c3&#x27;</span>: <span class="string">&#x27;优先错信息3&#x27;</span>,</span><br><span class="line">&#125;,</span><br><span class="line">validators=[</span><br><span class="line">RegexValidator(regex=<span class="string">&#x27;root_\d+&#x27;</span>, message=<span class="string">&#x27;错误了&#x27;</span>, code=<span class="string">&#x27;c1&#x27;</span>),</span><br><span class="line">RegexValidator(regex=<span class="string">&#x27;root_112233\d+&#x27;</span>, message=<span class="string">&#x27;又错误了&#x27;</span>, code=<span class="string">&#x27;c2&#x27;</span>),</span><br><span class="line">EmailValidator(message=<span class="string">&#x27;又错误了&#x27;</span>, code=<span class="string">&#x27;c3&#x27;</span>), ]</span><br><span class="line">                            )</span><br></pre></td></tr></table></figure>



<h2 id="关系字段"><a href="#关系字段" class="headerlink" title="关系字段"></a>关系字段</h2><h3 id="ForeignKey"><a href="#ForeignKey" class="headerlink" title="ForeignKey"></a>ForeignKey</h3><p>外键类型在ORM中用来表示外键关联关系，一般把ForeignKey字段设置在 ‘一对多’中’多’的一方。</p>
<p>ForeignKey可以和其他表做关联关系同时也可以和自身做关联关系。</p>
<h4 id="to"><a href="#to" class="headerlink" title="to"></a>to</h4><p>设置要关联的表</p>
<h4 id="to-field"><a href="#to-field" class="headerlink" title="to_field"></a>to_field</h4><p>设置要关联的表的字段</p>
<h4 id="related-name"><a href="#related-name" class="headerlink" title="related_name"></a>related_name</h4><p>反向操作时，使用的字段名，用于代替原反向查询时的’表名_set’。</p>
<p>例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Classes</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    theclass = models.ForeignKey(to=<span class="string">&quot;Classes&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>当我们要查询某个班级关联的所有学生（反向查询）时，我们会这么写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">models.Classes.objects.first().student_set.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<p>当我们在ForeignKey字段中添加了参数 related_name 后，</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    theclass = models.ForeignKey(to=<span class="string">&quot;Classes&quot;</span>, related_name=<span class="string">&quot;students&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>当我们要查询某个班级关联的所有学生（反向查询）时，我们会这么写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">models.Classes.objects.first().students.<span class="built_in">all</span>()</span><br></pre></td></tr></table></figure>

<h4 id="related-query-name"><a href="#related-query-name" class="headerlink" title="related_query_name"></a><strong>related_query_name</strong></h4><p>反向查询操作时，使用的连接前缀，用于替换表名。</p>
<h4 id="on-delete"><a href="#on-delete" class="headerlink" title="on_delete"></a><strong>on_delete</strong></h4><p>　　当删除关联表中的数据时，当前表与其关联的行的行为。</p>
<p>　　<strong>models.CASCADE</strong><br>　　删除关联数据，与之关联也删除</p>
<p>　　<strong>models.DO_NOTHING</strong><br>　　删除关联数据，引发错误IntegrityError</p>
<p>　　<strong>models.PROTECT</strong><br>　　删除关联数据，引发错误ProtectedError</p>
<p>　　<strong>models.SET_NULL</strong><br>　　删除关联数据，与之关联的值设置为null（前提FK字段需要设置为可空）</p>
<p>　　<strong>models.SET_DEFAULT</strong><br>　　删除关联数据，与之关联的值设置为默认值（前提FK字段需要设置默认值）</p>
<p>　　<strong>models.SET</strong></p>
<p>　　删除关联数据，<br>　　a. 与之关联的值设置为指定值，设置：models.SET(值)<br>　　b. 与之关联的值设置为可执行对象的返回值，设置：models.SET(可执行对象)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyModel</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    user = models.ForeignKey(</span><br><span class="line">        to=<span class="string">&quot;User&quot;</span>,</span><br><span class="line">        to_field=<span class="string">&quot;id&quot;</span>，</span><br><span class="line">        on_delete=models.SET(func)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>

<h4 id="db-constraint"><a href="#db-constraint" class="headerlink" title="db_constraint"></a>db_constraint</h4><p>是否在数据库中创建外键约束，默认为True。</p>
<h3 id="OneToOneField"><a href="#OneToOneField" class="headerlink" title="OneToOneField"></a>OneToOneField</h3><p>一对一字段。</p>
<p>通常一对一字段用来扩展已有字段。</p>
<p>一对一的关联关系多用在当一张表的不同字段查询频次差距过大的情况下，将本可以存储在一张表的字段拆开放置在两张表中，然后将两张表建立一对一的关联关系。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    info = models.OneToOneField(to=<span class="string">&#x27;AuthorInfo&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorInfo</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    phone = models.CharField(max_length=<span class="number">11</span>)</span><br><span class="line">    email = models.EmailField()</span><br></pre></td></tr></table></figure>

<h4 id="to-1"><a href="#to-1" class="headerlink" title="to"></a>to</h4><p>设置要关联的表。</p>
<h4 id="to-field-1"><a href="#to-field-1" class="headerlink" title="to_field"></a>to_field</h4><p>设置要关联的字段。</p>
<h4 id="on-delete-1"><a href="#on-delete-1" class="headerlink" title="on_delete"></a>on_delete</h4><p>同ForeignKey字段。</p>
<h3 id="ManyToManyField"><a href="#ManyToManyField" class="headerlink" title="ManyToManyField"></a>ManyToManyField</h3><p>用于表示多对多的关联关系。在数据库中通过第三张表来建立关联关系</p>
<h4 id="to-2"><a href="#to-2" class="headerlink" title="to"></a>to</h4><p>设置要关联的表</p>
<h4 id="related-name-1"><a href="#related-name-1" class="headerlink" title="related_name"></a>related_name</h4><p>同ForeignKey字段。</p>
<h4 id="related-query-name-1"><a href="#related-query-name-1" class="headerlink" title="related_query_name"></a>related_query_name</h4><p>同ForeignKey字段。</p>
<h4 id="symmetrical"><a href="#symmetrical" class="headerlink" title="symmetrical"></a>symmetrical</h4><p>仅用于多对多自关联时，指定内部是否创建反向操作的字段。默认为True。</p>
<p>举个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">16</span>)</span><br><span class="line">    friends = models.ManyToManyField(<span class="string">&quot;self&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>此时，person对象就没有person_set属性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(max_length=<span class="number">16</span>)</span><br><span class="line">    friends = models.ManyToManyField(<span class="string">&quot;self&quot;</span>, symmetrical=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>此时，person对象现在就可以使用person_set属性进行反向查询。</p>
<h4 id="through"><a href="#through" class="headerlink" title="through"></a>through</h4><p>在使用ManyToManyField字段时，Django将自动生成一张表来管理多对多的关联关系。</p>
<p>但我们也可以手动创建第三张表来管理多对多关系，此时就需要通过through来指定第三张表的表名。</p>
<h4 id="through-fields"><a href="#through-fields" class="headerlink" title="through_fields"></a><strong>through_fields</strong></h4><p>设置关联的字段。</p>
<h4 id="db-table"><a href="#db-table" class="headerlink" title="db_table"></a>db_table</h4><p>默认创建第三张表时，数据库中表的名称。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%A8%A1%E6%9D%BF%E5%B1%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8B%E6%A8%A1%E6%9D%BF%E5%B1%82/" class="post-title-link" itemprop="url">Django基础之模板层</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-11 07:20:25" itemprop="dateCreated datePublished" datetime="2019-05-11T07:20:25+08:00">2019-05-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-06-01 12:22:34" itemprop="dateModified" datetime="2019-06-01T12:22:34+08:00">2019-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Django%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Django系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="内容概要"><a href="#内容概要" class="headerlink" title="内容概要"></a>内容概要</h1><ul>
<li><p>模板层(模板语法)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">模板语法传值</span><br><span class="line"></span><br><span class="line">模板语法过滤器(内置方法)</span><br><span class="line"></span><br><span class="line">模板语法标签(流程控制)</span><br><span class="line"></span><br><span class="line">自定义过滤器和标签(了解)</span><br></pre></td></tr></table></figure></li>
<li><p>模板的导入与继承(面向对象)</p>
</li>
</ul>
<h1 id="内容详细"><a href="#内容详细" class="headerlink" title="内容详细"></a>内容详细</h1><h3 id="模板层之模板语法传值"><a href="#模板层之模板语法传值" class="headerlink" title="模板层之模板语法传值"></a>模板层之模板语法传值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">https://www.cnblogs.com/Dominic-Ji/articles/<span class="number">11109067.</span>html<span class="comment">#_label15</span></span><br><span class="line">    </span><br><span class="line">注释</span><br><span class="line">    &lt;!--HTML注释--&gt;   浏览器能够查看</span><br><span class="line">    &#123;<span class="comment">#模板语法注释#&#125;    浏览器查看不了</span></span><br><span class="line">        </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="comment"># python基本数据类型</span></span><br><span class="line">    f = <span class="number">1.1</span></span><br><span class="line">    i = <span class="number">11</span></span><br><span class="line">    s = <span class="string">&#x27;hello world&#x27;</span></span><br><span class="line">    l = [<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">44</span>]</span><br><span class="line">    d = &#123;<span class="string">&#x27;username&#x27;</span>:<span class="string">&quot;jason&quot;</span>,<span class="string">&#x27;password&#x27;</span>:<span class="number">123</span>&#125;</span><br><span class="line">    t = (<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">44</span>,<span class="number">55</span>,<span class="number">66</span>,<span class="number">77</span>)</span><br><span class="line">    se = &#123;<span class="number">11</span>,<span class="number">22</span>,<span class="number">33</span>,<span class="number">44</span>,<span class="number">55</span>,<span class="number">66</span>&#125;</span><br><span class="line">    b = <span class="literal">True</span></span><br><span class="line">    <span class="comment"># 函数(自动加括号调用函数 展示的是函数的返回值)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">args</span>):</span>  <span class="comment"># 模板语法不支持给函数传递额外的参数</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;from func&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;下午有点困&#x27;</span></span><br><span class="line">    <span class="comment"># 面向对象</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>(<span class="params"><span class="built_in">object</span></span>):</span>  <span class="comment"># 自动加括号实例化产生对象</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">get_obj</span>(<span class="params">self</span>):</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;from obj&#x27;</span></span><br><span class="line"><span class="meta">        @classmethod</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">get_cls</span>(<span class="params">cls</span>):</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;from cls&#x27;</span></span><br><span class="line"><span class="meta">        @staticmethod</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">get_func</span>():</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;from func&#x27;</span></span><br><span class="line">    obj = MyClass()</span><br><span class="line">    <span class="comment"># 1.指名道姓的传(需要传的值较少)</span></span><br><span class="line">    <span class="comment"># return render(request,&#x27;reg.html&#x27;,&#123;...&#125;)</span></span><br><span class="line">    <span class="comment"># 2.一次性批量传(效率偏低)  为了教学方便我们使用locals居多</span></span><br><span class="line">    <span class="comment"># return render(request, &#x27;reg.html&#x27;,locals())</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;reg.html&#x27;</span>,<span class="built_in">locals</span>())</span><br></pre></td></tr></table></figure>

<h3 id="模板语法取值"><a href="#模板语法取值" class="headerlink" title="模板语法取值"></a>模板语法取值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">取值只能使用句点符(.)</span><br><span class="line">&lt;p&gt;&#123;&#123; l<span class="number">.0</span> &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&#123;&#123; d.username &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;&#123;&#123; d.hobby<span class="number">.3</span>.addr &#125;&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<h3 id="模板语法之过滤器-内置方法"><a href="#模板语法之过滤器-内置方法" class="headerlink" title="模板语法之过滤器(内置方法)"></a>模板语法之过滤器(内置方法)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;过滤器:  管道符 左侧当做过滤器的第一个参数 右侧有时候还可以支持再传一个参数(冒号开头)&lt;/p&gt;</span><br><span class="line">&lt;p&gt;统计长度:&#123;&#123; l|length &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;自增运算:&#123;&#123; i|add:<span class="number">123</span> &#125;&#125;、拼接操作:&#123;&#123; s|add:<span class="string">&#x27;去你妹的&#x27;</span> &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;日期转换:&#123;&#123; ctime &#125;&#125;、&#123;&#123; ctime|date:<span class="string">&#x27;Y-m-d&#x27;</span> &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;文件大小:&#123;&#123; file_size|filesizeformat &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;截取字符(三个点也算):&#123;&#123; desc|truncatechars:<span class="number">6</span> &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;截取单词(三个点不算):&#123;&#123; desc|truncatewords:<span class="number">3</span> &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;切片操作:&#123;&#123; s|<span class="built_in">slice</span>:<span class="string">&#x27;0:4&#x27;</span> &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;默认值(判断布尔值):&#123;&#123; b|default:<span class="string">&#x27;这个东西布尔值是False&#x27;</span> &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;文本转义:&#123;&#123; ht|safe &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;文本转义:&#123;&#123; xss &#125;&#125;&lt;/p&gt;</span><br><span class="line">&lt;p&gt;文本转义:&#123;&#123; ht1 &#125;&#125;&lt;/p&gt;</span><br><span class="line">    </span><br><span class="line">后端转义</span><br><span class="line"><span class="keyword">from</span> django.utils.safestring <span class="keyword">import</span> mark_safe</span><br><span class="line">ht1 = <span class="string">&#x27;&lt;h1&gt;一级标题&lt;/h1&gt;&#x27;</span></span><br><span class="line">ht1 = mark_safe(ht1)</span><br></pre></td></tr></table></figure>

<h3 id="模板语法之标签-流程控制"><a href="#模板语法之标签-流程控制" class="headerlink" title="模板语法之标签(流程控制)"></a>模板语法之标签(流程控制)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#125;&#125;    变量相关(引用变量值)</span><br><span class="line">&#123;%%&#125;    逻辑相关(流程控制 模块方法)</span><br><span class="line"></span><br><span class="line">&lt;p&gt;标签: 流程控制&lt;/p&gt;</span><br><span class="line">&#123;% <span class="keyword">for</span> i <span class="keyword">in</span> lll %&#125;</span><br><span class="line">    &#123;% <span class="keyword">if</span> forloop.first %&#125;</span><br><span class="line">        &lt;p&gt;这是我的第一次循环&lt;/p&gt;</span><br><span class="line">    &#123;% <span class="keyword">elif</span> forloop.last %&#125;</span><br><span class="line">        &lt;p&gt;这是我的最后一次循环&lt;/p&gt;</span><br><span class="line">    &#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">        &lt;p&gt;&#123;&#123; i &#125;&#125;&lt;/p&gt;</span><br><span class="line">    &#123;% endif %&#125;</span><br><span class="line">    &#123;% empty %&#125;</span><br><span class="line">        &lt;p&gt;该对象里面没有值&lt;/p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义过滤器、标签、inclusion-tag"><a href="#自定义过滤器、标签、inclusion-tag" class="headerlink" title="自定义过滤器、标签、inclusion_tag"></a>自定义过滤器、标签、inclusion_tag</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>在应用下创建一个名字必须叫templatetags文件夹</span><br><span class="line"><span class="number">2.</span>在该文件夹内创建一个任意名称的py文件</span><br><span class="line"><span class="number">3.</span>在py文件内必须要书写两行固定的代码</span><br><span class="line">    <span class="keyword">from</span> django.template <span class="keyword">import</span> Library</span><br><span class="line">     register = Library()</span><br><span class="line"> </span><br><span class="line"><span class="comment"># 自定义过滤器</span></span><br><span class="line"><span class="meta">@register.filter(<span class="params">is_safe=<span class="literal">False</span>,name=<span class="string">&#x27;aaa&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_plus</span>(<span class="params">a,b</span>):</span></span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义标签(自定义函数)</span></span><br><span class="line"><span class="meta">@register.simple_tag(<span class="params">name=<span class="string">&#x27;bbb&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span>(<span class="params">a,b,c,d</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;%s-%s-%s-%s&#x27;</span>%(a,b,c,d)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义inclusion_tag(自行概括)</span></span><br><span class="line"><span class="meta">@register.inclusion_tag(<span class="params">filename=<span class="string">&#x27;ccc.html&#x27;</span>,name=<span class="string">&#x27;myinc&#x27;</span></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">n</span>):</span></span><br><span class="line">    new_l = [<span class="string">&#x27;第%s页&#x27;</span>%i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,n+<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">locals</span>()</span><br></pre></td></tr></table></figure>

<h3 id="模板的继承-使用频率较高"><a href="#模板的继承-使用频率较高" class="headerlink" title="模板的继承(使用频率较高)"></a>模板的继承(使用频率较高)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">需求</span><br><span class="line">    页面主体不变 部分区域变化</span><br><span class="line"></span><br><span class="line">模板继承</span><br><span class="line">    <span class="number">1.</span>需要现在母版中使用block提前划定区域</span><br><span class="line">        &#123;% block 区域名称 %&#125;</span><br><span class="line">        &#123;% endblock %&#125;</span><br><span class="line">    <span class="number">2.</span>在子版中先继承再局部替换</span><br><span class="line">        &#123;% extends <span class="string">&#x27;模版.html&#x27;</span> %&#125;</span><br><span class="line">        &#123;% block 区域名称 %&#125;</span><br><span class="line">            </span><br><span class="line">        &#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">总结</span><br><span class="line">    模板一般情况下都应该至少含有三个区域</span><br><span class="line">        css区域</span><br><span class="line">        content区域</span><br><span class="line">        js区域</span><br><span class="line">    </span><br><span class="line">补充</span><br><span class="line">    &#123;&#123; block.<span class="built_in">super</span> &#125;&#125;  调用模版内容</span><br></pre></td></tr></table></figure>

<h3 id="模板的导入"><a href="#模板的导入" class="headerlink" title="模板的导入"></a>模板的导入</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include <span class="string">&#x27;myform.html&#x27;</span> %&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E9%A1%B5%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019/05/11/Django%E5%9F%BA%E7%A1%80%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E9%A1%B5%E5%99%A8/" class="post-title-link" itemprop="url">Django基础之自定义分页器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-11 07:20:25" itemprop="dateCreated datePublished" datetime="2019-05-11T07:20:25+08:00">2019-05-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-06-01 12:22:34" itemprop="dateModified" datetime="2019-06-01T12:22:34+08:00">2019-06-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Django%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Django系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="自定义分页器"><a href="#自定义分页器" class="headerlink" title="自定义分页器"></a>自定义分页器</h1><p><strong>针对批量插入的数据，我们在前端展示的时候发现一个很严重的问题，一页展示了所有的数据，数据量太大，查看不方便</strong></p>
<p><strong>针对数据量大但又需要全部展示给用户观看的情况下，我们统一做法都是做分页处理</strong></p>
<h2 id="分页推导"><a href="#分页推导" class="headerlink" title="分页推导"></a>分页推导</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">首先我们需要明确的时候，get请求也是可以携带参数的，所以我们在朝后端发送查看数据的同时可以携带一个参数告诉后端我们想看第几页的数据</span><br><span class="line"></span><br><span class="line">其次我们还需要知道一个点，queryset对象是支持索引取值和切片操作的，但是不支持负数索引情况</span><br><span class="line"></span><br><span class="line">接下来我们就可以推导我们的自定义分页器步骤了</span><br><span class="line"></span><br><span class="line">current_page = request.GET.get(<span class="string">&quot;page&quot;</span>,<span class="number">1</span>)  <span class="comment"># 获取用户想访问的页码  如果没有 默认展示第一页</span></span><br><span class="line"><span class="keyword">try</span>:  <span class="comment"># 由于后端接受到的前端数据是字符串类型所以我们这里做类型转换处理加异常捕获</span></span><br><span class="line">  current_page = <span class="built_in">int</span>(current_page)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">  current_page = <span class="number">1</span></span><br><span class="line"><span class="comment"># 还需要定义页面到底展示几条数据</span></span><br><span class="line">per_page_num = <span class="number">10</span>  <span class="comment"># 一页展示10条数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 需要对总数据进行切片操作 需要确定切片起始位置和终止位置</span></span><br><span class="line">start_page = ? </span><br><span class="line">end_page = ?</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">下面需要研究current_page、per_page_num、start_page、end_page四个参数之间的数据关系</span></span><br><span class="line"><span class="string">per_page_num = 10</span></span><br><span class="line"><span class="string">current_page                start_page                  end_page</span></span><br><span class="line"><span class="string">    1                           0                           10</span></span><br><span class="line"><span class="string">    2                           10                          20</span></span><br><span class="line"><span class="string">    3                           20                          30  </span></span><br><span class="line"><span class="string">    4                           30                          40</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">per_page_num = 5</span></span><br><span class="line"><span class="string">current_page                start_page                  end_page</span></span><br><span class="line"><span class="string">    1                           0                           5</span></span><br><span class="line"><span class="string">    2                           5                           10</span></span><br><span class="line"><span class="string">    3                           10                          15  </span></span><br><span class="line"><span class="string">    4                           15                          20</span></span><br><span class="line"><span class="string">可以很明显的看出规律</span></span><br><span class="line"><span class="string">start_page = (current_page - 1) * per_page_num</span></span><br><span class="line"><span class="string">end_page =  current_page* per_page_num</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="数据总页面获取"><a href="#数据总页面获取" class="headerlink" title="数据总页面获取"></a>数据总页面获取</h2><p><strong>当我问你下面几个问题的时候，你的内心肯定是鄙视的，不信的话那就请听题</strong></p>
<p><strong>问题1:总数据有100条，每页展示10条，总共需要几页？</strong></p>
<p><strong>答案:10条</strong></p>
<p><strong>问题2:总数据有101条，每页展示10条，总共需要几页?</strong></p>
<p><strong>答案:11条</strong></p>
<p><strong>问题3:如何通过代码算出到底需要多少条？</strong></p>
<p><strong>答案:去你妹的，不会！！！</strong></p>
<h3 id="内置方法之divmod"><a href="#内置方法之divmod" class="headerlink" title="内置方法之divmod"></a>内置方法之divmod</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">divmod</span>(<span class="number">100</span>,<span class="number">10</span>)</span><br><span class="line">(<span class="number">10</span>, <span class="number">0</span>)  <span class="comment"># 10页</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">divmod</span>(<span class="number">101</span>,<span class="number">10</span>)</span><br><span class="line">(<span class="number">10</span>, <span class="number">1</span>)  <span class="comment"># 11页</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">divmod</span>(<span class="number">99</span>,<span class="number">10</span>)</span><br><span class="line">(<span class="number">9</span>, <span class="number">9</span>)  <span class="comment"># 10页</span></span><br><span class="line"><span class="comment"># 余数只要不是0就需要在第一个数字上加一</span></span><br><span class="line">我们可以判断元祖的第二个数字是否为<span class="number">0</span>从而确定到底需要多少页来展示数据</span><br><span class="line"></span><br><span class="line">book_queryset = models.Book.objects.<span class="built_in">all</span>()</span><br><span class="line">all_count = book_queryset.count()  <span class="comment"># 数据总条数</span></span><br><span class="line">all_pager, more = <span class="built_in">divmod</span>(all_count, per_page_num)</span><br><span class="line"><span class="keyword">if</span> more:  <span class="comment"># 有余数则总页数加一</span></span><br><span class="line">  all_pager += <span class="number">1</span></span><br><span class="line">至此分页器大致的功能及思路我们就已经大致清楚了</span><br><span class="line"></span><br><span class="line">最后我们只需要利用start_page和end_page对总数据进行切片取值再传入前端页面就能够实现分页展示</span><br><span class="line"></span><br><span class="line">book_list = models.Book.objects.<span class="built_in">all</span>()[start_page:end_page]</span><br><span class="line"><span class="keyword">return</span> render(request,<span class="string">&#x27;booklist.html&#x27;</span>,<span class="built_in">locals</span>())</span><br><span class="line">接下来就是前端页面的代码编写了</span><br><span class="line"></span><br><span class="line">&#123;% <span class="keyword">for</span> book <span class="keyword">in</span> book_list %&#125;</span><br><span class="line">    &lt;p&gt;&#123;&#123; book.title &#125;&#125;&lt;/p&gt;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p><strong>现在我们实现了最简单的分页，但是前端没有按钮去让用户点击需要看第几页，所以我们需要渲染分页器相关代码，这里我们不做要求直接去bootstrap框架拷贝代码即可</strong></p>
<h2 id="终极大法"><a href="#终极大法" class="headerlink" title="终极大法"></a>终极大法</h2><p>上面是自定义分页器开发流程的基本思路，我们不需要掌握代码的编写，只需要掌握基本用法即可</p>
<p>自定义分页器封装代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pagination</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, current_page, all_count, per_page_num=<span class="number">2</span>, pager_count=<span class="number">11</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        封装分页相关数据</span></span><br><span class="line"><span class="string">        :param current_page: 当前页</span></span><br><span class="line"><span class="string">        :param all_count:    数据库中的数据总条数</span></span><br><span class="line"><span class="string">        :param per_page_num: 每页显示的数据条数</span></span><br><span class="line"><span class="string">        :param pager_count:  最多显示的页码个数</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            current_page = <span class="built_in">int</span>(current_page)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            current_page = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> current_page &lt; <span class="number">1</span>:</span><br><span class="line">            current_page = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        self.current_page = current_page</span><br><span class="line"></span><br><span class="line">        self.all_count = all_count</span><br><span class="line">        self.per_page_num = per_page_num</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 总页码</span></span><br><span class="line">        all_pager, tmp = <span class="built_in">divmod</span>(all_count, per_page_num)</span><br><span class="line">        <span class="keyword">if</span> tmp:</span><br><span class="line">            all_pager += <span class="number">1</span></span><br><span class="line">        self.all_pager = all_pager</span><br><span class="line"></span><br><span class="line">        self.pager_count = pager_count</span><br><span class="line">        self.pager_count_half = <span class="built_in">int</span>((pager_count - <span class="number">1</span>) / <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> (self.current_page - <span class="number">1</span>) * self.per_page_num</span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">end</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.current_page * self.per_page_num</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">page_html</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># 如果总页码 &lt; 11个：</span></span><br><span class="line">        <span class="keyword">if</span> self.all_pager &lt;= self.pager_count:</span><br><span class="line">            pager_start = <span class="number">1</span></span><br><span class="line">            pager_end = self.all_pager + <span class="number">1</span></span><br><span class="line">        <span class="comment"># 总页码  &gt; 11</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># 当前页如果&lt;=页面上最多显示11/2个页码</span></span><br><span class="line">            <span class="keyword">if</span> self.current_page &lt;= self.pager_count_half:</span><br><span class="line">                pager_start = <span class="number">1</span></span><br><span class="line">                pager_end = self.pager_count + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 当前页大于5</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="comment"># 页码翻到最后</span></span><br><span class="line">                <span class="keyword">if</span> (self.current_page + self.pager_count_half) &gt; self.all_pager:</span><br><span class="line">                    pager_end = self.all_pager + <span class="number">1</span></span><br><span class="line">                    pager_start = self.all_pager - self.pager_count + <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    pager_start = self.current_page - self.pager_count_half</span><br><span class="line">                    pager_end = self.current_page + self.pager_count_half + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        page_html_list = []</span><br><span class="line">        <span class="comment"># 添加前面的nav和ul标签</span></span><br><span class="line">        page_html_list.append(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                    &lt;nav aria-label=&#x27;Page navigation&gt;&#x27;</span></span><br><span class="line"><span class="string">                    &lt;ul class=&#x27;pagination&#x27;&gt;</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span>)</span><br><span class="line">        first_page = <span class="string">&#x27;&lt;li&gt;&lt;a href=&quot;?page=%s&quot;&gt;首页&lt;/a&gt;&lt;/li&gt;&#x27;</span> % (<span class="number">1</span>)</span><br><span class="line">        page_html_list.append(first_page)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.current_page &lt;= <span class="number">1</span>:</span><br><span class="line">            prev_page = <span class="string">&#x27;&lt;li class=&quot;disabled&quot;&gt;&lt;a href=&quot;#&quot;&gt;上一页&lt;/a&gt;&lt;/li&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            prev_page = <span class="string">&#x27;&lt;li&gt;&lt;a href=&quot;?page=%s&quot;&gt;上一页&lt;/a&gt;&lt;/li&gt;&#x27;</span> % (self.current_page - <span class="number">1</span>,)</span><br><span class="line"></span><br><span class="line">        page_html_list.append(prev_page)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(pager_start, pager_end):</span><br><span class="line">            <span class="keyword">if</span> i == self.current_page:</span><br><span class="line">                temp = <span class="string">&#x27;&lt;li class=&quot;active&quot;&gt;&lt;a href=&quot;?page=%s&quot;&gt;%s&lt;/a&gt;&lt;/li&gt;&#x27;</span> % (i, i,)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                temp = <span class="string">&#x27;&lt;li&gt;&lt;a href=&quot;?page=%s&quot;&gt;%s&lt;/a&gt;&lt;/li&gt;&#x27;</span> % (i, i,)</span><br><span class="line">            page_html_list.append(temp)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.current_page &gt;= self.all_pager:</span><br><span class="line">            next_page = <span class="string">&#x27;&lt;li class=&quot;disabled&quot;&gt;&lt;a href=&quot;#&quot;&gt;下一页&lt;/a&gt;&lt;/li&gt;&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            next_page = <span class="string">&#x27;&lt;li&gt;&lt;a href=&quot;?page=%s&quot;&gt;下一页&lt;/a&gt;&lt;/li&gt;&#x27;</span> % (self.current_page + <span class="number">1</span>,)</span><br><span class="line">        page_html_list.append(next_page)</span><br><span class="line"></span><br><span class="line">        last_page = <span class="string">&#x27;&lt;li&gt;&lt;a href=&quot;?page=%s&quot;&gt;尾页&lt;/a&gt;&lt;/li&gt;&#x27;</span> % (self.all_pager,)</span><br><span class="line">        page_html_list.append(last_page)</span><br><span class="line">        <span class="comment"># 尾部添加标签</span></span><br><span class="line">        page_html_list.append(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                                           &lt;/nav&gt;</span></span><br><span class="line"><span class="string">                                           &lt;/ul&gt;</span></span><br><span class="line"><span class="string">                                       &#x27;&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join(page_html_list)</span><br></pre></td></tr></table></figure>

<h2 id="自定义分页器使用"><a href="#自定义分页器使用" class="headerlink" title="自定义分页器使用"></a>自定义分页器使用</h2><h3 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_book</span>(<span class="params">request</span>):</span></span><br><span class="line">  book_list = models.Book.objects.<span class="built_in">all</span>()</span><br><span class="line">  current_page = request.GET.get(<span class="string">&quot;page&quot;</span>,<span class="number">1</span>)</span><br><span class="line">  all_count = book_list.count()</span><br><span class="line">  page_obj = Pagination(current_page=current_page,all_count=all_count,per_page_num=<span class="number">10</span>)</span><br><span class="line">  page_queryset = book_list[page_obj.start:page_obj.end]</span><br><span class="line">  <span class="keyword">return</span> render(request,<span class="string">&#x27;booklist.html&#x27;</span>,<span class="built_in">locals</span>())</span><br></pre></td></tr></table></figure>

<h3 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>&quot;&gt;</span></span><br><span class="line"><span class="class">    &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">row</span>&quot;&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">col</span>-<span class="title">md</span>-8 <span class="title">col</span>-<span class="title">md</span>-<span class="title">offset</span>-2&quot;&gt;</span></span><br><span class="line"><span class="class">            &#123;% <span class="title">for</span> <span class="title">book</span> <span class="title">in</span> <span class="title">page_queryset</span> %&#125;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">p</span>&gt;&#123;&#123; <span class="title">book</span>.<span class="title">title</span> &#125;&#125;&lt;/<span class="title">p</span>&gt;</span></span><br><span class="line"><span class="class">            &#123;% <span class="title">endfor</span> %&#125;</span></span><br><span class="line"><span class="class">            &#123;&#123; <span class="title">page_obj</span>.<span class="title">page_html</span>|<span class="title">safe</span> &#125;&#125;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">池劲涛</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
