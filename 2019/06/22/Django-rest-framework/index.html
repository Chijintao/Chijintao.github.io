<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","version":"8.6.1","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="DRF APIView请求生命周期流程图  drf入门规范Web应用模式前后端不分离 12# 模板渲染在后端完成     前后端分离(主流) 123# 后端就只负责写接口，前端来调用，通信使用json格式# 多端(web、app...)都可以使用同一个接口       API接口通过网络，规定了前后台信息交互规则的url链接，也就是前后台信息交互的媒介 四大特点 &#x3D;&#x3D;url&#x3D;&#x3D;  长得像返回数据的">
<meta property="og:type" content="article">
<meta property="og:title" content="drf(详细)">
<meta property="og:url" content="http://example.com/2019/06/22/Django-rest-framework/index.html">
<meta property="og:site_name" content="池劲涛的博客">
<meta property="og:description" content="DRF APIView请求生命周期流程图  drf入门规范Web应用模式前后端不分离 12# 模板渲染在后端完成     前后端分离(主流) 123# 后端就只负责写接口，前端来调用，通信使用json格式# 多端(web、app...)都可以使用同一个接口       API接口通过网络，规定了前后台信息交互规则的url链接，也就是前后台信息交互的媒介 四大特点 &#x3D;&#x3D;url&#x3D;&#x3D;  长得像返回数据的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img2018.cnblogs.com/blog/1736414/202002/1736414-20200218223701411-338089898.png">
<meta property="og:image" content="https://img2018.cnblogs.com/blog/1736414/202002/1736414-20200223221801476-717815335.png">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gggfnzeg2xj31k80smjv1.jpg">
<meta property="og:image" content="https://tva1.sinaimg.cn/large/007S8ZIlgy1gggfo3sdg9j31aw0u0jxr.jpg">
<meta property="og:image" content="https://i.loli.net/2021/07/13/Ib7snRkHaWqUyXl.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/o6SsLTcX4gyf3kZ.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/IY8ja5QpveFOcEg.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/RjJSxWDNdgBmcp8.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/SEe18PrpIxoBRqV.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/ljb5H4esAzFyCGP.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/dNkwtysqrG3YMVK.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/dIJu91GOgZYymq4.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/agAH9oRb3P2rOMu.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/QeqjWh3VfH9w2B5.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/6AsePhQvJu24LN8.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/woCEI1bMDNhiSLA.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/EhTM4U1DFjuiPJl.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/IYUbC436jgFuxtQ.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/m7FdZEayzqhvXjC.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/B4JjeihOfHAXU6z.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/QeyDj2BmxElJbg8.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/b4dw7anUz5fkYvg.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/gqlwv4FA9zBQGXT.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/vweS9dPYl3K2xjG.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/eJ4IxpXt9kKEDBl.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/HcPUrQDSewfILgj.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/CUnOqhfimyIgFba.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/OhcDHgkxtCB9Nna.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/w6uOeFcSjZGRCVk.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/17opTiSPhMu8Vsg.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/NAPy8owlSkOWgUJ.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/5meHTn9RJ74dFvA.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/oVFkBWeUsM1Qj5G.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/5meHTn9RJ74dFvA.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/Kidfat1knMlF9cm.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/RJe7km51WZrF3DT.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/kBc9h3lorAyULSe.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/IiENjoSODkslCHL.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/WL9pSrasuU7iOJF.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/T3UGjvpaOLZyswX.png">
<meta property="og:image" content="https://img2018.cnblogs.com/blog/1736414/202002/1736414-20200223222136020-817505790.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/9rumdEt6PK1I7yA.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/LPtXQu3bgdAin1B.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/MzK2IUvlPBpLriO.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/PiKmHtro35d2WeL.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/UxjrVGat59z2MXl.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/4OnkJZKvwDhXGTi.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/qILVJNO9QZK8n6k.png">
<meta property="og:image" content="https://i.loli.net/2021/07/13/8mqvgdzAQW5a1hK.png">
<meta property="article:published_time" content="2019-06-22T01:20:25.000Z">
<meta property="article:modified_time" content="2019-07-01T04:22:34.000Z">
<meta property="article:author" content="池劲涛">
<meta property="article:tag" content="drf">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img2018.cnblogs.com/blog/1736414/202002/1736414-20200218223701411-338089898.png">


<link rel="canonical" href="http://example.com/2019/06/22/Django-rest-framework/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://example.com/2019/06/22/Django-rest-framework/","path":"2019/06/22/Django-rest-framework/","title":"drf(详细)"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>drf(详细) | 池劲涛的博客</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">池劲涛的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#DRF-APIView%E8%AF%B7%E6%B1%82%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="nav-number">1.</span> <span class="nav-text">DRF APIView请求生命周期流程图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#drf%E5%85%A5%E9%97%A8%E8%A7%84%E8%8C%83"><span class="nav-number">2.</span> <span class="nav-text">drf入门规范</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Web%E5%BA%94%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="nav-number">2.1.</span> <span class="nav-text">Web应用模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API%E6%8E%A5%E5%8F%A3"><span class="nav-number">2.2.</span> <span class="nav-text">API接口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95%E5%B7%A5%E5%85%B7%EF%BC%9APostman"><span class="nav-number">2.3.</span> <span class="nav-text">接口测试工具：Postman</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RESTful-API%E8%A7%84%E8%8C%83-3%E6%98%9F"><span class="nav-number">2.4.</span> <span class="nav-text">RESTful API规范(3星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#drf%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%AE%89%E8%A3%85"><span class="nav-number">2.5.</span> <span class="nav-text">drf介绍与安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CBV%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2%E6%98%9F"><span class="nav-number">2.6.</span> <span class="nav-text">CBV源码分析(2星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#drf%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90-3%E6%98%9F"><span class="nav-number">2.7.</span> <span class="nav-text">drf基本使用及流程分析(3星)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#drf%E9%85%8D%E7%BD%AE"><span class="nav-number">3.</span> <span class="nav-text">drf配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%84%E4%BB%B6"><span class="nav-number">4.</span> <span class="nav-text">序列化组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8%E4%B9%8BSerializer%E7%B1%BB%E7%9A%84%E4%BD%BF%E7%94%A8-%E8%B7%9F%E8%A1%A8%E6%A8%A1%E5%9E%8B%E6%B2%A1%E6%9C%89%E5%BF%85%E7%84%B6%E8%81%94%E7%B3%BB-5%E6%98%9F"><span class="nav-number">4.2.</span> <span class="nav-text">序列化器之Serializer类的使用(跟表模型没有必然联系)(5星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Serializers%E9%AB%98%E7%BA%A7%E4%BD%BF%E7%94%A8-5%E6%98%9F"><span class="nav-number">4.3.</span> <span class="nav-text">Serializers高级使用(5星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A8%A1%E5%9E%8B%E7%B1%BB%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8ModelSerializer-%E8%B7%9F%E8%A1%A8%E6%A8%A1%E5%9E%8B%E6%9C%89%E5%85%B3%E8%81%94-5%E6%98%9F"><span class="nav-number">4.4.</span> <span class="nav-text">模型类序列化器ModelSerializer(跟表模型有关联)(5星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8%E5%AD%97%E6%AE%B5%E5%92%8C%E5%AD%97%E6%AE%B5%E5%8F%82%E6%95%B0-2%E6%98%9F"><span class="nav-number">4.5.</span> <span class="nav-text">序列化器字段和字段参数(2星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%80%E9%83%A8%E9%92%A9%E5%AD%90%E5%92%8C%E5%85%A8%E5%B1%80%E9%92%A9%E5%AD%90%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2%E6%98%9F"><span class="nav-number">4.6.</span> <span class="nav-text">局部钩子和全局钩子源码分析(2星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E7%BB%84%E4%BB%B6%E9%83%A8%E5%88%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2%E6%98%9F"><span class="nav-number">4.7.</span> <span class="nav-text">序列化组件部分源码分析(2星)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E4%B8%8E%E5%93%8D%E5%BA%94-3%E6%98%9F"><span class="nav-number">5.</span> <span class="nav-text">请求与响应(3星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#drf%E8%AF%B7%E6%B1%82%E5%85%A8%E5%B1%80%E5%92%8C%E5%B1%80%E9%83%A8%E9%85%8D%E7%BD%AE"><span class="nav-number">5.1.</span> <span class="nav-text">drf请求全局和局部配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Request"><span class="nav-number">5.2.</span> <span class="nav-text">Request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Response"><span class="nav-number">5.3.</span> <span class="nav-text">Response</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE%E7%BB%84%E4%BB%B6-5%E6%98%9F"><span class="nav-number">6.</span> <span class="nav-text">视图组件(5星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E4%B8%AA%E8%A7%86%E5%9B%BE%E5%9F%BA%E7%B1%BB"><span class="nav-number">6.1.</span> <span class="nav-text">两个视图基类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#APIView"><span class="nav-number">6.1.1.</span> <span class="nav-text">APIView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GenericAPIView-%E9%80%9A%E7%94%A8%E8%A7%86%E5%9B%BE%E7%B1%BB"><span class="nav-number">6.1.2.</span> <span class="nav-text">GenericAPIView(通用视图类)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%94%E4%B8%AA%E8%A7%86%E5%9B%BE%E6%89%A9%E5%B1%95%E7%B1%BB"><span class="nav-number">6.2.</span> <span class="nav-text">五个视图扩展类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B9%9D%E4%B8%AA%E8%A7%86%E5%9B%BE%E5%AD%90%E7%B1%BB"><span class="nav-number">6.3.</span> <span class="nav-text">九个视图子类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%86%E5%9B%BE%E9%9B%86"><span class="nav-number">6.4.</span> <span class="nav-text">视图集</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1%E7%BB%84%E4%BB%B6-5%E6%98%9F"><span class="nav-number">7.</span> <span class="nav-text">路由组件(5星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Routers"><span class="nav-number">7.1.</span> <span class="nav-text">Routers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">7.2.</span> <span class="nav-text">使用方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%95%E5%9B%BE%E7%B1%BB%E4%B8%AD%E6%B4%BE%E7%94%9F%E7%9A%84%E6%96%B9%E6%B3%95%EF%BC%8C%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E8%B7%AF%E7%94%B1-action"><span class="nav-number">7.3.</span> <span class="nav-text">试图类中派生的方法，自动生成路由(action)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%A4%E8%AF%81%E7%BB%84%E4%BB%B6-5%E6%98%9F"><span class="nav-number">8.</span> <span class="nav-text">认证组件(5星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="nav-number">8.1.</span> <span class="nav-text">简单使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">8.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9D%83%E9%99%90%E7%BB%84%E4%BB%B6-4%E6%98%9F"><span class="nav-number">9.</span> <span class="nav-text">权限组件(4星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-1"><span class="nav-number">9.1.</span> <span class="nav-text">简单使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1"><span class="nav-number">9.2.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A2%91%E7%8E%87%E7%BB%84%E4%BB%B6-5%E6%98%9F"><span class="nav-number">10.</span> <span class="nav-text">频率组件(5星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E9%A2%91%E7%8E%87%E7%B1%BB"><span class="nav-number">10.1.</span> <span class="nav-text">自定义频率类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-2"><span class="nav-number">10.2.</span> <span class="nav-text">简单使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2"><span class="nav-number">10.3.</span> <span class="nav-text">源码分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E4%B8%8E%E6%8E%92%E5%BA%8F-4%E6%98%9F"><span class="nav-number">11.</span> <span class="nav-text">过滤与排序(4星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-3"><span class="nav-number">11.1.</span> <span class="nav-text">简单使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86-4%E6%98%9F"><span class="nav-number">12.</span> <span class="nav-text">异常处理(4星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-4"><span class="nav-number">12.1.</span> <span class="nav-text">简单使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E5%8A%9F%E8%83%BD-5%E6%98%9F"><span class="nav-number">13.</span> <span class="nav-text">分页功能(5星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PageNumberPagination%E5%9F%BA%E6%9C%AC%E5%88%86%E9%A1%B5"><span class="nav-number">13.1.</span> <span class="nav-text">PageNumberPagination基本分页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LimitOffsetPagination%E5%81%8F%E7%A7%BB%E5%88%86%E9%A1%B5"><span class="nav-number">13.2.</span> <span class="nav-text">LimitOffsetPagination偏移分页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CursorPagination%E6%B8%B8%E6%A0%87%E5%88%86%E9%A1%B5"><span class="nav-number">13.3.</span> <span class="nav-text">CursorPagination游标分页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BB%A7%E6%89%BFAPIView%E5%AE%9E%E7%8E%B0%E4%B8%89%E7%A7%8D%E5%88%86%E9%A1%B5%E6%96%B9%E5%BC%8F"><span class="nav-number">13.4.</span> <span class="nav-text">继承APIView实现三种分页方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E6%8E%A5%E5%8F%A3%E6%96%87%E6%A1%A3-3%E6%98%9F"><span class="nav-number">14.</span> <span class="nav-text">自动生成接口文档(3星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8coreapi%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90"><span class="nav-number">14.1.</span> <span class="nav-text">使用coreapi自动生成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RBAC-4%E6%98%9F"><span class="nav-number">15.</span> <span class="nav-text">RBAC(4星)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JWT-5%E6%98%9F"><span class="nav-number">16.</span> <span class="nav-text">JWT(5星)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-5%E6%98%9F"><span class="nav-number">16.1.</span> <span class="nav-text">介绍(5星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#base64%E7%BC%96%E7%A0%81"><span class="nav-number">16.2.</span> <span class="nav-text">base64编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JWT%E5%BF%AB%E9%80%9F%E4%BD%BF%E7%94%A8-2%E6%98%9F"><span class="nav-number">16.3.</span> <span class="nav-text">JWT快速使用(2星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JWT%E4%BD%BF%E7%94%A8auth%E8%A1%A8%E7%AD%BE%E5%8F%91token%EF%BC%8C%E8%87%AA%E5%AE%9A%E5%88%B6%E6%A0%BC%E5%BC%8F-3%E6%98%9F"><span class="nav-number">16.4.</span> <span class="nav-text">JWT使用auth表签发token，自定制格式(3星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#obtain-jwt-token%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-2%E6%98%9F"><span class="nav-number">16.5.</span> <span class="nav-text">obtain_jwt_token源码分析(2星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8Ejwt%E7%9A%84%E8%AE%A4%E8%AF%81%E7%B1%BB-5%E6%98%9F"><span class="nav-number">16.6.</span> <span class="nav-text">基于jwt的认证类(5星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8E%E8%87%AA%E5%AE%9A%E4%B9%89User%E8%A1%A8%EF%BC%8C%E7%AD%BE%E5%8F%91token-5%E6%98%9F"><span class="nav-number">16.7.</span> <span class="nav-text">基于自定义User表，签发token(5星)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%9A%E6%96%B9%E5%BC%8F%E7%99%BB%E5%BD%95-5%E6%98%9F"><span class="nav-number">16.8.</span> <span class="nav-text">多方式登录(5星)</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="池劲涛"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">池劲涛</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2019/06/22/Django-rest-framework/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="池劲涛">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="池劲涛的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          drf(详细)
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-22 09:20:25" itemprop="dateCreated datePublished" datetime="2019-06-22T09:20:25+08:00">2019-06-22</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2019-07-01 12:22:34" itemprop="dateModified" datetime="2019-07-01T12:22:34+08:00">2019-07-01</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Django%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">Django系列</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="DRF-APIView请求生命周期流程图"><a href="#DRF-APIView请求生命周期流程图" class="headerlink" title="DRF APIView请求生命周期流程图"></a>DRF APIView请求生命周期流程图</h2><p><img src="https://img2018.cnblogs.com/blog/1736414/202002/1736414-20200218223701411-338089898.png" alt="img"></p>
<p><img src="https://img2018.cnblogs.com/blog/1736414/202002/1736414-20200223221801476-717815335.png" alt="img"></p>
<h2 id="drf入门规范"><a href="#drf入门规范" class="headerlink" title="drf入门规范"></a>drf入门规范</h2><h3 id="Web应用模式"><a href="#Web应用模式" class="headerlink" title="Web应用模式"></a>Web应用模式</h3><p><strong>前后端不分离</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模板渲染在后端完成</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gggfnzeg2xj31k80smjv1.jpg" alt="前后端不分离"></p>
<p><strong>前后端分离(主流)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 后端就只负责写接口，前端来调用，通信使用json格式</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多端(web、app...)都可以使用同一个接口</span></span><br></pre></td></tr></table></figure>





<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gggfo3sdg9j31aw0u0jxr.jpg" alt="前后端分离"></p>
<h3 id="API接口"><a href="#API接口" class="headerlink" title="API接口"></a>API接口</h3><p><strong>通过网络，规定了前后台信息交互规则的url链接，也就是前后台信息交互的媒介</strong></p>
<p><strong>四大特点</strong></p>
<p>==url==</p>
<ul>
<li>长得像返回数据的url链接</li>
</ul>
<p>==请求方式==</p>
<ul>
<li>get、post、put、patch、delete</li>
</ul>
<p>==请求参数==</p>
<ul>
<li>json或xml(老项目)格式的key-value类型数据</li>
</ul>
<p>==相应结果==</p>
<ul>
<li>json或xml格式的数据</li>
</ul>
<h3 id="接口测试工具：Postman"><a href="#接口测试工具：Postman" class="headerlink" title="接口测试工具：Postman"></a>接口测试工具：Postman</h3><p><strong>官网下载</strong>：<a target="_blank" rel="noopener" href="https://www.getpostman.com/downloads/">https://www.getpostman.com/downloads/</a></p>
<h3 id="RESTful-API规范-3星"><a href="#RESTful-API规范-3星" class="headerlink" title="RESTful API规范(3星)"></a>RESTful API规范(3星)</h3><p><strong>写接口的规范，大部分接口都会按照这个规范去写(Web API接口的设计风格)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 使用https协议进行传输数据(保证数据安全)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 url中带关键字api</span></span><br><span class="line">	https://api.baidu.com</span><br><span class="line">    https://www.baidu.com/api</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 3 url中带版本信息</span></span><br><span class="line">	https://api.baidu.com/v1</span><br><span class="line">	https://api.baidu.com/v2</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 4 数据即资源，均使用名词(重要)</span></span><br><span class="line">	https://api.baidu.com/users</span><br><span class="line">    https://api.baidu.com/books</span><br><span class="line">    https://api.baidu.com/book</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 5 资源操作由请求方式决定(重要)</span></span><br><span class="line">	<span class="string">&#x27;查询操作&#x27;</span> : get</span><br><span class="line">    <span class="string">&#x27;新增操作&#x27;</span> : post</span><br><span class="line">    <span class="string">&#x27;修改操作&#x27;</span> : put</span><br><span class="line">    <span class="string">&#x27;删除操作&#x27;</span> : delete</span><br><span class="line">    </span><br><span class="line">    https://api.baidu.com/books - get请求：获取所有书</span><br><span class="line">    https://api.baidu.com/books/<span class="number">1</span> - get请求：获取主键为<span class="number">1</span>的书</span><br><span class="line">    https://api.baidu.com/books - post请求：新增一本书书</span><br><span class="line">    https://api.baidu.com/books/<span class="number">1</span> - put请求：整体修改主键为<span class="number">1</span>的书</span><br><span class="line">    https://api.baidu.com/books/<span class="number">1</span> - patch请求：局部修改主键为<span class="number">1</span>的书</span><br><span class="line">    https://api.baidu.com/books/<span class="number">1</span> - delete请求：删除主键为<span class="number">1</span>的书</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 6 请求url中带搜索筛选条件(重要)</span></span><br><span class="line">	https://api.example.com/v1/zoos?limit=<span class="number">10</span>：指定返回记录的数量</span><br><span class="line">	https://api.example.com/v1/zoos?offset=<span class="number">10</span>：指定返回记录的开始位置、</span><br><span class="line">    https://api.example.com/v1/zoos?animal_type_id=<span class="number">1</span>：指定筛选条件</span><br><span class="line">     </span><br><span class="line"><span class="comment"># 7 响应中要带状态码(自己定义，http响应状态码)</span></span><br><span class="line">	&#123;</span><br><span class="line">    status:<span class="number">200</span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 8 响应返回错误信息</span></span><br><span class="line">	&#123;</span><br><span class="line">        status:<span class="number">200</span></span><br><span class="line">        msg: <span class="string">&quot;无权限操作&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 9 返回结果，遵循如下规范(大概率都没有遵循)</span></span><br><span class="line">	GET /collection：返回资源对象的列表（数组）</span><br><span class="line">    GET /collection/resource：返回单个资源对象</span><br><span class="line">    POST /collection：返回新生成的资源对象</span><br><span class="line">    PUT /collection/resource：返回完整的资源对象</span><br><span class="line">    PATCH /collection/resource：返回完整的资源对象</span><br><span class="line">    DELETE /collection/resource：返回一个空文档</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 10 返回数据中带有链接地址</span></span><br><span class="line">	&#123;</span><br><span class="line">  	<span class="string">&quot;status&quot;</span>: <span class="number">0</span>,</span><br><span class="line">  	<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;ok&quot;</span>,</span><br><span class="line">  	<span class="string">&quot;results&quot;</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>:<span class="string">&quot;肯德基(罗餐厅)&quot;</span>,</span><br><span class="line">            <span class="string">&quot;img&quot;</span>: <span class="string">&quot;https://image.baidu.com/kfc/001.png&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">		]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="drf介绍与安装"><a href="#drf介绍与安装" class="headerlink" title="drf介绍与安装"></a>drf介绍与安装</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Django-Rest-Framework: 是django的一个app，可以借助它快速在django框架开发出符合restful规范的接口</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Django-Rest-Framework提供了: 认证、权限、限流、过滤、分页、接口文档等功能支持</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 官方文档: https://www.django-rest-framework.org/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># python Django版本的支持情况</span></span><br><span class="line">	Python(<span class="number">3.5</span>、<span class="number">3.6</span>、<span class="number">3.7</span>、<span class="number">3.8</span>、<span class="number">3.9</span>)</span><br><span class="line">    Django(<span class="number">2.2</span>、<span class="number">3.0</span>、<span class="number">3.1</span>)		<span class="number">2.</span>x用的多，<span class="number">1.</span>x(老项目)</span><br></pre></td></tr></table></figure>



<h3 id="CBV源码分析-2星"><a href="#CBV源码分析-2星" class="headerlink" title="CBV源码分析(2星)"></a>CBV源码分析(2星)</h3><p><strong>1 views.Book.as_view()执行完，一定是一个函数的内存地址</strong></p>
<p><strong>2 as_view是View类的类方法，类来调用</strong></p>
<p><img src="https://i.loli.net/2021/07/13/Ib7snRkHaWqUyXl.png" alt="image-20210712230515567.png"></p>
<p><strong>3 as_view中的view是一个闭包函数</strong></p>
<p><img src="https://i.loli.net/2021/07/13/o6SsLTcX4gyf3kZ.png" alt="t6yClDvJ1mSqBz7.png"></p>
<p><strong>4 执行了View类的dispatch</strong></p>
<p><img src="https://i.loli.net/2021/07/13/IY8ja5QpveFOcEg.png" alt="YnVcwmbhOkAz1NC.png"></p>
<p><img src="https://i.loli.net/2021/07/13/RjJSxWDNdgBmcp8.png" alt="X4UrdcEtFkosxhm.png"></p>
<p><strong>拓展</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果在当前视图类中重写dispatch方法，则可以实现：在get、post等方法执行之前或执行之后去执行重写的代码，完成类似装饰器的效果</span></span><br><span class="line"></span><br><span class="line">例如</span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">dispatch</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="comment"># 代码(get、post等方法执行之前执行)</span></span><br><span class="line">        response = <span class="built_in">super</span>().dispatch(request, *args, **kwargs)</span><br><span class="line">        <span class="comment"># 代码(get、post等方法执行之后执行)</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>



<h3 id="drf基本使用及流程分析-3星"><a href="#drf基本使用及流程分析-3星" class="headerlink" title="drf基本使用及流程分析(3星)"></a>drf基本使用及流程分析(3星)</h3><p><strong>继承APIView使用</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Student</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> Student_serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student_serializers_APIView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 查询所有学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        student_list = Student.objects.<span class="built_in">all</span>()</span><br><span class="line">        ser = Student_serializers(instance=student_list, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新增学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        ser = Student_serializers(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            ser.save()</span><br><span class="line">            <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>



<p><strong>APIView的执行流程</strong></p>
<p>==1 APIView继承了django的View==</p>
<p><img src="https://i.loli.net/2021/07/13/SEe18PrpIxoBRqV.png" alt="EuNedGk5KbrJHwx.png"></p>
<p>==2 APIView中重写了as_view==</p>
<p><img src="https://i.loli.net/2021/07/13/ljb5H4esAzFyCGP.png" alt="rXMFCHUbcgnSOVh.png"></p>
<p>==3 执行self.dispatch() —&gt; APIView的dispatch==</p>
<p><img src="https://i.loli.net/2021/07/13/dNkwtysqrG3YMVK.png" alt="ti937vJdkYojVL1.png"></p>
<p><img src="https://i.loli.net/2021/07/13/dIJu91GOgZYymq4.png" alt="WwzN8m5tXhKVcID.png"></p>
<p>==4 在视图类中使用的request对象是新的request对象，而老的则是request._request==</p>
<p><img src="https://i.loli.net/2021/07/13/agAH9oRb3P2rOMu.png" alt="dhVZj9XbIBoweHx.png"></p>
<p><img src="https://i.loli.net/2021/07/13/QeqjWh3VfH9w2B5.png" alt="dMvBYCriDjX93z4.png"></p>
<p>==5 新的request对象中有一个属性：data==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">1 data是post请求携带的数据 ---&gt; 字典</span></span><br><span class="line"><span class="string">2 无论是什么编码格式，只要是post提交的数据，都在request.data中</span></span><br><span class="line"><span class="string">3 以后再取值，都从request.data中取</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>==6 结论：继承了APIView后，request对象变成新的request，其他大部分和原来一样使用==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 以后如果使用了drf，继承APIView(drf提供了很多view，他们都是继承自APIView)</span><br><span class="line">	注意：</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    包装出了一个新的request，在视图函数中使用时，跟原先没有区别</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    取post提交的数据，不要再从request.POST中取了，要从request.data中取</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    取get提交的参数，尽量不从request。GET中取了，要从request.query_params中取</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">   </span><br><span class="line"><span class="number">2</span> Request类(drf的)需要掌握</span><br><span class="line">	</span><br><span class="line">    <span class="number">2.1</span> request.data			<span class="comment"># 方法包装成了数据属性</span></span><br><span class="line">    <span class="number">2.2</span> request.query_params	<span class="comment"># 就是request._request.GET</span></span><br><span class="line">    <span class="number">2.3</span> request.FILES			<span class="comment"># 上传的文件</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 大部分用起来和原来一样</span></span><br><span class="line">    </span><br><span class="line"><span class="number">3</span> APIView类</span><br><span class="line">	<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">	包装了新的request</span></span><br><span class="line"><span class="string">	执行了认证、权限、频率...</span></span><br><span class="line"><span class="string">	处理了全局异常</span></span><br><span class="line"><span class="string">	包装了response对象</span></span><br><span class="line"><span class="string">	&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>





<h2 id="drf配置"><a href="#drf配置" class="headerlink" title="drf配置"></a>drf配置</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置</span></span><br><span class="line">    <span class="comment"># 1 后期，drf的所有配置，都写在这个字典中</span></span><br><span class="line">    <span class="comment"># 2 drf有个默认配置文件(drf源码的 ---&gt; setting.py),如果项目的配置文件配置了，优先使用项目的，如果没有配置，使用内置的</span></span><br><span class="line">    <span class="comment"># 3 返回样式的配置，一般不配置</span></span><br><span class="line">    REST_FRAMEWORK=&#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="序列化组件"><a href="#序列化组件" class="headerlink" title="序列化组件"></a>序列化组件</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><strong>作用</strong></p>
 <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 序列化，序列化器(类)会把模型对象(Book对象，Queryset对象)转换成字典，经过response以后变成json字符串</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 反序列化，把客户端发送过来的数据，经过request以后变成字典(request.data)，序列化器(类)可以把字典转成模型</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> 反序列化，完成数据校验功能</span><br></pre></td></tr></table></figure>



<p><strong>本质</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本质就是写一个类，继承一个基类，可以完成序列化、反序列化和数据校验</span></span><br></pre></td></tr></table></figure>



<h3 id="序列化器之Serializer类的使用-跟表模型没有必然联系-5星"><a href="#序列化器之Serializer类的使用-跟表模型没有必然联系-5星" class="headerlink" title="序列化器之Serializer类的使用(跟表模型没有必然联系)(5星)"></a>序列化器之Serializer类的使用(跟表模型没有必然联系)(5星)</h3><p><strong>视图类</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Student</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> Student_serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student_serializers_APIView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 查询所有学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        student_list = Student.objects.<span class="built_in">all</span>()</span><br><span class="line">        ser = Student_serializers(instance=student_list, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 新增学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        ser = Student_serializers(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            ser.save()</span><br><span class="line">            <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student_Detial_serializers_APIView</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="comment"># 查询单个学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        student = Student.objects.<span class="built_in">filter</span>(pk=pk).first()</span><br><span class="line">        ser = Student_serializers(instance=student)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 修改单个学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        student = Student.objects.<span class="built_in">filter</span>(pk=pk).first()</span><br><span class="line">        ser = Student_serializers(instance=student, data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            ser.save()</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 删除单个学生信息</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">self, request, pk</span>):</span></span><br><span class="line">        Student.objects.<span class="built_in">filter</span>(pk=pk).delete()</span><br><span class="line">        <span class="keyword">return</span> Response()</span><br></pre></td></tr></table></figure>



<p><strong>序列化类</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Student</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student_serializers</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    name = serializers.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    age = serializers.IntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        student = Student.objects.create(**validated_data)</span><br><span class="line">        <span class="keyword">return</span> student</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        instance.name = validated_data.get(<span class="string">&#x27;name&#x27;</span>)</span><br><span class="line">        instance.age = validated_data.get(<span class="string">&#x27;age&#x27;</span>)</span><br><span class="line">        instance.save()</span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>



<p><strong>路由</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;student/&#x27;</span>, views.Student_serializers_APIView.as_view()),</span><br><span class="line">    path(<span class="string">&#x27;student/&lt;int:pk&gt;&#x27;</span>, views.Student_Detial_serializers_APIView.as_view())</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



<p><strong>模型</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    name = models.CharField(<span class="string">&#x27;姓名&#x27;</span>, max_length=<span class="number">32</span>)</span><br><span class="line">    age = models.IntegerField(<span class="string">&#x27;年龄&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="Serializers高级使用-5星"><a href="#Serializers高级使用-5星" class="headerlink" title="Serializers高级使用(5星)"></a>Serializers高级使用(5星)</h3><p><strong>1 source字段的作用</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># source：可以对应表模型的字段和方法(返回结果是什么，字段就是什么)</span></span><br><span class="line">	<span class="comment"># 一般用来做一对多，多对多的字段返回</span></span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    注:</span></span><br><span class="line"><span class="string">    	source如果是字段，会显示字段，如果是方法，会执行方法，不用加括号</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<p><strong>2 SerializerMethodFidld使用方法</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一般用来添加需要查询该表以外的其他表(或关联表)的字段、方法</span></span><br><span class="line"></span><br><span class="line">course_detail = serializers.SerializerMethodField()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_course_detail</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">	<span class="keyword">return</span> &#123;<span class="string">&#x27;name&#x27;</span>:obj.course.name,<span class="string">&#x27;teacher&#x27;</span>:obj.course.course_teacher&#125;</span><br></pre></td></tr></table></figure>

<p><strong>3 数据校验</strong></p>
<p>==反序列化时需要进行数据校验==</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;使用序列化器进行反序列化时，需要对数据进行验证后，才能获取验证成功的数据或者保存成模型类对象&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在获取反序列化的数据前，必须调用is_valid()方法进行验证，验证成功返回True，否者返回False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 验证失败，可以通过序列化器对象的error属性获取错误信息，返回字典，包含了字段和字段的错误.如果是非字段错误，可以通过修改REST-framework配置中的NON_FIELD_ERRORS_KEY来控制错误字典中的key值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 验证成功，可以通过序列化器对象validdated_data属性获取数据</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3 字段自己的校验规则</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;图书数据序列化器&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField(label=<span class="string">&#x27;ID&#x27;</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">    btitle = serializers.CharField(label=<span class="string">&#x27;名称&#x27;</span>, max_length=<span class="number">20</span>)</span><br><span class="line">    bpub_date = serializers.DateField(label=<span class="string">&#x27;发布日期&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    bread = serializers.IntegerField(label=<span class="string">&#x27;阅读量&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    bcomment = serializers.IntegerField(label=<span class="string">&#x27;评论量&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    image = serializers.ImageField(label=<span class="string">&#x27;图片&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 3.1 通过构造序列化器对象，并将要反序列化的数据传递给data构造参数，进行验证(views.py)</span></span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">    ser = Publish_modelserializers(request.data)</span><br><span class="line">    <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">        ser.save()</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;msg:ser.errors.get(<span class="string">&#x27;name&#x27;</span>)&#125;)</span><br><span class="line">    </span><br><span class="line">ps: is_valid()方法还会在验证失败时抛出异常serializers.ValidationError，可以通过传递raise_exception=<span class="literal">True</span>参数开启，REST-framework接收到此异常，会向前端返回HTTP <span class="number">400</span> Bad Request</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 3.2 补充定义验证行为</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;注意&#x27;</span></span><br><span class="line">	验证顺序是：字段自己的限制 ---&gt; 自己的局部钩子 ---&gt;(全部字段以及局部验证完毕以后再验证全局钩子)</span><br><span class="line"></span><br><span class="line">	<span class="number">3.2</span><span class="number">.1</span> validate_字段名(局部钩子)</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">validate_name</span>(<span class="params">self,name</span>):</span></span><br><span class="line">        <span class="keyword">if</span> name.startswith(<span class="string">&#x27;sb&#x27;</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;不能以sb开头&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> name</span><br><span class="line">    </span><br><span class="line">    <span class="number">3.2</span><span class="number">.2</span> validate(全局钩子)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        bread = attrs[<span class="string">&#x27;bread&#x27;</span>]</span><br><span class="line">        bcomment = attrs[<span class="string">&#x27;bcomment&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> bread &lt; bcomment:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&#x27;阅读量小于评论量&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line">    </span><br><span class="line">    <span class="number">3.2</span><span class="number">.3</span> validators(在字段中添加validators参数，补充验证行为)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">about_django</span>(<span class="params">value</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;django&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> value.lower():</span><br><span class="line">        <span class="keyword">raise</span> serializers.ValidationError(<span class="string">&quot;图书不是关于Django的&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">BookInfoSerializer</span>(<span class="params">serializers.Serializer</span>):</span></span><br><span class="line">    	<span class="string">&quot;&quot;&quot;图书数据序列化器&quot;&quot;&quot;</span></span><br><span class="line">        <span class="built_in">id</span> = serializers.IntegerField(label=<span class="string">&#x27;ID&#x27;</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">        btitle = serializers.CharField(label=<span class="string">&#x27;名称&#x27;</span>, max_length=<span class="number">20</span>, validators=[about_django])</span><br><span class="line">        bpub_date = serializers.DateField(label=<span class="string">&#x27;发布日期&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">        bread = serializers.IntegerField(label=<span class="string">&#x27;阅读量&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">        bcomment = serializers.IntegerField(label=<span class="string">&#x27;评论量&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">        image = serializers.ImageField(label=<span class="string">&#x27;图片&#x27;</span>, required=<span class="literal">False</span>)</span><br><span class="line">    </span><br></pre></td></tr></table></figure>



<h3 id="模型类序列化器ModelSerializer-跟表模型有关联-5星"><a href="#模型类序列化器ModelSerializer-跟表模型有关联-5星" class="headerlink" title="模型类序列化器ModelSerializer(跟表模型有关联)(5星)"></a>模型类序列化器ModelSerializer(跟表模型有关联)(5星)</h3><p><strong>1 介绍</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">drf为我们提供了一个ModelSerializer模型序列化器来帮助我们快速创建一个Serializer类</span><br></pre></td></tr></table></figure>



<p><strong>2 ModelSerializer与Serializer的区别</strong></p>
<ul>
<li>基于模型类自动生成一系列字段</li>
<li>基于模型类自动为Serializer生成validators，比如unique_together</li>
<li>包含默认的create()和update()的实现</li>
</ul>
<p><strong>3 使用</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Publish_modelserializers</span>(<span class="params">serializers.ModelSerializer</span>):</span>	<span class="comment"># 继承ModelSerializer</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Publish			<span class="comment"># 表模型</span></span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span>		<span class="comment"># 1 序列化的字段</span></span><br><span class="line">        fields = [<span class="string">&#x27;id&#x27;</span>,<span class="string">&#x27;name&#x27;</span>]	<span class="comment"># 2 用来手动指定字段</span></span><br><span class="line">        exclude = [<span class="string">&#x27;id&#x27;</span>]		<span class="comment"># 3 排除的字段(1、2、3只能同时使用一个)</span></span><br><span class="line">        depth					<span class="comment"># 深度，一般不用</span></span><br></pre></td></tr></table></figure>



<p><strong>4 重写字段</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name = serializers.SerializerMethodField()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_name</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;出版社 : &quot;</span> + obj.name</span><br></pre></td></tr></table></figure>



<p><strong>5 扩写字段(表模型中没有的字段)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">	嵌套反序列化时正常只能传pk值，需要两个字段(一个展示(read_only)，一个添加数据(write_only))</span></span><br><span class="line"><span class="string">	否则反序列化嵌套数据时报错</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">name2 = serializers.SerializerMethodField()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_name2</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot; 出版社2:东京出版社&quot;</span></span><br></pre></td></tr></table></figure>



<p><strong>6 反序列化时，字段自己的校验规则，是映射表模型的</strong></p>
<p><strong>7 局部钩子与全局钩子(与Serializer一样)</strong></p>
<p><strong>8 write_only与read_only</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">name=serializers.CharField(write_only=<span class="literal">True</span>)		<span class="comment"># 反序列化的时候使用，序列化时不用(只读)</span></span><br><span class="line"></span><br><span class="line">name=serializers.CharField(read_only=<span class="literal">True</span>)		<span class="comment"># 序列化的时候使用，反序列化时不用(只写)</span></span><br></pre></td></tr></table></figure>



<p><strong>9 extra_kwargs(添加额外参数选项)</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    model = Publish</span><br><span class="line">    fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line">    extra_kwargs = &#123;</span><br><span class="line">        <span class="string">&#x27;name&#x27;</span>:&#123;</span><br><span class="line">            <span class="string">&#x27;required&#x27;</span>:<span class="literal">True</span>,</span><br><span class="line">            <span class="string">&#x27;min_length&#x27;</span>:<span class="number">3</span>,</span><br><span class="line">            <span class="string">&#x27;write_only&#x27;</span>:<span class="literal">True</span></span><br><span class="line">            <span class="string">&#x27;error_messages&#x27;</span>:&#123;</span><br><span class="line">                <span class="string">&#x27;required&#x27;</span>:<span class="string">&#x27;必须填&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;min_length&#x27;</span>:<span class="string">&#x27;最少三位&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">        <span class="string">&#x27;addr&#x27;</span>:&#123;</span><br><span class="line">            <span class="string">&#x27;read_only&#x27;</span>:<span class="literal">True</span></span><br><span class="line">            <span class="string">&#x27;required&#x27;</span>:<span class="literal">True</span></span><br><span class="line">        &#125; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="序列化器字段和字段参数-2星"><a href="#序列化器字段和字段参数-2星" class="headerlink" title="序列化器字段和字段参数(2星)"></a>序列化器字段和字段参数(2星)</h3><p><strong>常用字段类型：</strong></p>
<table>
<thead>
<tr>
<th align="left">字段</th>
<th align="left">字段构造方式</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>BooleanField</strong></td>
<td align="left">BooleanField()</td>
</tr>
<tr>
<td align="left"><strong>NullBooleanField</strong></td>
<td align="left">NullBooleanField()</td>
</tr>
<tr>
<td align="left"><strong>CharField</strong></td>
<td align="left">CharField(max_length=None, min_length=None, allow_blank=False, trim_whitespace=True)</td>
</tr>
<tr>
<td align="left"><strong>EmailField</strong></td>
<td align="left">EmailField(max_length=None, min_length=None, allow_blank=False)</td>
</tr>
<tr>
<td align="left"><strong>RegexField</strong></td>
<td align="left">RegexField(regex, max_length=None, min_length=None, allow_blank=False)</td>
</tr>
<tr>
<td align="left"><strong>SlugField</strong></td>
<td align="left">SlugField(max<em>length=50, min_length=None, allow_blank=False) 正则字段，验证正则模式 [a-zA-Z0-9</em>-]+</td>
</tr>
<tr>
<td align="left"><strong>URLField</strong></td>
<td align="left">URLField(max_length=200, min_length=None, allow_blank=False)</td>
</tr>
<tr>
<td align="left"><strong>UUIDField</strong></td>
<td align="left">UUIDField(format=’hex_verbose’) format: 1) <code>&#39;hex_verbose&#39;</code> 如<code>&quot;5ce0e9a5-5ffa-654b-cee0-1238041fb31a&quot;</code> 2） <code>&#39;hex&#39;</code> 如 <code>&quot;5ce0e9a55ffa654bcee01238041fb31a&quot;</code> 3）<code>&#39;int&#39;</code> - 如: <code>&quot;123456789012312313134124512351145145114&quot;</code> 4）<code>&#39;urn&#39;</code> 如: <code>&quot;urn:uuid:5ce0e9a5-5ffa-654b-cee0-1238041fb31a&quot;</code></td>
</tr>
<tr>
<td align="left"><strong>IPAddressField</strong></td>
<td align="left">IPAddressField(protocol=’both’, unpack_ipv4=False, **options)</td>
</tr>
<tr>
<td align="left"><strong>IntegerField</strong></td>
<td align="left">IntegerField(max_value=None, min_value=None)</td>
</tr>
<tr>
<td align="left"><strong>FloatField</strong></td>
<td align="left">FloatField(max_value=None, min_value=None)</td>
</tr>
<tr>
<td align="left"><strong>DecimalField</strong></td>
<td align="left">DecimalField(max_digits, decimal_places, coerce_to_string=None, max_value=None, min_value=None) max_digits: 最多位数 decimal_palces: 小数点位置</td>
</tr>
<tr>
<td align="left"><strong>DateTimeField</strong></td>
<td align="left">DateTimeField(format=api_settings.DATETIME_FORMAT, input_formats=None)</td>
</tr>
<tr>
<td align="left"><strong>DateField</strong></td>
<td align="left">DateField(format=api_settings.DATE_FORMAT, input_formats=None)</td>
</tr>
<tr>
<td align="left"><strong>TimeField</strong></td>
<td align="left">TimeField(format=api_settings.TIME_FORMAT, input_formats=None)</td>
</tr>
<tr>
<td align="left"><strong>DurationField</strong></td>
<td align="left">DurationField()</td>
</tr>
<tr>
<td align="left"><strong>ChoiceField</strong></td>
<td align="left">ChoiceField(choices) choices与Django的用法相同</td>
</tr>
<tr>
<td align="left"><strong>MultipleChoiceField</strong></td>
<td align="left">MultipleChoiceField(choices)</td>
</tr>
<tr>
<td align="left"><strong>FileField</strong></td>
<td align="left">FileField(max_length=None, allow_empty_file=False, use_url=UPLOADED_FILES_USE_URL)</td>
</tr>
<tr>
<td align="left"><strong>ImageField</strong></td>
<td align="left">ImageField(max_length=None, allow_empty_file=False, use_url=UPLOADED_FILES_USE_URL)</td>
</tr>
<tr>
<td align="left"><strong>ListField</strong></td>
<td align="left">ListField(child=, min_length=None, max_length=None)</td>
</tr>
<tr>
<td align="left"><strong>DictField</strong></td>
<td align="left">DictField(child=)</td>
</tr>
</tbody></table>
<p><strong>选项参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><strong>max_length</strong></td>
<td>最大长度</td>
</tr>
<tr>
<td><strong>min_lenght</strong></td>
<td>最小长度</td>
</tr>
<tr>
<td><strong>allow_blank</strong></td>
<td>是否允许为空</td>
</tr>
<tr>
<td><strong>trim_whitespace</strong></td>
<td>是否截断空白字符</td>
</tr>
<tr>
<td><strong>max_value</strong></td>
<td>最小值</td>
</tr>
<tr>
<td><strong>min_value</strong></td>
<td>最大值</td>
</tr>
</tbody></table>
<p><strong>通用参数：</strong></p>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><strong>read_only</strong></td>
<td>表明该字段仅用于序列化输出，默认False</td>
</tr>
<tr>
<td><strong>write_only</strong></td>
<td>表明该字段仅用于反序列化输入，默认False</td>
</tr>
<tr>
<td><strong>required</strong></td>
<td>表明该字段在反序列化时必须输入，默认True</td>
</tr>
<tr>
<td><strong>default</strong></td>
<td>反序列化时使用的默认值</td>
</tr>
<tr>
<td><strong>allow_null</strong></td>
<td>表明该字段是否允许传入None，默认False</td>
</tr>
<tr>
<td><strong>validators</strong></td>
<td>该字段使用的验证器</td>
</tr>
<tr>
<td><strong>error_messages</strong></td>
<td>包含错误编号与错误信息的字典</td>
</tr>
<tr>
<td><strong>label</strong></td>
<td>用于HTML展示API页面时，显示的字段名称</td>
</tr>
<tr>
<td><strong>help_text</strong></td>
<td>用于HTML展示API页面时，显示的字段帮助提示信息</td>
</tr>
</tbody></table>
<h3 id="局部钩子和全局钩子源码分析-2星"><a href="#局部钩子和全局钩子源码分析-2星" class="headerlink" title="局部钩子和全局钩子源码分析(2星)"></a>局部钩子和全局钩子源码分析(2星)</h3><p><strong>1 入口是ser.is_valid()，是BaseSerializer的方法</strong></p>
<p><img src="https://i.loli.net/2021/07/13/6AsePhQvJu24LN8.png" alt="7dILKc5ksVWO4NR.png"></p>
<p><strong>2 找到全局钩子</strong></p>
<p><img src="https://i.loli.net/2021/07/13/woCEI1bMDNhiSLA.png" alt="OdbuBatSUYpG73C.png"></p>
<p><strong>3 找到局部钩子</strong></p>
<p><img src="https://i.loli.net/2021/07/13/EhTM4U1DFjuiPJl.png" alt="OHmK9NrponcjDXq.png"></p>
<p><img src="https://i.loli.net/2021/07/13/IYUbC436jgFuxtQ.png" alt="ImHyxpcjvD14gXC.png"></p>
<h3 id="序列化组件部分源码分析-2星"><a href="#序列化组件部分源码分析-2星" class="headerlink" title="序列化组件部分源码分析(2星)"></a>序列化组件部分源码分析(2星)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前戏：对象的实例化过程：__new__在__init__之前执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1 序列化类在实例化的时候，先调用的是BaseSerializer中的__new__方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 ListSerializer与自己Serializer有什么联系？</span></span><br><span class="line">	[ser1,ser2,ser3]	ser</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/07/13/m7FdZEayzqhvXjC.png" alt="jgpMR7V3YW6BIdn.png"></p>
<p><img src="https://i.loli.net/2021/07/13/B4JjeihOfHAXU6z.png" alt="HxlAO1sVUpLuiq6.png"></p>
<h2 id="请求与响应-3星"><a href="#请求与响应-3星" class="headerlink" title="请求与响应(3星)"></a>请求与响应(3星)</h2><h3 id="drf请求全局和局部配置"><a href="#drf请求全局和局部配置" class="headerlink" title="drf请求全局和局部配置"></a>drf请求全局和局部配置</h3><p><strong>请求默认支持三种编码格式</strong></p>
<ul>
<li>urlencoded</li>
<li>json</li>
<li>formdata</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认支持三种</span></span><br><span class="line"></span><br><span class="line">   <span class="string">&#x27;DEFAULT_PARSER_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.JSONParser&#x27;</span>,  	 <span class="comment"># 解析application/json格式</span></span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.FormParser&#x27;</span>, 	 <span class="comment"># 解析application/x-www-form-urlencoded</span></span><br><span class="line">        <span class="string">&#x27;rest_framework.parsers.MultiPartParser&#x27;</span> <span class="comment"># multipart/form-data</span></span><br><span class="line">    ]</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ViewSetMixin,ListAPIView,CreateAPIView</span>):</span></span><br><span class="line">    parser_classes = [JSONParser,]</span><br></pre></td></tr></table></figure>





<h3 id="Request"><a href="#Request" class="headerlink" title="Request"></a>Request</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rest-framework基于Django的request封装了一个新的Request类的request对象</span></span><br><span class="line">	rest-framework传入视图的request对象不再是Django默认的HttpRequest对象，而是rest-framework提供的扩展的HttpRequest类的Request类的对象</span><br><span class="line"></span><br><span class="line"><span class="comment"># Request对象的数据是根据前端发送数据的格式进行解析之后的结果(无论前端发送哪种格式的数据，都可以用统一的方式读取数据)</span></span><br><span class="line">	rest-framework提供了Parser解析器，在接收到请求后会自动根据Content-<span class="type">Type</span>指明的请求数据类型(如JSON、表单类型数据等)将请求数据进行parse解析，解析为类字典(QueryDict)对象保存在Request对象中</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 常用属性</span></span><br><span class="line">	<span class="number">1</span> request.data:</span><br><span class="line">        包含了对POST、PUT、PATCH请求方式解析后的数据</span><br><span class="line">        利用了rest-framework的parsers解析器，不仅支持表单类型数据，也支持JSON类型数据</span><br><span class="line">        </span><br><span class="line">    <span class="number">2</span> request.query_params</span><br><span class="line">    	request.query_params与Django的request.GET相同，只是更换了更正确的名字</span><br><span class="line">    </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">重点：</span></span><br><span class="line"><span class="string">	1 继承APIView后，视图类中的request对象是新的request对象</span></span><br><span class="line"><span class="string">	2 request.data、request.query_params的使用</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="Response"><a href="#Response" class="headerlink" title="Response"></a>Response</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># drf中的Response对象</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 继承关系：Response---&gt; SimSimpleTemplateResponse ---&gt; django的HttpResponse</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 属性、参数</span></span><br><span class="line">	</span><br><span class="line">    data=<span class="literal">None</span>				<span class="comment"># ser.data，传字典或列表，序列化成json格式字符串给前端</span></span><br><span class="line">    status=<span class="literal">None</span>				<span class="comment"># 状态码，http响应的状态码</span></span><br><span class="line">    template_name=<span class="literal">None</span>		<span class="comment"># 模板名字，在浏览器访问，看到的好看的模板(自定制)(用得少)</span></span><br><span class="line">    headers=<span class="literal">None</span>			<span class="comment"># 响应头，字典</span></span><br><span class="line">    exception=<span class="literal">False</span>			<span class="comment"># 异常(不用管)</span></span><br><span class="line">    content_type=<span class="literal">None</span>		<span class="comment"># 响应编码类型</span></span><br><span class="line">    </span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    重点：</span></span><br><span class="line"><span class="string">    	data</span></span><br><span class="line"><span class="string">    	status</span></span><br><span class="line"><span class="string">    	headers</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 使用</span></span><br><span class="line">	response=&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;查询成功&#x27;</span>, <span class="string">&#x27;request&#x27;</span>:ser.data&#125;</span><br><span class="line">    <span class="keyword">return</span> Response(response,status=status.HTTP_201_CREATED,headers=&#123;<span class="string">&#x27;xxx&#x27;</span>:<span class="string">&quot;xxx&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置</span></span><br><span class="line">	<span class="number">1</span> 通过配置，设置响应格式(浏览器模板样子、纯json)</span><br><span class="line">    <span class="comment"># 1 后期，drf的所有配置，都写在这个字典中</span></span><br><span class="line">    <span class="comment"># 2 drf有个默认配置文件(drf源码的 ---&gt; setting.py),如果项目的配置文件配置了，优先使用项目的，如果没有配置，使用内置的</span></span><br><span class="line">    <span class="comment"># 3 返回样式的配置，一般不配置</span></span><br><span class="line">    REST_FRAMEWORK=&#123;</span><br><span class="line">        <span class="comment">#配置响应格式，默认有俩（json，浏览器的）</span></span><br><span class="line">         <span class="string">&#x27;DEFAULT_RENDERER_CLASSES&#x27;</span>: [</span><br><span class="line">            <span class="string">&#x27;rest_framework.renderers.JSONRenderer&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;rest_framework.renderers.BrowsableAPIRenderer&#x27;</span>,</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="number">2</span> 局部配置(只针对某一个视图函数)</span><br><span class="line">    	在视图类上写</span><br><span class="line">        	renderer_classes = [JSONRenderer]</span><br><span class="line">    <span class="number">3</span> 配置的三个层次(优先级)</span><br><span class="line">    	局部 ---&gt; 项目 ---&gt; drf默认</span><br></pre></td></tr></table></figure>



<h2 id="视图组件-5星"><a href="#视图组件-5星" class="headerlink" title="视图组件(5星)"></a>视图组件(5星)</h2><p><img src="https://i.loli.net/2021/07/13/QeyDj2BmxElJbg8.png" alt="Uc5s1hblaJnoNqA.png"></p>
<h3 id="两个视图基类"><a href="#两个视图基类" class="headerlink" title="两个视图基类"></a>两个视图基类</h3><h4 id="APIView"><a href="#APIView" class="headerlink" title="APIView"></a><strong>APIView</strong></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># APIView 是rest-framework提供的所有视图的基类，继承自Django的View父类</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在APIView中仍以常规的类视图定义方法来实现get()、post()...请求方式的方法</span></span><br></pre></td></tr></table></figure>



<p><strong>APIView与View的区别</strong></p>
<ul>
<li>传入到视图方法中的是rest-framework的Request类的request对象，而不是Django的HttpResponse对象</li>
<li>视图方法返回的是rest-framework的Response类的response对象，视图会因为响应数据设置(rander)符合前端要求的格式</li>
<li>任何APIException异常都会被捕获到，并处理成合适的响应信息</li>
<li>在进行dispatch()分发前，会对请求进行身份认证、权限检查、流量控制</li>
</ul>
<p><strong>支持定义的类属性</strong></p>
<ul>
<li>authentication_classes列表或元组（身份认证类）</li>
<li>permissoin_classes列表或元组（权限检查类）</li>
<li>throttle_classes列表或元组（流量/频率控制类）</li>
</ul>
<h4 id="GenericAPIView-通用视图类"><a href="#GenericAPIView-通用视图类" class="headerlink" title="GenericAPIView(通用视图类)"></a>GenericAPIView(通用视图类)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 继承自APIView，主要增加了操作序列化器和数据库查询的方法，作用是为Mixin扩展类的执行提供方法支持，通常在使用时，可搭配一个或多个Mixin扩展类</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">涉及到数据库操作，尽量选择GenericAPIView，减少代码量</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<p><strong>提供的关于序列化器使用的属性与方法</strong></p>
<ul>
<li>属性<ul>
<li>==serializer_class==                                            : 指明视图使用的序列化器</li>
</ul>
</li>
<li>方法<ul>
<li>==get_serializer_class(self)==                            : 当出现一个视图类中调用多个序列化器时，可以通过条件判断get_serializer_class方法中通过返回不同的序列器类名，就可以让视图方法执行不同的序列化器对象了</li>
<li>==get_serializer(self, *args, **kwargs)==        : 返回序列化器对象，主要用来提供给Mixin扩展类使用（该方法在提供序列化器对象的时候，会向序列化器对象的context属性补充三个数据：request、format、view，这三个数据对象可以在定义序列化器时使用）(可以传instance、data、many)<ul>
<li>request    ：当前视图的请求对象</li>
<li>view          ：当前请求的类视图对象</li>
<li>format      ：当前请求期望返回的数据格式</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>提供的关于数据库查询的属性与方法</strong></p>
<ul>
<li>属性<ul>
<li>==queryset==                        ：查询的表名.objects.all()    (这里不写all会自动添加上all，但推荐都写上)</li>
</ul>
</li>
<li>方法<ul>
<li>==get_queryset(self)==         ：获取查询需要用到的所有数据</li>
<li>==get_object(self)==              ：获取查询需要用到的单条数据    （若详情访问的模型类对象不存在，会返回404）</li>
</ul>
</li>
</ul>
<h3 id="五个视图扩展类"><a href="#五个视图扩展类" class="headerlink" title="五个视图扩展类"></a>五个视图扩展类</h3><p><strong>这五个扩展类需要搭配GenericAPIView父类，因为五个扩展类的实现需要调用GenericAPIView提供的序列化器与数据库查询的方法</strong></p>
<p><strong>CreateModelMixin</strong></p>
<ul>
<li>内部有create方法     ：新增</li>
</ul>
<p><strong>ListModelMixin</strong></p>
<ul>
<li>内部有list方法            ：查询所有</li>
</ul>
<p><strong>DestroyModelMixin</strong></p>
<ul>
<li>内部有destroy方法    ：删除单条</li>
</ul>
<p><strong>UpdateModelMixin</strong></p>
<ul>
<li>内部有update方法    ：修改一条</li>
</ul>
<p><strong>RetrieveModelMixin</strong></p>
<ul>
<li>内部有retrieve方法    ：查询单条</li>
</ul>
<h3 id="九个视图子类"><a href="#九个视图子类" class="headerlink" title="九个视图子类"></a>九个视图子类</h3><p><strong>ListAPIView</strong>            </p>
<ul>
<li>list</li>
</ul>
<p><strong>CreateAPIView</strong></p>
<ul>
<li>create</li>
</ul>
<p><strong>UpdateAPIView</strong></p>
<ul>
<li>update</li>
</ul>
<p><strong>DestroyAPIView</strong></p>
<ul>
<li>destroy</li>
</ul>
<p><strong>RetrieveAPIView</strong></p>
<ul>
<li>retrieve</li>
</ul>
<p><strong>ListCreateAPIView</strong></p>
<ul>
<li>list+create</li>
</ul>
<p><strong>RetrieveUpdateDestroyAPIView</strong></p>
<ul>
<li>retrieve+update+destroy</li>
</ul>
<p><strong>RetrieveDestroyAPIView</strong></p>
<ul>
<li>retrieve+destroy</li>
</ul>
<p><strong>RetrieveUpdateAPIView</strong></p>
<ul>
<li>retrieve+update</li>
</ul>
<h3 id="视图集"><a href="#视图集" class="headerlink" title="视图集"></a>视图集</h3><p><strong>ViewSetMixin</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 核心：重写了as_view方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 能够实现：请求方式和视图类中方法的映射</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结论：只要继承ViewSetMixin的视图类，路由中as_view()里就要传action参数(字典)</span></span><br><span class="line"></span><br><span class="line">例</span><br><span class="line">	path(<span class="string">&#x27;books/&#x27;</span>, views.BookView.as_view(&#123;<span class="string">&#x27;get&#x27;</span>:<span class="string">&#x27;list&#x27;</span>,<span class="string">&#x27;post&#x27;</span>:<span class="string">&#x27;create&#x27;</span>&#125;))</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2021/07/13/b4dw7anUz5fkYvg.png" alt="Pt2UsRL61ycJu8W.png"></p>
<p><strong>ViewSet</strong></p>
<ul>
<li>继承自APIView与ViewSetMixin，作用与APIView类似，提供了身份认证、权限校验、流量管理…</li>
<li>主要通过继承ViewSetMixin来实现在调用as_view()时传入字典的映射处理</li>
<li>没有提供任何动作action方法，需要我们自己实现action方法</li>
<li>需要自己编写list、retrieve、create、update、destroy等方法</li>
</ul>
<p><strong>GeneriViewSet</strong></p>
<ul>
<li>继承自GenericAPIView与ViewSetMixin</li>
<li>实现了调用as_view()时传入字典的映射处理</li>
<li>提供了GenericAPIView提供的基础方法，可以直接搭配Mixin扩展类使用</li>
</ul>
<p><strong>ModelViewSet</strong></p>
<ul>
<li>继承自GenericViewSet，包括了五个视图扩展类</li>
</ul>
<p><strong>ReadOnlyModelViewSet</strong></p>
<ul>
<li>继承自GenericViewSet，包括了ListModelMixin、RetrieveModelMixin</li>
</ul>
<h2 id="路由组件-5星"><a href="#路由组件-5星" class="headerlink" title="路由组件(5星)"></a>路由组件(5星)</h2><h3 id="Routers"><a href="#Routers" class="headerlink" title="Routers"></a>Routers</h3><p><strong>对于视图集ViewSet，我们除了可以自己手动指明请求方式与动作action之间的对应关系外，还可以使用Routers来快速实现路由创建</strong></p>
<ul>
<li><p>SimpleRouter(常用)</p>
</li>
<li><p>DefaultRouter(多了一些花里胡哨的路由，用得少)</p>
</li>
</ul>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> SimpleRouter</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = SimpleRouter()</span><br><span class="line">router.register(<span class="string">&#x27;book&#x27;</span>, views.Book_modelviewset)</span><br><span class="line">router.register(<span class="string">&#x27;publish&#x27;</span>, views.Publish_modelviewset)</span><br><span class="line">router.register(<span class="string">&#x27;&#x27;</span>, views.Login, basename=<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls))		<span class="comment"># 方式一</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns += router.urls				<span class="comment"># 方式二(选一种使用)</span></span><br></pre></td></tr></table></figure>



<h3 id="试图类中派生的方法，自动生成路由-action"><a href="#试图类中派生的方法，自动生成路由-action" class="headerlink" title="试图类中派生的方法，自动生成路由(action)"></a>试图类中派生的方法，自动生成路由(action)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span>(<span class="params">ViewSetMixin, APIView</span>):</span></span><br><span class="line">    authentication_classes = []</span><br><span class="line">    permission_classes = []</span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>], detail=<span class="literal">False</span></span>)		</span><span class="comment"># 自己扩展的方法(派生)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self, request, *args, **kwargs</span>):</span>	</span><br><span class="line">        username = request.data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        user_alive = models.User.objects.<span class="built_in">filter</span>(username=username, password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user_alive:</span><br><span class="line">            token = uuid.uuid4()</span><br><span class="line">            models.User_token.objects.update_or_create(defaults=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;, user=user_alive)</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>, <span class="string">&#x27;token&#x27;</span>:token&#125;, headers=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">101</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录失败&#x27;</span>&#125;)</span><br><span class="line">        </span><br><span class="line"><span class="comment"># 这样自动生成的路由是(books/login/) (如果prefix参数传空字符串，则是/login/)</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">参数解释：</span></span><br><span class="line"><span class="string">	method：		用来指定请求方式，默认GET</span></span><br><span class="line"><span class="string">	detail：		用来指定是否传入pk值(如：查所有或查单条)，False：不传pk，True：传pk</span></span><br><span class="line"><span class="string">	url_path：	用来指定url的路径，默认方法名</span></span><br><span class="line"><span class="string">	url_name：	用来指定url的别名</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">	1 如果继承了APIView，那么想要自动创建路由，则必须写action动作并在urls.py中传basename参数来指定视图</span></span><br><span class="line"><span class="string">	</span></span><br><span class="line"><span class="string">	2 必须继承ViewSetMixin</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="认证组件-5星"><a href="#认证组件-5星" class="headerlink" title="认证组件(5星)"></a>认证组件(5星)</h2><p><strong>判断用户是否登录</strong></p>
<h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># auth.py(自己建的任意名称的py文件)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> AuthenticationFailed</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login_authentication</span>(<span class="params">BaseAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        token = request.META.get(<span class="string">&#x27;HTTP_TOKEN&#x27;</span>)</span><br><span class="line">        user_token = models.User_token.objects.<span class="built_in">filter</span>(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> user_token:</span><br><span class="line">            <span class="keyword">return</span> user_token.user, token</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;请先登录&#x27;</span>)</span><br><span class="line">            </span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span>(<span class="params">ViewSetMixin, APIView</span>):</span></span><br><span class="line">    authentication_classes = [Login_authentication]		<span class="comment"># 局部使用</span></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>], detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        username = request.data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        user_alive = models.User.objects.<span class="built_in">filter</span>(username=username, password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user_alive:</span><br><span class="line">            token = uuid.uuid4()</span><br><span class="line">            models.User_token.objects.update_or_create(defaults=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;, user=user_alive)</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>, <span class="string">&#x27;token&#x27;</span>:token&#125;, headers=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">101</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录失败&#x27;</span>&#125;)</span><br><span class="line">        </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">全局配置：</span></span><br><span class="line"><span class="string">	REST_FRAMEWORK = &#123;</span></span><br><span class="line"><span class="string">    &#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;:[</span></span><br><span class="line"><span class="string">        &#x27;app01.auth.Login_authentication&#x27;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">局部禁用：</span></span><br><span class="line"><span class="string">	authentication_classes = []</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p><img src="https://i.loli.net/2021/07/13/gqlwv4FA9zBQGXT.png" alt="YcjEfW3CunFB9K4.png"></p>
<p><img src="https://i.loli.net/2021/07/13/vweS9dPYl3K2xjG.png" alt="image-20210705201337157.png"></p>
<p><img src="https://i.loli.net/2021/07/13/eJ4IxpXt9kKEDBl.png" alt="image-20210705201527608.png"></p>
<p><img src="https://i.loli.net/2021/07/13/HcPUrQDSewfILgj.png" alt="image-20210705201731741.png"></p>
<p><img src="https://i.loli.net/2021/07/13/CUnOqhfimyIgFba.png" alt="image-20210705205949346.png"></p>
<p><img src="https://i.loli.net/2021/07/13/OhcDHgkxtCB9Nna.png" alt="image-20210705210247174.png"></p>
<p><img src="https://i.loli.net/2021/07/13/w6uOeFcSjZGRCVk.png" alt="image-20210705210417976.png"></p>
<p><img src="https://i.loli.net/2021/07/13/17opTiSPhMu8Vsg.png" alt="image-20210705210543266.png"></p>
<p><img src="https://i.loli.net/2021/07/13/NAPy8owlSkOWgUJ.png" alt="image-20210705210958562.png"></p>
<h2 id="权限组件-4星"><a href="#权限组件-4星" class="headerlink" title="权限组件(4星)"></a>权限组件(4星)</h2><h3 id="简单使用-1"><a href="#简单使用-1" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自己建的任意名字的py文件(auth.py)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> PermissionDenied</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User_permission</span>(<span class="params">BasePermission</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">if</span> models.User.user_type == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> PermissionDenied(request.user.get_user_type_display()+<span class="string">&#x27;权限不够&#x27;</span>)</span><br><span class="line">            </span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span>(<span class="params">ViewSetMixin, APIView</span>):</span></span><br><span class="line">    permission_classes = [User_permission]		<span class="comment"># 局部使用</span></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>], detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        username = request.data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = request.data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        user_alive = models.User.objects.<span class="built_in">filter</span>(username=username, password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user_alive:</span><br><span class="line">            token = uuid.uuid4()</span><br><span class="line">            models.User_token.objects.update_or_create(defaults=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;, user=user_alive)</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>, <span class="string">&#x27;token&#x27;</span>:token&#125;, headers=&#123;<span class="string">&#x27;token&#x27;</span>:token&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(&#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">101</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录失败&#x27;</span>&#125;)</span><br><span class="line">        </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">全局配置：</span></span><br><span class="line"><span class="string">	REST_FRAMEWORK = &#123;</span></span><br><span class="line"><span class="string">    &#x27;DEFAULT_PERMISSION_CLASSES&#x27;:[</span></span><br><span class="line"><span class="string">        &#x27;app01.auth.User_permission&#x27;</span></span><br><span class="line"><span class="string">    ]</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">局部禁用：</span></span><br><span class="line"><span class="string">	permission_classes = []	</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h3><p><img src="https://i.loli.net/2021/07/13/5meHTn9RJ74dFvA.png" alt="image-20210706172319765.png"></p>
<p><img src="https://i.loli.net/2021/07/13/oVFkBWeUsM1Qj5G.png" alt="image-20210706173120291.png"></p>
<h2 id="频率组件-5星"><a href="#频率组件-5星" class="headerlink" title="频率组件(5星)"></a>频率组件(5星)</h2><h3 id="自定义频率类"><a href="#自定义频率类" class="headerlink" title="自定义频率类"></a>自定义频率类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自定义的逻辑</span></span><br><span class="line"><span class="comment">#（1）取出访问者ip</span></span><br><span class="line"><span class="comment">#（2）判断当前ip不在访问字典里，添加进去，并且直接返回True,表示第一次访问，在字典里，继续往下走</span></span><br><span class="line"><span class="comment">#（3）循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据pop掉，这样列表中只有60s以内的访问时间，</span></span><br><span class="line"><span class="comment">#（4）判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返回True，顺利通过</span></span><br><span class="line"><span class="comment">#（5）当大于等于3，说明一分钟内访问超过三次，返回False验证失败</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThrottles</span>():</span></span><br><span class="line">    VISIT_RECORD = &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.history=<span class="literal">None</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span>(<span class="params">self,request, view</span>):</span></span><br><span class="line">        <span class="comment">#（1）取出访问者ip</span></span><br><span class="line">        <span class="comment"># print(request.META)</span></span><br><span class="line">        ip=request.META.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        ctime=time.time()</span><br><span class="line">        <span class="comment"># （2）判断当前ip不在访问字典里，添加进去，并且直接返回True,表示第一次访问</span></span><br><span class="line">        <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> self.VISIT_RECORD:</span><br><span class="line">            self.VISIT_RECORD[ip]=[ctime,]</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        self.history=self.VISIT_RECORD.get(ip)</span><br><span class="line">        <span class="comment"># （3）循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据pop掉，这样列表中只有60s以内的访问时间，</span></span><br><span class="line">        <span class="keyword">while</span> self.history <span class="keyword">and</span> ctime-self.history[-<span class="number">1</span>]&gt;<span class="number">60</span>:</span><br><span class="line">            self.history.pop()</span><br><span class="line">        <span class="comment"># （4）判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返回True，顺利通过</span></span><br><span class="line">        <span class="comment"># （5）当大于等于3，说明一分钟内访问超过三次，返回False验证失败</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.history)&lt;<span class="number">3</span>:</span><br><span class="line">            self.history.insert(<span class="number">0</span>,ctime)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        ctime=time.time()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">60</span>-(ctime-self.history[-<span class="number">1</span>])</span><br></pre></td></tr></table></figure>





<h3 id="简单使用-2"><a href="#简单使用-2" class="headerlink" title="简单使用"></a>简单使用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># until.py(任意名称py文件)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User_throttle</span>(<span class="params">SimpleRateThrottle</span>):</span></span><br><span class="line">    scope = <span class="string">&#x27;user&#x27;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_cache_key</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">return</span> request.user.username		<span class="comment"># 返回谁，就以谁做限制</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line">throttle_classes = [User_base_throttle,]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>:<span class="string">&#x27;5/m&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 局部禁用</span></span><br><span class="line">throttle_classes = []</span><br></pre></td></tr></table></figure>



<h3 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h3><p><img src="https://i.loli.net/2021/07/13/5meHTn9RJ74dFvA.png" alt="image-20210706172319765.png"></p>
<p><img src="https://i.loli.net/2021/07/13/Kidfat1knMlF9cm.png" alt="image-20210706185151028.png"></p>
<p><img src="https://i.loli.net/2021/07/13/RJe7km51WZrF3DT.png" alt="image-20210706185449845.png"></p>
<p><img src="https://i.loli.net/2021/07/13/kBc9h3lorAyULSe.png" alt="image-20210706185753175.png"></p>
<p><img src="https://i.loli.net/2021/07/13/IiENjoSODkslCHL.png" alt="image-20210706190151150.png"></p>
<p><img src="https://i.loli.net/2021/07/13/WL9pSrasuU7iOJF.png" alt="image-20210706190316846.png"></p>
<h2 id="过滤与排序-4星"><a href="#过滤与排序-4星" class="headerlink" title="过滤与排序(4星)"></a>过滤与排序(4星)</h2><h3 id="简单使用-3"><a href="#简单使用-3" class="headerlink" title="简单使用"></a>简单使用</h3><p><strong>==查询所有==才需要过滤（根据条件过滤），排序（按某个规则排序）</strong></p>
<p><strong>内置类使用</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 内置过滤类(在视图类中配置)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.filters <span class="keyword">import</span> SearchFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ViewSetMixin,ListAPIView</span>):</span></span><br><span class="line">    <span class="comment"># 在视图类中配置，最顶层的类至少是GenericAPIView</span></span><br><span class="line">    filter_backends = [SearchFilter,]</span><br><span class="line">    <span class="comment"># 过滤条件，按名字过滤</span></span><br><span class="line">    search_fields=[<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;publish&#x27;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 查询使用</span></span><br><span class="line">	http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/books/?search=达   <span class="comment"># 出版社中或名字中有 达 就能查询出来</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 内置排序类(既有排序，又有过滤)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.filters <span class="keyword">import</span> OrderingFilter,SearchFilter</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ViewSetMixin,ListAPIView</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在视图类中配置，最顶层的类至少是GenericAPIView</span></span><br><span class="line">    filter_backends = [SearchFilter,OrderingFilter,]</span><br><span class="line">    <span class="comment"># 过滤条件，按名字过滤</span></span><br><span class="line">    search_fields=[<span class="string">&#x27;name&#x27;</span>]</span><br><span class="line">    <span class="comment"># 按哪个字段排序</span></span><br><span class="line">    ordering_fields=[<span class="string">&#x27;price&#x27;</span>,<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询使用</span></span><br><span class="line">	http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/books/?ordering=price,-<span class="built_in">id</span></span><br></pre></td></tr></table></figure>



<p><strong>第三方插件使用（django-filter）</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 视图类中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ViewSetMixin,ListAPIView</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在视图类中配置，最顶层的类至少是GenericAPIView</span></span><br><span class="line">    filter_backends = [DjangoFilterBackend,]</span><br><span class="line">    <span class="comment"># 按名字、价格过滤</span></span><br><span class="line">    filter_fields=[<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;price&#x27;</span>]</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 查询时</span></span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/books/?name=红楼梦</span><br><span class="line">http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8000</span>/books/?name=四方达&amp;price=<span class="number">15</span></span><br></pre></td></tr></table></figure>



<h2 id="异常处理-4星"><a href="#异常处理-4星" class="headerlink" title="异常处理(4星)"></a>异常处理(4星)</h2><h3 id="简单使用-4"><a href="#简单使用-4" class="headerlink" title="简单使用"></a>简单使用</h3><p><strong>全局统一捕获异常，返回固定的格式</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用步骤</span></span><br><span class="line">	<span class="number">1</span> 写一个函数</span><br><span class="line">    <span class="number">2</span> 在配置文件中配置</span><br><span class="line">    </span><br><span class="line"><span class="number">1</span> 写函数：</span><br><span class="line"></span><br><span class="line">	<span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> exception_handler</span><br><span class="line">	<span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">comment_exception_handler</span>(<span class="params">exc, context</span>):</span></span><br><span class="line">    response = exception_handler(exc, context)</span><br><span class="line">    <span class="keyword">if</span> response:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>:<span class="number">1001</span>,</span><br><span class="line">            <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;错误&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;detail&#x27;</span>:response.data</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Response(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">&#x27;code&#x27;</span>:<span class="number">1002</span>,</span><br><span class="line">            <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;未知错误&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Response(data)</span><br><span class="line">    </span><br><span class="line"><span class="number">2</span> 在配置文件中配置</span><br><span class="line"></span><br><span class="line">    REST_FRAMEWORK = &#123;</span><br><span class="line">        <span class="string">&#x27;EXCEPTION_HANDLER&#x27;</span>:<span class="string">&#x27;utils.comment_exception_handler&#x27;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="分页功能-5星"><a href="#分页功能-5星" class="headerlink" title="分页功能(5星)"></a>分页功能(5星)</h2><p><strong>查询所有，才有分页功能（例如网站的下一页功能，app的下滑加载更多）</strong></p>
<h3 id="PageNumberPagination基本分页"><a href="#PageNumberPagination基本分页" class="headerlink" title="PageNumberPagination基本分页"></a>PageNumberPagination基本分页</h3><ul>
<li>重要类属性<ul>
<li>page_size = api_settings.PAGE_SIZE        （每页显示条数）</li>
<li>page_query_param = ‘page’                      （查询时用的参数）</li>
<li>page_size_query_param  = None             （更改返回条数）</li>
<li>max_page_size = None                               （每页最大显示条数）</li>
</ul>
</li>
<li>使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 写一个类，继承PageNumberPagination，重写4个类属性</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonPageNumberPagination</span>(<span class="params">PageNumberPagination</span>):</span></span><br><span class="line">    page_size = <span class="number">2</span></span><br><span class="line">    page_query_param = <span class="string">&#x27;page&#x27;</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;search&#x27;</span></span><br><span class="line">    max_page_size = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 2 在视图类中配置写好的分页类</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAPIView</span>(<span class="params">ViewSetMixin, ListAPIView</span>):</span></span><br><span class="line">    queryset = models.Books.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookModelSerializer</span><br><span class="line">    pagination_class = CommonPageNumberPagination</span><br></pre></td></tr></table></figure>



<h3 id="LimitOffsetPagination偏移分页"><a href="#LimitOffsetPagination偏移分页" class="headerlink" title="LimitOffsetPagination偏移分页"></a>LimitOffsetPagination偏移分页</h3><ul>
<li>重要的类属性<ul>
<li>default_limit = api_settings.PAGE_SIZE                （每页显示条数）</li>
<li>limit_query_param = ‘limit’                                    （查询时用的参数）</li>
<li>offset_query_param = ‘offset’                               （offset偏移的查询参数）</li>
<li>max_limit = None                                                    （每页最大显示条数）</li>
</ul>
</li>
<li>使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 写一个类，继承LimitOffsetPagination，重写4个类属性</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonLimitOffsetPagination</span>(<span class="params">LimitOffsetPagination</span>):</span></span><br><span class="line">    default_limit = <span class="number">3</span></span><br><span class="line">    limit_query_param = <span class="string">&#x27;limit&#x27;</span></span><br><span class="line">    offset_query_param = <span class="string">&#x27;offset&#x27;</span></span><br><span class="line">    max_limit = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 2 在视图类中配置写好的分页类</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAPIView</span>(<span class="params">ViewSetMixin, ListAPIView</span>):</span></span><br><span class="line">    queryset = models.Books.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookModelSerializer</span><br><span class="line">    pagination_class = CommonLimitOffsetPagination</span><br></pre></td></tr></table></figure>



<h3 id="CursorPagination游标分页"><a href="#CursorPagination游标分页" class="headerlink" title="CursorPagination游标分页"></a>CursorPagination游标分页</h3><ul>
<li>重要的类属性<ul>
<li>cursor_query_param = ‘cursor’                          （查询条件）</li>
<li>page_size = api_settings.PAGE_SIZE                  （每页显示条数）</li>
<li>ordering = ‘-created’                                             （排序）</li>
<li>page_size_query_param = None                         （更改每页显示条数）</li>
<li>max_page_size = None                                         （每页最大显示条数）</li>
</ul>
</li>
<li>使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1 写一个类，继承LimitOffsetPagination，重写4个类属性</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommonCursorPagination</span>(<span class="params">CursorPagination</span>):</span></span><br><span class="line">    cursor_query_param = <span class="string">&#x27;cursor&#x27;</span></span><br><span class="line">    page_size = <span class="number">2</span></span><br><span class="line">    ordering = <span class="string">&#x27;-id&#x27;</span></span><br><span class="line">    page_size_query_param = <span class="string">&#x27;offset&#x27;</span></span><br><span class="line">    max_page_size = <span class="number">5</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 2 在视图类中配置写好的分页类</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAPIView</span>(<span class="params">ViewSetMixin, ListAPIView</span>):</span></span><br><span class="line">    queryset = models.Books.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = BookModelSerializer</span><br><span class="line">    pagination_class = CommonCursorPagination</span><br></pre></td></tr></table></figure>



<ul>
<li>优缺点</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 优点：速度最快，数据量越大，越有优势(没有那么大的数据量，用的不多)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 缺点：只能前一页和后一页，不能直接跳到某一页</span></span><br></pre></td></tr></table></figure>



<h3 id="继承APIView实现三种分页方式"><a href="#继承APIView实现三种分页方式" class="headerlink" title="继承APIView实现三种分页方式"></a>继承APIView实现三种分页方式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookAPIView2</span>(<span class="params">APIView</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        book_list = models.Books.objects.<span class="built_in">all</span>()</span><br><span class="line">        pagination = CommonPageNumberPagination()</span><br><span class="line">        book_list2 = pagination.paginate_queryset(book_list, request, self)</span><br><span class="line">        ser = BookModelSerializer(instance=book_list2, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> pagination.get_paginated_response(ser.data)</span><br></pre></td></tr></table></figure>



<h2 id="自动生成接口文档-3星"><a href="#自动生成接口文档-3星" class="headerlink" title="自动生成接口文档(3星)"></a>自动生成接口文档(3星)</h2><ul>
<li>coreapi</li>
<li>swagger</li>
</ul>
<h3 id="使用coreapi自动生成"><a href="#使用coreapi自动生成" class="headerlink" title="使用coreapi自动生成"></a>使用coreapi自动生成</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一步：安装coreapi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二步：路由中配置</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.documentation <span class="keyword">import</span> include_docs_urls</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;docs/&#x27;</span>, include_docs_urls(title=<span class="string">&#x27;查询所有&#x27;</span>)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三步：配置文件中配置</span></span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment">## 接口文档配置</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_SCHEMA_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.schemas.coreapi.AutoSchema&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ps：<span class="string">&#x27;DEFAULT_SCHEMA_CLASS&#x27;</span>: <span class="string">&#x27;rest_framework.schemas.openapi.AutoSchema&#x27;</span>,</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 第四步：写接口，加注释</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第五步：访问</span></span><br><span class="line"></span><br><span class="line">ps：extra_kwargs = &#123;</span><br><span class="line">    <span class="string">&#x27;字段&#x27;</span>:&#123;<span class="string">&#x27;help_text&#x27;</span>:<span class="string">&#x27;xxxx&#x27;</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="RBAC-4星"><a href="#RBAC-4星" class="headerlink" title="RBAC(4星)"></a>RBAC(4星)</h2><p><img src="https://i.loli.net/2021/07/13/T3UGjvpaOLZyswX.png" alt="image-20210708172129848.png"></p>
<p><img src="https://img2018.cnblogs.com/blog/1736414/202002/1736414-20200223222136020-817505790.png" alt="img"></p>
<p><strong>RBAC：Role-Based Access Control    (基于角色的访问控制)</strong></p>
<p><strong>原理</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 权限与角色(组)相关联，用户通过称为适当角色(组)的成员而得到这些角色(组)的权限</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 极大的简化了权限的管理(相互依赖)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Django的Auth组件(app)采用的认证规则就是RBAC</span></span><br><span class="line"></span><br><span class="line">	<span class="number">1</span> User表		    		 :存用户信息</span><br><span class="line">    <span class="number">2</span> Permission表			 :存权限</span><br><span class="line">    <span class="number">3</span> Role表					 :存角色(组)</span><br><span class="line"></span><br><span class="line">    <span class="number">4</span> Group_Role中间表			:权限赋予角色(多对多)</span><br><span class="line">	<span class="number">5</span> User_Group中间表			:角色赋予用户(多对多)</span><br><span class="line">    <span class="number">6</span> User_Permission中间表	:权限临时赋予角色(多对多)</span><br><span class="line">        </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ps:</span></span><br><span class="line"><span class="string">	1 Django后台管理admin自带RBAC</span></span><br><span class="line"><span class="string">	2 基于admin做二次开发(simple-ui)</span></span><br><span class="line"><span class="string">	3 基于前后端分离实现RBAC(https://github.com/liqianglog/django-vue-admin)</span></span><br><span class="line"><span class="string">	4 前后端混合的后台前端模板(X-admin---&gt;快速开发后台管理系统)</span></span><br><span class="line"><span class="string">	5 智慧大屏(https://gitee.com/kevin_chou/dataVIS.git)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h2 id="JWT-5星"><a href="#JWT-5星" class="headerlink" title="JWT(5星)"></a>JWT(5星)</h2><h3 id="介绍-5星"><a href="#介绍-5星" class="headerlink" title="介绍(5星)"></a>介绍(5星)</h3><p><strong>Json Web Token（JWT）：一种前后端的认证方式</strong></p>
<p><strong>构成和工作原理</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 三段式：header，payload，signature</span></span><br><span class="line"></span><br><span class="line">header(头)：认证方式，加密方式，公司名字...</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="string">&#x27;typ&#x27;</span>:<span class="string">&#x27;JWT&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;alg&#x27;</span>:<span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">payload(荷载)：用户信息，过期时间，签发时间...</span><br><span class="line">	&#123;</span><br><span class="line">        <span class="string">&quot;userid&quot;</span>:<span class="string">&quot;2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>:<span class="string">&quot;Jerry&quot;</span>,</span><br><span class="line">        <span class="string">&quot;exp&quot;</span>:<span class="number">121456</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">signature(签名)：把前面的头和荷载通过设置好的加密方式得到的串</span><br><span class="line"></span><br><span class="line"><span class="comment"># 签发和校验</span></span><br><span class="line">	</span><br><span class="line">    <span class="number">1</span> 用户登录成功：</span><br><span class="line">    	<span class="number">1.1</span> 构造token的头(固定)</span><br><span class="line">        <span class="number">1.2</span> 构造荷载</span><br><span class="line">        <span class="number">1.3</span> 使用设置好的加密方式对头和荷载加密，得到签名，三者用.拼接起来，生成一个token串(使用base64编码)</span><br><span class="line">        例如：	  eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ</span><br><span class="line">    </span><br><span class="line">    <span class="number">2</span> 用户携带token，来到后端，把头和荷载再使用相同的加密方式加密，得到签名，比较新签名和旧签名是否一致，如果一致，说明该token可以信任，解析出当前用户(荷载)，继续往后走</span><br></pre></td></tr></table></figure>



<h3 id="base64编码"><a href="#base64编码" class="headerlink" title="base64编码"></a>base64编码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">dic=&#123;<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;lqz&#x27;</span>,<span class="string">&#x27;id&#x27;</span>:<span class="number">1</span>&#125;</span><br><span class="line">user_info_str=json.dumps(dic)</span><br><span class="line"><span class="comment"># res=base64.b64encode(bytes(user_info_str,encoding=&#x27;utf-8&#x27;))</span></span><br><span class="line">res=base64.b64encode(user_info_str.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(res) <span class="comment"># eyJuYW1lIjogImxxeiIsICJpZCI6IDF9</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解码</span></span><br><span class="line"></span><br><span class="line">res=base64.b64decode(<span class="string">&#x27;TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ=&#x27;</span>.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="built_in">print</span>(res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">ps：</span></span><br><span class="line"><span class="string">	base64长度是4的倍数，如果不足，需要用=号补齐</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="JWT快速使用-2星"><a href="#JWT快速使用-2星" class="headerlink" title="JWT快速使用(2星)"></a>JWT快速使用(2星)</h3><p><strong>使用第三方：</strong></p>
<ul>
<li>djangorestframework-jwt：好久不维护，还能用</li>
<li>djangorestframework-simplejwt：最新的（<a target="_blank" rel="noopener" href="https://django-rest-framework-simplejwt.readthedocs.io/en/latest/getting_started.html%EF%BC%89">https://django-rest-framework-simplejwt.readthedocs.io/en/latest/getting_started.html）</a></li>
</ul>
<p><strong>签发</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只需要在路由中加入，向这个地址发送post请求，携带用户名密码，就可以签发token</span></span><br><span class="line"></span><br><span class="line">	path(<span class="string">&#x27;login/&#x27;</span>, obtain_jwt_token)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内部使用的是Django自带的auth组件(app)的user表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只需要在前端向配置的地址，发送post请求，携带用户名密码，就可以签发token</span></span><br></pre></td></tr></table></figure>



<p><strong>认证</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在视图类中配置，认证类和权限类(simplejwt只需要认证类)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework_jwt.authentication <span class="keyword">import</span> JSONWebTokenAuthentication</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> IsAuthenticated</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span>(<span class="params">ViewSetMixin,ListAPIView</span>):</span></span><br><span class="line">    authentication_classes = [JSONWebTokenAuthentication,]</span><br><span class="line">    permission_classes = [IsAuthenticated,]</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 前端访问，需要在请求头中加入，如果不携带，或者篡改了，认证就无法通过</span></span><br><span class="line">	key：Authorization</span><br><span class="line">    value：jwt xxx(以空格切割取token)</span><br></pre></td></tr></table></figure>



<h3 id="JWT使用auth表签发token，自定制格式-3星"><a href="#JWT使用auth表签发token，自定制格式-3星" class="headerlink" title="JWT使用auth表签发token，自定制格式(3星)"></a>JWT使用auth表签发token，自定制格式(3星)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只需要写一个函数，在配置文件中配置</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 函数</span></span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">jwt_response_payload_handler</span>(<span class="params">token, user=<span class="literal">None</span>, request=<span class="literal">None</span></span>):</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;code&#x27;</span>:<span class="number">100</span>,</span><br><span class="line">        <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>:user.username,</span><br><span class="line">        <span class="string">&#x27;token&#x27;</span>: token,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 配置文件</span></span><br><span class="line">    </span><br><span class="line">    JWT_AUTH =&#123;</span><br><span class="line">            <span class="comment"># token的过期时间</span></span><br><span class="line">            <span class="string">&#x27;JWT_EXPIRATION_DELTA&#x27;</span>: datetime.timedelta(days=<span class="number">7</span>),</span><br><span class="line">            <span class="comment"># 自定义认证结果：见下方序列化user和自定义response</span></span><br><span class="line">            <span class="comment"># 如果不自定义，返回的格式是固定的，只有token字段</span></span><br><span class="line">            <span class="string">&#x27;JWT_RESPONSE_PAYLOAD_HANDLER&#x27;</span>: <span class="string">&#x27;app01.utils.jwt_response_payload_handler&#x27;</span>,</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>



<h3 id="obtain-jwt-token源码分析-2星"><a href="#obtain-jwt-token源码分析-2星" class="headerlink" title="obtain_jwt_token源码分析(2星)"></a>obtain_jwt_token源码分析(2星)</h3><p><img src="https://i.loli.net/2021/07/13/9rumdEt6PK1I7yA.png" alt="image-20210708200119777.png"></p>
<p><img src="https://i.loli.net/2021/07/13/LPtXQu3bgdAin1B.png" alt="image-20210708201115115.png"></p>
<p><img src="https://i.loli.net/2021/07/13/MzK2IUvlPBpLriO.png" alt="image-20210708202015404.png"></p>
<p><img src="https://i.loli.net/2021/07/13/PiKmHtro35d2WeL.png" alt="image-20210708202554768.png"></p>
<p><img src="https://i.loli.net/2021/07/13/UxjrVGat59z2MXl.png" alt="image-20210708202924385.png"></p>
<p><img src="https://i.loli.net/2021/07/13/4OnkJZKvwDhXGTi.png" alt="image-20210708203058131.png"></p>
<p><img src="https://i.loli.net/2021/07/13/qILVJNO9QZK8n6k.png" alt="image-20210708203535421.png"></p>
<p><img src="https://i.loli.net/2021/07/13/8mqvgdzAQW5a1hK.png" alt="image-20210708204823746.png"></p>
<h3 id="基于jwt的认证类-5星"><a href="#基于jwt的认证类-5星" class="headerlink" title="基于jwt的认证类(5星)"></a>基于jwt的认证类(5星)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">重点逻辑在authenticate方法中：</span></span><br><span class="line"><span class="string">	1 取出客户端传入的token(后端自己规定是从头/路径中拿)</span></span><br><span class="line"><span class="string">	2 验证jwt的签名(使用模块提供的)</span></span><br><span class="line"><span class="string">	3 通过payload得到当前登录用户对象(使用模块提供的)</span></span><br><span class="line"><span class="string">	4 返回user，token</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JWTAuthentication</span>(<span class="params">BaseJSONWebTokenAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(request.META)</span><br><span class="line">        <span class="comment"># token=request.query_params.get(&#x27;HTTP_AUTHORIZATION&#x27;,None)</span></span><br><span class="line">        token=request.META.get(<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>,<span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> token:</span><br><span class="line">            <span class="comment"># 校验token是不是过期了，是不是合法，</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                payload = jwt_decode_handler(token)</span><br><span class="line">            <span class="keyword">except</span> jwt.ExpiredSignature:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token过期&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.DecodeError:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token认证失败&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token不合法&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">           <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token没有携带&#x27;</span>)</span><br><span class="line">        user = self.authenticate_credentials(payload)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (user, token)</span><br><span class="line">        </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">三种方式得到user：</span></span><br><span class="line"><span class="string">	1 继承，直接使用该类的方法</span></span><br><span class="line"><span class="string">	2 把方法copy出来，导入一箩筐</span></span><br><span class="line"><span class="string">	3 完全自己写(copy出来改吧改吧)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="基于自定义User表，签发token-5星"><a href="#基于自定义User表，签发token-5星" class="headerlink" title="基于自定义User表，签发token(5星)"></a>基于自定义User表，签发token(5星)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># urls.py</span></span><br><span class="line"></span><br><span class="line">router=SimpleRouter()</span><br><span class="line">router.register(<span class="string">&#x27;books&#x27;</span>,views.BookView)</span><br><span class="line">router.register(<span class="string">&#x27;user&#x27;</span>,views.UserInfoView,basename=<span class="string">&#x27;user&#x27;</span>)</span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;&#x27;</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfoView</span>(<span class="params">ViewSet</span>):</span></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>],detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self,request</span>):</span></span><br><span class="line">        username=request.data.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password=request.data.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        res=&#123;<span class="string">&#x27;code&#x27;</span>:<span class="string">&#x27;100&#x27;</span>,<span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>&#125;</span><br><span class="line">        user=User.objects.<span class="built_in">filter</span>(username=username,password=password).first()</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="comment"># 登录成功,生成token，提供了（去找）</span></span><br><span class="line">            payload = jwt_payload_handler(user)</span><br><span class="line">            token=jwt_encode_handler(payload)</span><br><span class="line">            res[<span class="string">&#x27;token&#x27;</span>]=token</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            res[<span class="string">&#x27;code&#x27;</span>]=<span class="number">101</span></span><br><span class="line">            res[<span class="string">&#x27;msg&#x27;</span>]=<span class="string">&#x27;用户名或密码错误&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> Response(res)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># until.py(名字随意)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JWTMyUserAuthentication</span>(<span class="params">BaseAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        token=request.META.get(<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>,<span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">if</span> token:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                payload = jwt_decode_handler(token)</span><br><span class="line">                <span class="built_in">print</span>(payload)</span><br><span class="line">            <span class="keyword">except</span> jwt.ExpiredSignature:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token过期&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.DecodeError:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token认证失败&#x27;</span>)</span><br><span class="line">            <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">                <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token不合法&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">           <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;token没有携带&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        user=User.objects.get(pk=payload.get(<span class="string">&#x27;user_id&#x27;</span>))</span><br><span class="line">        <span class="comment"># user=User(id=payload.get(&#x27;user_id&#x27;),username=payload.get(&#x27;username&#x27;))</span></span><br><span class="line">        <span class="comment"># 优化，减少数据库压力（）</span></span><br><span class="line">        <span class="comment"># user=&#123;&#x27;id&#x27;:payload.get(&#x27;user_id&#x27;),&#x27;username&#x27;:payload.get(&#x27;username&#x27;)&#125;</span></span><br><span class="line">        <span class="keyword">return</span> (user, token)</span><br></pre></td></tr></table></figure>



<h3 id="多方式登录-5星"><a href="#多方式登录-5星" class="headerlink" title="多方式登录(5星)"></a>多方式登录(5星)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 使用用户名、邮箱、手机号 + 密码都能登录成功</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> 可以使用auth的User表，也可以自定义用户表</span><br><span class="line"></span><br><span class="line"><span class="number">3</span> 扩写auth的User表(没有迁移之前使用---&gt;继承AbstractUser)</span><br><span class="line">	硬写：</span><br><span class="line">    	<span class="number">3.1</span> 删库(要有备份)</span><br><span class="line">        <span class="number">3.2</span> 删除迁移记录(app的迁移记录，auth、admin的迁移记录(源码中))</span><br><span class="line">        </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="comment"># views.py</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Userinfo</span>(<span class="params">ViewSet</span>):</span></span><br><span class="line"><span class="meta">    @action(<span class="params">methods=[<span class="string">&#x27;POST&#x27;</span>], detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">self, request, *args, **kwargs</span>):</span></span><br><span class="line">        response = &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1000</span>, <span class="string">&#x27;msg&#x27;</span>:<span class="string">&#x27;登录成功&#x27;</span>, <span class="string">&#x27;token&#x27;</span>:<span class="literal">None</span>&#125;</span><br><span class="line">        ser = UserModelSerializer(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> ser.is_valid():</span><br><span class="line">            response[<span class="string">&#x27;token&#x27;</span>] = ser.context.get(<span class="string">&#x27;token&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            response[<span class="string">&#x27;code&#x27;</span>] = <span class="number">1001</span></span><br><span class="line">            response[<span class="string">&#x27;msg&#x27;</span>] = ser.errors</span><br><span class="line">        <span class="keyword">return</span> Response(response)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># serializer.py(名字随意)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserModelSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    username = serializers.CharField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Userinfo</span><br><span class="line">        fields = [<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        user = self._get_user(attrs)</span><br><span class="line">        token = self._get_token(user)</span><br><span class="line">        self.context[<span class="string">&#x27;token&#x27;</span>] = token</span><br><span class="line">        <span class="keyword">return</span> attrs</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_user</span>(<span class="params">self, attrs</span>):</span></span><br><span class="line">        username = attrs.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        password = attrs.get(<span class="string">&#x27;password&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> re.match(<span class="string">&#x27;^1(3[0-9]|4[01456879]|5[0-35-9]|6[2567]|7[0-8]|8[0-9]|9[0-35-9])\d&#123;8&#125;$&#x27;</span>, username):</span><br><span class="line">            user = Userinfo.objects.<span class="built_in">filter</span>(phone=username).first()</span><br><span class="line">        <span class="keyword">elif</span> re.match(<span class="string">&#x27;^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$&#x27;</span>, username):</span><br><span class="line">            user = Userinfo.objects.<span class="built_in">filter</span>(email=username).first()</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            user = Userinfo.objects.<span class="built_in">filter</span>(username=username).first()</span><br><span class="line">        <span class="keyword">if</span> user:</span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">            <span class="keyword">else</span>:<span class="keyword">raise</span> ValidationError(<span class="string">&#x27;用户名或密码错误&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">&#x27;用户名或密码错误&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_get_token</span>(<span class="params">self, user</span>):</span></span><br><span class="line">        payload = jwt_payload_handler(user)</span><br><span class="line">        token = jwt_encode_handler(payload)</span><br><span class="line">        <span class="keyword">return</span> token</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># until.py(名字随意)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User_jwt_authentication</span>(<span class="params">BaseJSONWebTokenAuthentication</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span>(<span class="params">self, request</span>):</span></span><br><span class="line">        <span class="comment"># print(request.META)</span></span><br><span class="line">        token = request.META.get(<span class="string">&#x27;HTTP_AUTHORIZATION&#x27;</span>)</span><br><span class="line">        <span class="comment"># return None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = jwt_decode_handler(token)</span><br><span class="line">        <span class="keyword">except</span> jwt.ExpiredSignature:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;签名过期，请重新登录&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> jwt.DecodeError:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;认证错误&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span> jwt.InvalidTokenError:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;认证不合法&#x27;</span>)</span><br><span class="line">        user = self.authenticate_credentials(payload)</span><br><span class="line">        <span class="keyword">return</span> (user, token)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate_credentials</span>(<span class="params">self, payload</span>):</span></span><br><span class="line">        username = payload.get(<span class="string">&#x27;username&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> username:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;用户名不存在&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = Userinfo.objects.<span class="built_in">filter</span>(username=username).first()</span><br><span class="line">        <span class="keyword">except</span> Userinfo.DoesNotExist:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;无效的签名&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> user.is_active:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">&#x27;用户已注销&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line"></span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/drf/" rel="tag"># drf</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2019/06/12/Center%20OS%207%20%E9%80%9A%E8%BF%87Docker%E9%83%A8%E7%BD%B2yapi/" rel="prev" title="Center OS 7通过Docker部署yapi">
                  <i class="fa fa-chevron-left"></i> Center OS 7通过Docker部署yapi
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2019/07/11/Docker(%E8%AF%A6%E7%BB%86)/" rel="next" title="Docker(详细)">
                  Docker(详细) <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">池劲涛</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
